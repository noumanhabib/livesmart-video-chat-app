var QueryString=function(){for(var e={},o=window.location.search.substring(1).split("&"),t=0;t<o.length;t++){var n=o[t].split("=");if(void 0===e[n[0]])e[n[0]]=n[1];else if("string"==typeof e[n[0]]){var i=[e[n[0]],n[1]];e[n[0]]=i}else e[n[0]].push(n[1])}return e},useragent=(navigator.userAgent||navigator.vendor||window.opera).toLowerCase(),isiPhone=/iPhone|iPad|iPod/i.test(useragent)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1,isAndroid=/android/i.test(useragent),isWindowsPhone=/windows phone/i.test(useragent),isOpera=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,isFirefox="undefined"!=typeof InstallTrigger,isSafariA=(!(queryString=QueryString()).isSafari||"false"!=queryString.isSafari)&&(Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||"[object SafariRemoteNotification]"===(!window.safari||safari.pushNotification).toString()),isChrome=!!window.chrome&&!isOpera,isIEA=(!queryString.isIE||"false"!=queryString.isIE)&&!!document.documentMode,isEdge=(!queryString.isEdge||"false"!=queryString.isEdge)&&navigator.userAgent.indexOf("Edge")>-1;function getChromeVersion(){var e=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);return!!e&&parseInt(e[2],10)}function loadScript(e,o){var t=document.createElement("script");t.type="text/javascript",t.readyState?t.onreadystatechange=function(){"loaded"!=t.readyState&&"complete"!=t.readyState||(t.onreadystatechange=null,o&&o())}:t.onload=function(){o&&o()},t.onerror=function(t){setTimeout(function(){loadScript(e,o)},5e3)},t.src=e+"?v="+currVersion,document.getElementsByTagName("head")[0].appendChild(t)}function stopFullScreenPopup(){document.getElementById("exitFullscreenButton")&&(document.getElementById("exitFullscreenButton").style.display="none"),document.getElementById("fullscreenButton")&&(document.getElementById("fullscreenButton").style.display="block"),window.resizeTo(widgetSize.width+(window.outerWidth-window.innerWidth),widgetSize.height+(window.outerHeight-window.innerHeight)),window.moveTo((screen.width-widgetSize.width)/2,(screen.height-widgetSize.height)/2)}function toggleFullScreen(){document.msFullscreenElement||document.fullscreen||document.mozFullScreen||document.webkitIsFullScreen?stopFullScreen():showFullScreen()}function showFullScreen(){pipVideo.requestFullscreen?pipVideo.requestFullscreen():pipVideo.msRequestFullscreen?pipVideo.msRequestFullscreen():pipVideo.mozRequestFullScreen?pipVideo.mozRequestFullScreen():pipVideo.webkitRequestFullscreen&&pipVideo.webkitRequestFullscreen(),document.getElementById("exitFullscreenButton").style.display="block"}function stopFullScreen(){$("#fullScreen").show(),document.fullscreen&&document.exitFullscreen?document.exitFullscreen():document.fullscreen&&document.msExitFullscreen?document.msExitFullscreen():document.fullscreen&&document.mozCancelFullScreen?document.mozCancelFullScreen():document.fullscreen&&document.webkitCancelFullScreen&&document.webkitCancelFullScreen(),document.getElementById("exitFullscreenButton")&&(document.getElementById("exitFullscreenButton").style.display="none")}function changeToUrl(e){for(var o=e,t=new RegExp(/[-a-zA-Z0-9@:%_\+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&//=]*)?/gi),n=o.split(" "),i=0;i<n.length;i++)n[i].match(t)&&(n[i]='<a target="_blank" href="'+n[i]+'">'+n[i]+"</a>");return n.join(" ")}document.addEventListener("fullscreenchange",function(){document.fullscreen||stopFullScreen()},!1),document.addEventListener("mozfullscreenchange",function(){document.mozFullScreen||stopFullScreen()},!1),document.addEventListener("MSFullscreenChange",function(){document.msFullscreenElement||stopFullScreen()},!1),document.addEventListener("webkitfullscreenchange",function(){document.webkitIsFullScreen||stopFullScreen()},!1);var prevId,prevMsgP,prevBody,estimateDif=function(e){var o=parseInt(e/1e3,10),t=Math.floor(o/3600),n=Math.floor((o-3600*t)/60),i=o-3600*t-60*n;return t||n||i?(t=t?t+(1==t?" hour ":" hours "):"")+(n=n?n+(1==n?" minute ":" minutes "):"")+(i=i?i+(1==i?" second ":" seconds "):""):null},generateLink=function(e){sessionId=Math.random().toString(36).slice(2).substring(0,15);var o={};if(lsRepUrl&&(o.lsRepUrl=lsRepUrl),$("#roomName").val()&&(sessionId=$("#roomName").val()),$("#names").val()&&(o.names=$("#names").val()),agentId&&(o.agentId=agentId),$("#visitorName").val()&&(o.visitorName=$("#visitorName").val()),$("#config").val()&&(o.config=$("#config").val()),$("#shortvisitor").val()?(shortVisitorUrl=$("#shortvisitor").val(),shortVisitorUrl_broadcast=$("#shortvisitor").val()+"_b"):(shortVisitorUrl=Math.random().toString(36).slice(2).substring(0,6),shortVisitorUrl_broadcast=Math.random().toString(36).slice(2).substring(0,6)),$("#shortagent").val()?(shortAgentUrl=$("#shortagent").val(),shortAgentUrl_broadcast=$("#shortagent").val()+"_b"):(shortAgentUrl=Math.random().toString(36).slice(2).substring(0,6),shortAgentUrl_broadcast=Math.random().toString(36).slice(2).substring(0,6)),$("#datetime").val()){var t=new Date($("#datetime").val()).toISOString();o.datetime=t}if($("#duration").val()||$("#durationtext").val()){var n=$("#durationtext").val()?$("#durationtext").val():$("#duration").val();o.duration=n}$("#disableVideo").is(":checked")&&(o.disableVideo=1),$("#disableAudio").is(":checked")&&(o.disableAudio=1),$("#disableScreenShare").is(":checked")&&(o.disableScreenShare=1),$("#disableWhiteboard").is(":checked")&&(o.disableWhiteboard=1),$("#disableTransfer").is(":checked")&&(o.disableTransfer=1),$("#autoAcceptVideo").is(":checked")&&(o.autoAcceptVideo=1),$("#autoAcceptAudio").is(":checked")&&(o.autoAcceptAudio=1);var i="";e&&(i="&broadcast=1");var r=window.btoa(unescape(encodeURIComponent(JSON.stringify(o))));r=r.split("=").join(""),visitorUrl=lsRepUrl+"pages/"+roomLinkPage+"?room="+sessionId+"&p="+r+i,viewerBroadcastLink=lsRepUrl+"pages/"+roomLinkPage+"?room="+sessionId+"&p="+r+i+"&broadcast=1";var s=document.createElement("input");s.setAttribute("value",visitorUrl),document.body.appendChild(s),s.select(),document.execCommand("copy"),document.body.removeChild(s),$("#roomPass").val()&&(o.pass=$("#roomPass").val()),delete o.visitorName,o.isAdmin=1,r=(r=window.btoa(unescape(encodeURIComponent(JSON.stringify(o))))).split("=").join(""),agentUrl=lsRepUrl+"pages/"+roomLinkPage+"?room="+sessionId+"&p="+r+"&isAdmin=1"+i,agentBroadcastUrl=lsRepUrl+"pages/"+roomLinkPage+"?room="+sessionId+"&p="+r+"&isAdmin=1"+i+"&broadcast=1"},getCurrentTime=function(){return convertTimestamp((new Date).getTime(),!0)},guestName=function(e){if(!e)return"Visitor-00";e.charCodeAt(0),e.charCodeAt(e.length-1);for(var o=0,t=0;t<e.length;t++)o+=e.charCodeAt(t);return"Visitor-"+parseInt(o%100+1)},getCurrentDateFormatted=function(){var e=new Date;return e.getDate()+"_"+(e.getMonth()+1)+"_"+e.getFullYear()+"_"+e.getHours()+e.getMinutes()+e.getSeconds()},getPrettyDate=function(e){var o=new Date,t=String(o.getDate()).padStart(2,"0"),n=String(o.getMonth()+1).padStart(2,"0"),i=o.getFullYear(),r=new Date(1e3*e),s=r.getFullYear(),a=("0"+(r.getMonth()+1)).slice(-2),d=("0"+r.getDate()).slice(-2),c=("0"+r.getHours()).slice(-2),l=("0"+r.getMinutes()).slice(-2);if(t==d&&n==a&&i==s)return c+":"+l;var u=svConfigs.videoScreen.dateFormat?svConfigs.videoScreen.dateFormat:"default";return r.format(u)},convertTimestamp=function(e,o){var t=new Date,n=new Date(e),i=(t.getFullYear()!==n.getFullYear()&&n.getFullYear(),("0"+(n.getMonth()+1)).slice(-2),("0"+n.getDate()).slice(-2),n.getHours()),r=n.getMinutes(),s=i>=12?"pm":"am",a=i%12;return a=a||12,r=r<10?"0"+r:r,time=a+":"+r+" "+s,time},compareDates=function(e,o){var t=new Date(e);t.setHours(0,0,0,0);var n=new Date(o);return n.setHours(0,0,0,0),t.getTime()===n.getTime()},escapeHtmlEntities=function(e){return"undefined"!=typeof jQuery?jQuery("<div/>").text(e).html():e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")};function linkify(e){return e.replace(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,function(e){return'<a href="'+e+'" target="_blank">'+e+"</a>"})}var errorTimer,incomingAudio,incomingMessage,enterRoom,showMessage=function(e,o,t,n,i,r){if(o){o=linkify(o);var s=getPrettyDate((new Date).getTime()/1e3);if(t=""!==t&&null!==t&&"undefined"!==t&&void 0!==t?t:""===e?"":s,"conference"==conferenceStyle){if("Me"===e){e=smartVideoLocale.msgStore.me,className="media media-chat media-chat-reverse"}else""===e?className="media media-meta-day":($("#peer_name_chat").text(e),playIncomingMessage(),"undefined"===e&&(e="Guest"),className="p-10 media-chat",i||(i=lsRepUrl+"img/small-avatar.jpg"),f=i,"avatar "+e,svConfigs.transcribe.text_speech_chat&&(speech.text=o,window.speechSynthesis.speak(speech)));if(n=n||"",prevId&&e==prevId)u=prevMsgP,d=prevBody;else{if((u=$("<div />",{class:className})).attr("data-system-attribue",n),e&&"Me"!==e){var a=$("<h6 />",{});a.appendTo(u),a.html(e)}var d=$("<div />",{class:"media-body"});d.appendTo(u)}var c;(c=$("<p />")).html(o),c.appendTo(d),(c=$("<p />",{class:"meta"})).html('<time datetime="2018">'+t+"</time>"),c.appendTo(d),u.appendTo($("#chat-content")),$("#typing").html(""),prevId=e,prevMsgP=u,prevBody=d,(l=document.getElementById("chat-content")).scrollTop=999999}else{var l,u=document.createElement("li"),m="left",g="",f="";if("Me"===e||"Me~"==e.substring(0,3)){m="right";var v="";if("Me~"==e.substring(0,3))if(e=e.substring(3,300),v=" right-image","img/small-avatar.jpg"!==i&&i)f='<img class="direct-chat-img '+m+'" src="'+i+'" alt="" />';else f=(f=e.match(/\b(\w)/g).join("").toUpperCase())?'<span class="acronym-right">'+f+"</span>":'<img class="direct-chat-img '+m+'" src="img/small-avatar.jpg" alt="" />';e=smartVideoLocale.msgStore.me,className="wd-right-bubble"+v}else if(""===e){var p="";"divider"===n&&(p=" divider"),className="wd-system-bubble"+p}else if(playIncomingMessage(),"undefined"===e&&(e="Guest"),g="wd-chat-name","wd-chat-avatar",className="wd-left-bubble",i||(i="/img/small-avatar.jpg"),f='<img class="direct-chat-img '+m+" "+guestName(e)+'" src="'+i+'" alt="" />',"He~"==e.substring(0,3))if(e=e.substring(3,500),"/img/small-avatar.jpg"!==i&&i)f='<img class="direct-chat-img '+m+" "+guestName(e)+'" src="'+i+'" alt="" />';else{f=e.match(/\b(\w)/g).join("").toUpperCase();var h=svg1+f+svg2;image="data:image/svg+xml;base64,"+btoa(h),f=f?'<img class="direct-chat-img '+m+" "+guestName(e)+'" src="'+image+'" alt="" />':'<img class="direct-chat-img '+m+" "+guestName(e)+'" src="/img/small-avatar.jpg" alt="" />'}n=n||"",u.setAttribute("data-system-attribue",n),u.innerHTML='<div class="'+className+'">'+f+'<span class="'+g+'">'+e+'</span><span class="timestamp">'+t+"</span><div>"+o+"</div>",(l=document.getElementById("newdev_chat_ul1")).appendChild(u),l.scrollTop=999999}}},saveChat=function(e,o,t,n,i,r){var s=(new Date).toISOString();$.ajax({type:"POST",timeout:5e3,url:lsRepUrl+"server/script.php",data:{type:"addchat",roomId:roomId||queryString.room,message:e,agent:agentName,agentId:n,from:o,participants:Object.keys(r).toString(),system:t,avatar:i,datetime:s}}).done(function(e){}).fail(function(){console.log(!1)})},saveLog=function(e,o,t,n,i,r){if(n){var s=(new Date).toISOString();if("join"==e||"start"==e)var a="OS: "+jscd.os+" "+jscd.osVersion+"<br/>Browser: "+jscd.browser+" "+jscd.browserMajorVersion+" ("+jscd.browserVersion+")<br/>Mobile: "+jscd.mobile+"<br/>Screen Size: "+jscd.screen;else a="";var d=i||visitorName,c=r||agentName;$.ajax({type:"POST",timeout:5e3,url:lsRepUrl+"server/script.php",data:{type:"addlog",roomId:roomId||queryString.room,message:e,agent:c,attendee:d,agentId:o,datetime:s,session:n,ua:a,constraint:t}}).done(function(e){}).fail(function(){console.log(!1)})}},ERROR_TIMER=1e4,toggleError=function(e,o){jQuery("#error_message").show(),jQuery("#error_message_text").html(e),clearTimeout(errorTimer),errorTimer=setTimeout(function(){jQuery("#error_message").hide(),jQuery("#error_message_text").html("")},o||ERROR_TIMER)},toggleNotification=function(e,o){jQuery("#error_message").toggle(o),jQuery("#error_message_text").html(e)},toggleTimer=function(e){jQuery("#error_message").show(),jQuery("#timer_message_text").html(e)},getCookie=function(e){var o=RegExp(e+"=.[^;]*"),t=document.cookie.match(o);return t?t[0].split("=")[1]:null},deleteCookie=function(e){document.cookie=e+"=; expires=Thu, 01 Jan 1970 00:00:01 GMT;;path=/"},setCookie=function(e,o,t){var n=e,i=o,r=new Date,s=r.getTime()+36e5*parseInt(t);r.setTime(s),document.cookie=t?n+"="+i+";expires="+r.toGMTString()+";path=/":n+"="+i+";path=/"},getGuid=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()};function playIncomingCall(){if(svConfigs.alwaysNotify||!document.hasFocus()){(incomingAudio=new Audio).preload="auto",incomingAudio.autoplay=!0,incomingAudio.loop=!0,incomingAudio.src=lsRepUrl+"/media/ringtone.mp3";var e=incomingAudio.play();isIEA||void 0!==e&&e.then(function(){setTimeout(function(){incomingAudio&&incomingAudio.pause()},1e4)}).catch(function(e){console.log(e)})}}function playIncomingMessage(){if(!svConfigs.transcribe.text_speech_chat&&(svConfigs.alwaysNotify||!document.hasFocus())){(incomingMessage=new Audio).preload="auto",incomingMessage.autoplay=!0,incomingMessage.loop=!1,incomingMessage.src=lsRepUrl+"/media/msgtone.mp3";var e=incomingMessage.play();isIEA||void 0!==e&&e.then(function(){setTimeout(function(){incomingMessage&&incomingMessage.pause()},1e3)}).catch(function(e){console.log(e)})}}function playEnterRoom(){if(svConfigs.alwaysNotify||!document.hasFocus()){(enterRoom=new Audio).preload="auto",enterRoom.autoplay=!0,enterRoom.loop=!1,enterRoom.src=lsRepUrl+"/media/msgtone.mp3",enterRoom.play();var e=enterRoom.play();void 0!==e&&e.then(function(){setTimeout(function(){enterRoom&&enterRoom.pause()},1e3)}).catch(function(e){console.log(e)})}}function stopIncomingCall(){if(isIEA)return incomingAudio&&(incomingAudio.pause(),incomingAudio.src=""),!0;if(incomingAudio){var e=incomingAudio.pause();void 0!==e&&e.then(function(){}).catch(function(e){console.log(e)})}}function bytesToSize(e){if(0===e)return"0 Bytes";var o=parseInt(Math.floor(Math.log(e)/Math.log(1e3)),10);return(e/Math.pow(1e3,o)).toPrecision(3)+" "+["Bytes","KB","MB","GB","TB"][o]}String.prototype.includes||(String.prototype.includes=function(e,o){"use strict";if(e instanceof RegExp)throw TypeError("first argument must not be a RegExp");return void 0===o&&(o=0),-1!==this.indexOf(e,o)});var dateFormat=function(){var e=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,o=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,t=/[^-+\dA-Z]/g,n=function(e,o){for(e=String(e),o=o||2;e.length<o;)e="0"+e;return e};return function(i,r,s,a){var d=dateFormat;if(1!=arguments.length||"[object String]"!=Object.prototype.toString.call(i)||/\d/.test(i)||(r=i,i=void 0),i=i?new Date(i):new Date,isNaN(i))throw SyntaxError("invalid date");"UTC:"==(r=String(d.masks[r]||r||d.masks.default)).slice(0,4)&&(r=r.slice(4),s=!0);var c=s?"getUTC":"get",l=i[c+"Date"](),u=i[c+"Day"](),m=i[c+"Month"](),g=i[c+"FullYear"](),f=i[c+"Hours"](),v=i[c+"Minutes"](),p=i[c+"Seconds"](),h=i[c+"Milliseconds"](),S=s?0:i.getTimezoneOffset(),C={d:l,dd:n(l),ddd:a.dayNames[u],dddd:a.dayNames[u+7],m:m+1,mm:n(m+1),mmm:a.monthNames[m],mmmm:a.monthNames[m+12],yy:String(g).slice(2),yyyy:g,h:f%12||12,hh:n(f%12||12),H:f,HH:n(f),M:v,MM:n(v),s:p,ss:n(p),l:n(h,3),L:n(h>99?Math.round(h/10):h),t:f<12?"a":"p",tt:f<12?"am":"pm",T:f<12?"A":"P",TT:f<12?"AM":"PM",Z:s?"UTC":(String(i).match(o)||[""]).pop().replace(t,""),o:(S>0?"-":"+")+n(100*Math.floor(Math.abs(S)/60)+Math.abs(S)%60,4),S:["th","st","nd","rd"][l%10>3?0:(l%100-l%10!=10)*l%10]};return r.replace(e,function(e){return e in C?C[e]:e.slice(1,e.length-1)})}}();function hark(e,o){var t=window.webkitAudioContext||window.AudioContext,n=this;if(n.events={},n.on=function(e,o){n.events[e]=o},n.emit=function(){n.events[arguments[0]]&&n.events[arguments[0]](arguments[1],arguments[2],arguments[3],arguments[4])},!t)return n;var i=(o=o||{}).smoothing||.1,r=o.interval||50,s=o.threshold,a=o.play,d=o.history||10,c=!0;window.audioContext00||(window.audioContext00=new t);var l,u,m,g=audioContext00.createGain();g.connect(audioContext00.destination),g.gain.value=0,(m=audioContext00.createAnalyser()).fftSize=512,m.smoothingTimeConstant=i,u=new Float32Array(m.fftSize),l=audioContext00.createMediaStreamSource(e),s=s||-50,l.connect(m),a&&m.connect(audioContext00.destination),n.speaking=!1,n.setThreshold=function(e){s=e},n.setInterval=function(e){r=e},n.stop=function(){c=!1,n.emit("volume_change",-100,s),n.speaking&&(n.speaking=!1,n.emit("stopped_speaking"))},n.speakingHistory=[];for(var f=0;f<d;f++)n.speakingHistory.push(0);var v=function(){setTimeout(function(){if(c){var e=function(e,o){var t=-1/0;e.getFloatFrequencyData(o);for(var n=4,i=o.length;n<i;n++)o[n]>t&&o[n]<0&&(t=o[n]);return t}(m,u);n.emit("volume_change",e,s);var o=0;if(e>s&&!n.speaking){for(var t=n.speakingHistory.length-3;t<n.speakingHistory.length;t++)o+=n.speakingHistory[t];o>=2&&(n.speaking=!0,n.emit("speaking"))}else if(e<s&&n.speaking){for(var i=0;i<n.speakingHistory.length;i++)o+=n.speakingHistory[i];0===o&&(n.speaking=!1,n.emit("stopped_speaking"))}n.speakingHistory.shift(),n.speakingHistory.push(0+(e>s)),v()}},r)};return v(),n}dateFormat.masks={default:"dd-mm-yyyy HH:MM",shortDate:"m/d/yy HH:MM",mediumDate:"mmm d, yyyy HH:MM",longDate:"mmmm d, yyyy HH:MM",fullDate:"dddd, mmmm d, yyyy HH:MM",isoDate:"yyyy-mm-dd HH:MM",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"},Date.prototype.format=function(e,o){return i18n={dayNames:[smartVideoLocale.msgStore.Sun,smartVideoLocale.msgStore.Mon,smartVideoLocale.msgStore.Tue,smartVideoLocale.msgStore.Wed,smartVideoLocale.msgStore.Thu,smartVideoLocale.msgStore.Fri,smartVideoLocale.msgStore.Sat,smartVideoLocale.msgStore.Sunday,smartVideoLocale.msgStore.Monday,smartVideoLocale.msgStore.Tuesday,smartVideoLocale.msgStore.Wednesday,smartVideoLocale.msgStore.Thursday,smartVideoLocale.msgStore.Friday,smartVideoLocale.msgStore.Saturday],monthNames:[smartVideoLocale.msgStore.Jan,smartVideoLocale.msgStore.Feb,smartVideoLocale.msgStore.Mar,smartVideoLocale.msgStore.Apr,smartVideoLocale.msgStore.May,smartVideoLocale.msgStore.Jun,smartVideoLocale.msgStore.Jul,smartVideoLocale.msgStore.Aug,smartVideoLocale.msgStore.Sep,smartVideoLocale.msgStore.Oct,smartVideoLocale.msgStore.Nov,smartVideoLocale.msgStore.Dec,smartVideoLocale.msgStore.January,smartVideoLocale.msgStore.February,smartVideoLocale.msgStore.March,smartVideoLocale.msgStore.April,smartVideoLocale.msgStore.May,smartVideoLocale.msgStore.June,smartVideoLocale.msgStore.July,smartVideoLocale.msgStore.August,smartVideoLocale.msgStore.September,smartVideoLocale.msgStore.October,smartVideoLocale.msgStore.November,smartVideoLocale.msgStore.December]},dateFormat(this,e,o,i18n)};var CryptoJS=CryptoJS||function(e,o){var t={},n=t.lib={},i=function(){},r=n.Base={extend:function(e){i.prototype=this;var o=new i;return e&&o.mixIn(e),o.hasOwnProperty("init")||(o.init=function(){o.$super.init.apply(this,arguments)}),o.init.prototype=o,o.$super=this,o},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var o in e)e.hasOwnProperty(o)&&(this[o]=e[o]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},s=n.WordArray=r.extend({init:function(e,o){e=this.words=e||[],this.sigBytes=null!=o?o:4*e.length},toString:function(e){return(e||d).stringify(this)},concat:function(e){var o=this.words,t=e.words,n=this.sigBytes;if(e=e.sigBytes,this.clamp(),n%4)for(var i=0;i<e;i++)o[n+i>>>2]|=(t[i>>>2]>>>24-i%4*8&255)<<24-(n+i)%4*8;else if(65535<t.length)for(i=0;i<e;i+=4)o[n+i>>>2]=t[i>>>2];else o.push.apply(o,t);return this.sigBytes+=e,this},clamp:function(){var o=this.words,t=this.sigBytes;o[t>>>2]&=4294967295<<32-t%4*8,o.length=e.ceil(t/4)},clone:function(){var e=r.clone.call(this);return e.words=this.words.slice(0),e},random:function(o){for(var t=[],n=0;n<o;n+=4)t.push(4294967296*e.random()|0);return new s.init(t,o)}}),a=t.enc={},d=a.Hex={stringify:function(e){var o=e.words;e=e.sigBytes;for(var t=[],n=0;n<e;n++){var i=o[n>>>2]>>>24-n%4*8&255;t.push((i>>>4).toString(16)),t.push((15&i).toString(16))}return t.join("")},parse:function(e){for(var o=e.length,t=[],n=0;n<o;n+=2)t[n>>>3]|=parseInt(e.substr(n,2),16)<<24-n%8*4;return new s.init(t,o/2)}},c=a.Latin1={stringify:function(e){var o=e.words;e=e.sigBytes;for(var t=[],n=0;n<e;n++)t.push(String.fromCharCode(o[n>>>2]>>>24-n%4*8&255));return t.join("")},parse:function(e){for(var o=e.length,t=[],n=0;n<o;n++)t[n>>>2]|=(255&e.charCodeAt(n))<<24-n%4*8;return new s.init(t,o)}},l=a.Utf8={stringify:function(e){try{return decodeURIComponent(escape(c.stringify(e)))}catch(e){throw Error("Malformed UTF-8 data")}},parse:function(e){return c.parse(unescape(encodeURIComponent(e)))}},u=n.BufferedBlockAlgorithm=r.extend({reset:function(){this._data=new s.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=l.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(o){var t=this._data,n=t.words,i=t.sigBytes,r=this.blockSize,a=i/(4*r);if(o=(a=o?e.ceil(a):e.max((0|a)-this._minBufferSize,0))*r,i=e.min(4*o,i),o){for(var d=0;d<o;d+=r)this._doProcessBlock(n,d);d=n.splice(0,o),t.sigBytes-=i}return new s.init(d,i)},clone:function(){var e=r.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});n.Hasher=u.extend({cfg:r.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){u.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(o,t){return new e.init(t).finalize(o)}},_createHmacHelper:function(e){return function(o,t){return new m.HMAC.init(e,t).finalize(o)}}});var m=t.algo={};return t}(Math);!function(){var e=CryptoJS,o=e.lib.WordArray;e.enc.Base64={stringify:function(e){var o=e.words,t=e.sigBytes,n=this._map;e.clamp(),e=[];for(var i=0;i<t;i+=3)for(var r=(o[i>>>2]>>>24-i%4*8&255)<<16|(o[i+1>>>2]>>>24-(i+1)%4*8&255)<<8|o[i+2>>>2]>>>24-(i+2)%4*8&255,s=0;4>s&&i+.75*s<t;s++)e.push(n.charAt(r>>>6*(3-s)&63));if(o=n.charAt(64))for(;e.length%4;)e.push(o);return e.join("")},parse:function(e){var t=e.length,n=this._map;(i=n.charAt(64))&&(-1!=(i=e.indexOf(i))&&(t=i));for(var i=[],r=0,s=0;s<t;s++)if(s%4){var a=n.indexOf(e.charAt(s-1))<<s%4*2,d=n.indexOf(e.charAt(s))>>>6-s%4*2;i[r>>>2]|=(a|d)<<24-r%4*8,r++}return o.create(i,r)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),function(e){function o(e,o,t,n,i,r,s){return((e=e+(o&t|~o&n)+i+s)<<r|e>>>32-r)+o}function t(e,o,t,n,i,r,s){return((e=e+(o&n|t&~n)+i+s)<<r|e>>>32-r)+o}function n(e,o,t,n,i,r,s){return((e=e+(o^t^n)+i+s)<<r|e>>>32-r)+o}function i(e,o,t,n,i,r,s){return((e=e+(t^(o|~n))+i+s)<<r|e>>>32-r)+o}for(var r=CryptoJS,s=(d=r.lib).WordArray,a=d.Hasher,d=r.algo,c=[],l=0;64>l;l++)c[l]=4294967296*e.abs(e.sin(l+1))|0;d=d.MD5=a.extend({_doReset:function(){this._hash=new s.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,r){for(var s=0;16>s;s++){var a=e[d=r+s];e[d]=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8)}s=this._hash.words;var d=e[r+0],l=(a=e[r+1],e[r+2]),u=e[r+3],m=e[r+4],g=e[r+5],f=e[r+6],v=e[r+7],p=e[r+8],h=e[r+9],S=e[r+10],C=e[r+11],w=e[r+12],y=e[r+13],b=e[r+14],I=e[r+15],_=o(_=s[0],A=s[1],E=s[2],k=s[3],d,7,c[0]),k=o(k,_,A,E,a,12,c[1]),E=o(E,k,_,A,l,17,c[2]),A=o(A,E,k,_,u,22,c[3]);_=o(_,A,E,k,m,7,c[4]),k=o(k,_,A,E,g,12,c[5]),E=o(E,k,_,A,f,17,c[6]),A=o(A,E,k,_,v,22,c[7]),_=o(_,A,E,k,p,7,c[8]),k=o(k,_,A,E,h,12,c[9]),E=o(E,k,_,A,S,17,c[10]),A=o(A,E,k,_,C,22,c[11]),_=o(_,A,E,k,w,7,c[12]),k=o(k,_,A,E,y,12,c[13]),E=o(E,k,_,A,b,17,c[14]),_=t(_,A=o(A,E,k,_,I,22,c[15]),E,k,a,5,c[16]),k=t(k,_,A,E,f,9,c[17]),E=t(E,k,_,A,C,14,c[18]),A=t(A,E,k,_,d,20,c[19]),_=t(_,A,E,k,g,5,c[20]),k=t(k,_,A,E,S,9,c[21]),E=t(E,k,_,A,I,14,c[22]),A=t(A,E,k,_,m,20,c[23]),_=t(_,A,E,k,h,5,c[24]),k=t(k,_,A,E,b,9,c[25]),E=t(E,k,_,A,u,14,c[26]),A=t(A,E,k,_,p,20,c[27]),_=t(_,A,E,k,y,5,c[28]),k=t(k,_,A,E,l,9,c[29]),E=t(E,k,_,A,v,14,c[30]),_=n(_,A=t(A,E,k,_,w,20,c[31]),E,k,g,4,c[32]),k=n(k,_,A,E,p,11,c[33]),E=n(E,k,_,A,C,16,c[34]),A=n(A,E,k,_,b,23,c[35]),_=n(_,A,E,k,a,4,c[36]),k=n(k,_,A,E,m,11,c[37]),E=n(E,k,_,A,v,16,c[38]),A=n(A,E,k,_,S,23,c[39]),_=n(_,A,E,k,y,4,c[40]),k=n(k,_,A,E,d,11,c[41]),E=n(E,k,_,A,u,16,c[42]),A=n(A,E,k,_,f,23,c[43]),_=n(_,A,E,k,h,4,c[44]),k=n(k,_,A,E,w,11,c[45]),E=n(E,k,_,A,I,16,c[46]),_=i(_,A=n(A,E,k,_,l,23,c[47]),E,k,d,6,c[48]),k=i(k,_,A,E,v,10,c[49]),E=i(E,k,_,A,b,15,c[50]),A=i(A,E,k,_,g,21,c[51]),_=i(_,A,E,k,w,6,c[52]),k=i(k,_,A,E,u,10,c[53]),E=i(E,k,_,A,S,15,c[54]),A=i(A,E,k,_,a,21,c[55]),_=i(_,A,E,k,p,6,c[56]),k=i(k,_,A,E,I,10,c[57]),E=i(E,k,_,A,f,15,c[58]),A=i(A,E,k,_,y,21,c[59]),_=i(_,A,E,k,m,6,c[60]),k=i(k,_,A,E,C,10,c[61]),E=i(E,k,_,A,l,15,c[62]),A=i(A,E,k,_,h,21,c[63]);s[0]=s[0]+_|0,s[1]=s[1]+A|0,s[2]=s[2]+E|0,s[3]=s[3]+k|0},_doFinalize:function(){var o=this._data,t=o.words,n=8*this._nDataBytes,i=8*o.sigBytes;t[i>>>5]|=128<<24-i%32;var r=e.floor(n/4294967296);for(t[15+(i+64>>>9<<4)]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8),t[14+(i+64>>>9<<4)]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8),o.sigBytes=4*(t.length+1),this._process(),t=(o=this._hash).words,n=0;4>n;n++)i=t[n],t[n]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8);return o},clone:function(){var e=a.clone.call(this);return e._hash=this._hash.clone(),e}}),r.MD5=a._createHelper(d),r.HmacMD5=a._createHmacHelper(d)}(Math),function(){var e,o=CryptoJS,t=(e=o.lib).Base,n=e.WordArray,i=(e=o.algo).EvpKDF=t.extend({cfg:t.extend({keySize:4,hasher:e.MD5,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e)},compute:function(e,o){for(var t=(a=this.cfg).hasher.create(),i=n.create(),r=i.words,s=a.keySize,a=a.iterations;r.length<s;){d&&t.update(d);var d=t.update(e).finalize(o);t.reset();for(var c=1;c<a;c++)d=t.finalize(d),t.reset();i.concat(d)}return i.sigBytes=4*s,i}});o.EvpKDF=function(e,o,t){return i.create(t).compute(e,o)}}(),CryptoJS.lib.Cipher||function(e){var o=(g=CryptoJS).lib,t=o.Base,n=o.WordArray,i=o.BufferedBlockAlgorithm,r=g.enc.Base64,s=g.algo.EvpKDF,a=o.Cipher=i.extend({cfg:t.extend(),createEncryptor:function(e,o){return this.create(this._ENC_XFORM_MODE,e,o)},createDecryptor:function(e,o){return this.create(this._DEC_XFORM_MODE,e,o)},init:function(e,o,t){this.cfg=this.cfg.extend(t),this._xformMode=e,this._key=o,this.reset()},reset:function(){i.reset.call(this),this._doReset()},process:function(e){return this._append(e),this._process()},finalize:function(e){return e&&this._append(e),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(e){return{encrypt:function(o,t,n){return("string"==typeof t?f:m).encrypt(e,o,t,n)},decrypt:function(o,t,n){return("string"==typeof t?f:m).decrypt(e,o,t,n)}}}});o.StreamCipher=a.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var d=g.mode={},c=function(e,o,t){var n=this._iv;n?this._iv=void 0:n=this._prevBlock;for(var i=0;i<t;i++)e[o+i]^=n[i]},l=(o.BlockCipherMode=t.extend({createEncryptor:function(e,o){return this.Encryptor.create(e,o)},createDecryptor:function(e,o){return this.Decryptor.create(e,o)},init:function(e,o){this._cipher=e,this._iv=o}})).extend();l.Encryptor=l.extend({processBlock:function(e,o){var t=this._cipher,n=t.blockSize;c.call(this,e,o,n),t.encryptBlock(e,o),this._prevBlock=e.slice(o,o+n)}}),l.Decryptor=l.extend({processBlock:function(e,o){var t=this._cipher,n=t.blockSize,i=e.slice(o,o+n);t.decryptBlock(e,o),c.call(this,e,o,n),this._prevBlock=i}}),d=d.CBC=l,l=(g.pad={}).Pkcs7={pad:function(e,o){for(var t,i=(t=(t=4*o)-e.sigBytes%t)<<24|t<<16|t<<8|t,r=[],s=0;s<t;s+=4)r.push(i);t=n.create(r,t),e.concat(t)},unpad:function(e){e.sigBytes-=255&e.words[e.sigBytes-1>>>2]}},o.BlockCipher=a.extend({cfg:a.cfg.extend({mode:d,padding:l}),reset:function(){a.reset.call(this);var e=(o=this.cfg).iv,o=o.mode;if(this._xformMode==this._ENC_XFORM_MODE)var t=o.createEncryptor;else t=o.createDecryptor,this._minBufferSize=1;this._mode=t.call(o,this,e&&e.words)},_doProcessBlock:function(e,o){this._mode.processBlock(e,o)},_doFinalize:function(){var e=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){e.pad(this._data,this.blockSize);var o=this._process(!0)}else o=this._process(!0),e.unpad(o);return o},blockSize:4});var u=o.CipherParams=t.extend({init:function(e){this.mixIn(e)},toString:function(e){return(e||this.formatter).stringify(this)}}),m=(d=(g.format={}).OpenSSL={stringify:function(e){var o=e.ciphertext;return((e=e.salt)?n.create([1398893684,1701076831]).concat(e).concat(o):o).toString(r)},parse:function(e){var o=(e=r.parse(e)).words;if(1398893684==o[0]&&1701076831==o[1]){var t=n.create(o.slice(2,4));o.splice(0,4),e.sigBytes-=16}return u.create({ciphertext:e,salt:t})}},o.SerializableCipher=t.extend({cfg:t.extend({format:d}),encrypt:function(e,o,t,n){n=this.cfg.extend(n);var i=e.createEncryptor(t,n);return o=i.finalize(o),i=i.cfg,u.create({ciphertext:o,key:t,iv:i.iv,algorithm:e,mode:i.mode,padding:i.padding,blockSize:e.blockSize,formatter:n.format})},decrypt:function(e,o,t,n){return n=this.cfg.extend(n),o=this._parse(o,n.format),e.createDecryptor(t,n).finalize(o.ciphertext)},_parse:function(e,o){return"string"==typeof e?o.parse(e,this):e}})),g=(g.kdf={}).OpenSSL={execute:function(e,o,t,i){return i||(i=n.random(8)),e=s.create({keySize:o+t}).compute(e,i),t=n.create(e.words.slice(o),4*t),e.sigBytes=4*o,u.create({key:e,iv:t,salt:i})}},f=o.PasswordBasedCipher=m.extend({cfg:m.cfg.extend({kdf:g}),encrypt:function(e,o,t,n){return t=(n=this.cfg.extend(n)).kdf.execute(t,e.keySize,e.ivSize),n.iv=t.iv,(e=m.encrypt.call(this,e,o,t.key,n)).mixIn(t),e},decrypt:function(e,o,t,n){return n=this.cfg.extend(n),o=this._parse(o,n.format),t=n.kdf.execute(t,e.keySize,e.ivSize,o.salt),n.iv=t.iv,m.decrypt.call(this,e,o,t.key,n)}})}(),function(){for(var e=CryptoJS,o=e.lib.BlockCipher,t=e.algo,n=[],i=[],r=[],s=[],a=[],d=[],c=[],l=[],u=[],m=[],g=[],f=0;256>f;f++)g[f]=128>f?f<<1:f<<1^283;var v=0,p=0;for(f=0;256>f;f++){var h=(h=p^p<<1^p<<2^p<<3^p<<4)>>>8^255&h^99;n[v]=h,i[h]=v;var S=g[v],C=g[S],w=g[C],y=257*g[h]^16843008*h;r[v]=y<<24|y>>>8,s[v]=y<<16|y>>>16,a[v]=y<<8|y>>>24,d[v]=y,y=16843009*w^65537*C^257*S^16843008*v,c[h]=y<<24|y>>>8,l[h]=y<<16|y>>>16,u[h]=y<<8|y>>>24,m[h]=y,v?(v=S^g[g[g[w^S]]],p^=g[g[p]]):v=p=1}var b=[0,1,2,4,8,16,32,64,128,27,54];t=t.AES=o.extend({_doReset:function(){for(var e=(t=this._key).words,o=t.sigBytes/4,t=4*((this._nRounds=o+6)+1),i=this._keySchedule=[],r=0;r<t;r++)if(r<o)i[r]=e[r];else{var s=i[r-1];r%o?6<o&&4==r%o&&(s=n[s>>>24]<<24|n[s>>>16&255]<<16|n[s>>>8&255]<<8|n[255&s]):(s=n[(s=s<<8|s>>>24)>>>24]<<24|n[s>>>16&255]<<16|n[s>>>8&255]<<8|n[255&s],s^=b[r/o|0]<<24),i[r]=i[r-o]^s}for(e=this._invKeySchedule=[],o=0;o<t;o++)r=t-o,s=o%4?i[r]:i[r-4],e[o]=4>o||4>=r?s:c[n[s>>>24]]^l[n[s>>>16&255]]^u[n[s>>>8&255]]^m[n[255&s]]},encryptBlock:function(e,o){this._doCryptBlock(e,o,this._keySchedule,r,s,a,d,n)},decryptBlock:function(e,o){var t=e[o+1];e[o+1]=e[o+3],e[o+3]=t,this._doCryptBlock(e,o,this._invKeySchedule,c,l,u,m,i),t=e[o+1],e[o+1]=e[o+3],e[o+3]=t},_doCryptBlock:function(e,o,t,n,i,r,s,a){for(var d=this._nRounds,c=e[o]^t[0],l=e[o+1]^t[1],u=e[o+2]^t[2],m=e[o+3]^t[3],g=4,f=1;f<d;f++){var v=n[c>>>24]^i[l>>>16&255]^r[u>>>8&255]^s[255&m]^t[g++],p=n[l>>>24]^i[u>>>16&255]^r[m>>>8&255]^s[255&c]^t[g++],h=n[u>>>24]^i[m>>>16&255]^r[c>>>8&255]^s[255&l]^t[g++];m=n[m>>>24]^i[c>>>16&255]^r[l>>>8&255]^s[255&u]^t[g++],c=v,l=p,u=h}v=(a[c>>>24]<<24|a[l>>>16&255]<<16|a[u>>>8&255]<<8|a[255&m])^t[g++],p=(a[l>>>24]<<24|a[u>>>16&255]<<16|a[m>>>8&255]<<8|a[255&c])^t[g++],h=(a[u>>>24]<<24|a[m>>>16&255]<<16|a[c>>>8&255]<<8|a[255&l])^t[g++],m=(a[m>>>24]<<24|a[c>>>16&255]<<16|a[l>>>8&255]<<8|a[255&u])^t[g++],e[o]=v,e[o+1]=p,e[o+2]=h,e[o+3]=m},keySize:8});e.AES=o._createHelper(t)}();"use strict";var RTCMultiConnection=function(e,o){var t;function n(e,o){function t(e){return!e.audio&&!e.video&&!e.screen&&e.data}var n="";n+="?userid="+e.userid,n+="&sessionid="+e.sessionid,n+="&msgEvent="+e.socketMessageEvent,n+="&socketCustomEvent="+e.socketCustomEvent,n+="&autoCloseEntireSession="+!!e.autoCloseEntireSession,!0===e.session.broadcast&&(n+="&oneToMany=true"),n+="&maxParticipantsAllowed="+e.maxParticipantsAllowed,e.enableScalableBroadcast&&(n+="&enableScalableBroadcast=true",n+="&maxRelayLimitPerUser="+(e.maxRelayLimitPerUser||2)),n+="&extra="+JSON.stringify(e.extra||{}),e.socketCustomParameters&&(n+=e.socketCustomParameters);try{io.sockets={}}catch(e){}if(e.socketURL||(e.socketURL="/"),"/"!=e.socketURL.substr(e.socketURL.length-1,1))throw'"socketURL" MUST end with a slash.';e.enableLogs&&("/"==e.socketURL?console.info("socket.io url is: ",location.origin+"/"):console.info("socket.io url is: ",e.socketURL));try{e.socket=io(e.socketURL+n)}catch(o){e.socket=io.connect(e.socketURL+n,e.socketOptions)}var i=e.multiPeersHandler;function r(o,t){e.peersBackup[o]||(e.peersBackup[o]={userid:o,extra:{}}),e.peersBackup[o].extra=t}e.socket.on("extra-data-updated",function(o,t){e.peers[o]&&(e.peers[o].extra=t,e.onExtraDataUpdated({userid:o,extra:t}),r(o,t))}),e.socket.on(e.socketMessageEvent,function o(n){if(n.remoteUserId==e.userid)if(e.peers[n.sender]&&e.peers[n.sender].extra!=n.message.extra&&(e.peers[n.sender].extra=n.extra,e.onExtraDataUpdated({userid:n.sender,extra:n.extra}),r(n.sender,n.extra)),n.message.streamSyncNeeded&&e.peers[n.sender]){var s=e.streamEvents[n.message.streamid];if(!s||!s.stream)return;var a=n.message.action;if("ended"===a||"inactive"===a||"stream-removed"===a)return e.peersBackup[s.userid]&&(s.extra=e.peersBackup[s.userid].extra),void e.onstreamended(s);var d="both"!=n.message.type?n.message.type:null;"function"==typeof s.stream[a]&&s.stream[a](d)}else if("dropPeerConnection"!==n.message){if(n.message.allParticipants)return-1===n.message.allParticipants.indexOf(n.sender)&&n.message.allParticipants.push(n.sender),void n.message.allParticipants.forEach(function(o){i[e.peers[o]?"renegotiatePeer":"createNewPeer"](o,{localPeerSdpConstraints:{OfferToReceiveAudio:e.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:e.sdpConstraints.mandatory.OfferToReceiveVideo},remotePeerSdpConstraints:{OfferToReceiveAudio:e.session.oneway?!!e.session.audio:e.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:e.session.oneway?!!e.session.video||!!e.session.screen:e.sdpConstraints.mandatory.OfferToReceiveVideo},isOneWay:!!e.session.oneway||"one-way"===e.direction,isDataOnly:t(e.session)})});if(n.message.newParticipant){if(n.message.newParticipant==e.userid)return;if(e.peers[n.message.newParticipant])return;i.createNewPeer(n.message.newParticipant,n.message.userPreferences||{localPeerSdpConstraints:{OfferToReceiveAudio:e.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:e.sdpConstraints.mandatory.OfferToReceiveVideo},remotePeerSdpConstraints:{OfferToReceiveAudio:e.session.oneway?!!e.session.audio:e.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:e.session.oneway?!!e.session.video||!!e.session.screen:e.sdpConstraints.mandatory.OfferToReceiveVideo},isOneWay:!!e.session.oneway||"one-way"===e.direction,isDataOnly:t(e.session)})}else if(n.message.readyForOffer&&(e.attachStreams.length&&(e.waitingForLocalMedia=!1),e.waitingForLocalMedia))setTimeout(function(){o(n)},1);else if(n.message.newParticipationRequest&&n.sender!==e.userid){e.peers[n.sender]&&e.deletePeer(n.sender);var c={extra:n.extra||{},localPeerSdpConstraints:n.message.remotePeerSdpConstraints||{OfferToReceiveAudio:e.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:e.sdpConstraints.mandatory.OfferToReceiveVideo},remotePeerSdpConstraints:n.message.localPeerSdpConstraints||{OfferToReceiveAudio:e.session.oneway?!!e.session.audio:e.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:e.session.oneway?!!e.session.video||!!e.session.screen:e.sdpConstraints.mandatory.OfferToReceiveVideo},isOneWay:void 0!==n.message.isOneWay?n.message.isOneWay:!!e.session.oneway||"one-way"===e.direction,isDataOnly:void 0!==n.message.isDataOnly?n.message.isDataOnly:t(e.session),dontGetRemoteStream:void 0!==n.message.isOneWay?n.message.isOneWay:!!e.session.oneway||"one-way"===e.direction,dontAttachLocalStream:!!n.message.dontGetRemoteStream,connectionDescription:n,successCallback:function(){}};e.onNewParticipant(n.sender,c)}else{if(n.message.changedUUID&&e.peers[n.message.oldUUID]&&(e.peers[n.message.newUUID]=e.peers[n.message.oldUUID],delete e.peers[n.message.oldUUID]),n.message.userLeft)return i.onUserLeft(n.sender),void(n.message.autoCloseEntireSession&&e.leave());i.addNegotiatedMessage(n.message,n.sender)}}else e.deletePeer(n.sender)});var s=!1;e.socket.resetProps=function(){s=!1},e.socket.on("connect",function(){s||(s=!0,e.enableLogs&&console.info("socket.io connection is opened."),setTimeout(function(){e.socket.emit("extra-data-updated",e.extra)},1e3),o&&o(e.socket))}),e.socket.on("disconnect",function(o){e.onSocketDisconnect(o)}),e.socket.on("error",function(o){e.onSocketError(o)}),e.socket.on("user-disconnected",function(o){o!==e.userid&&(e.onUserStatusChanged({userid:o,status:"offline",extra:e.peers[o]&&e.peers[o].extra||{}}),e.deletePeer(o))}),e.socket.on("user-connected",function(o){o!==e.userid&&e.onUserStatusChanged({userid:o,status:"online",extra:e.peers[o]&&e.peers[o].extra||{}})}),e.socket.on("closed-entire-session",function(o,t){e.leave(),e.onEntireSessionClosed({sessionid:o,userid:o,extra:t})}),e.socket.on("userid-already-taken",function(o,t){e.onUserIdAlreadyTaken(o,t)}),e.socket.on("logs",function(o){e.enableLogs&&console.debug("server-logs",o)}),e.socket.on("number-of-broadcast-viewers-updated",function(o){e.onNumberOfBroadcastViewersUpdated(o)}),e.socket.on("set-isInitiator-true",function(o){o==e.sessionid&&(e.isInitiator=!0)})}function i(e){var o=this,t=["getAllParticipants","getLength","selectFirst","streams","send","forEach"];function n(){e.fbr=new FileBufferReader,e.fbr.onProgress=function(o){e.onFileProgress(o)},e.fbr.onBegin=function(o){e.onFileStart(o)},e.fbr.onEnd=function(o){e.onFileEnd(o)}}e.peers={getLength:function(){var e=0;for(var o in this)-1==t.indexOf(o)&&e++;return e},selectFirst:function(){var e;for(var o in this)-1==t.indexOf(o)&&(e=this[o]);return e},getAllParticipants:function(e){var o=[];for(var n in this)-1==t.indexOf(n)&&n!=e&&o.push(n);return o},forEach:function(o){this.getAllParticipants().forEach(function(t){o(e.peers[t])})},send:function(t,n){var i=this;if(!m(t.size)&&!m(t.type)){if(e.enableFileSharing)return void o.shareFile(t,n);"string"!=typeof t&&(t=JSON.stringify(t))}if("text"===t.type||t instanceof ArrayBuffer||t instanceof DataView){if("text"===t.type&&(t=JSON.stringify(t)),n){var r=e.peers[n];if(r)return r.channels.length?void r.channels.forEach(function(e){e.send(t)}):(e.peers[n].createDataChannel(),e.renegotiate(n),void setTimeout(function(){i.send(t,n)},3e3))}this.getAllParticipants().forEach(function(o){if(!i[o].channels.length)return e.peers[o].createDataChannel(),e.renegotiate(o),void setTimeout(function(){i[o].channels.forEach(function(e){e.send(t)})},3e3);i[o].channels.forEach(function(e){e.send(t)})})}else V.send({text:t,channel:this,connection:e,remoteUserId:n})}},this.uuid=e.userid,this.getLocalConfig=function(t,i,r){return r||(r={}),{streamsToShare:r.streamsToShare||{},rtcMultiConnection:e,connectionDescription:r.connectionDescription,userid:i,localPeerSdpConstraints:r.localPeerSdpConstraints,remotePeerSdpConstraints:r.remotePeerSdpConstraints,dontGetRemoteStream:!!r.dontGetRemoteStream,dontAttachLocalStream:!!r.dontAttachLocalStream,renegotiatingPeer:!!r.renegotiatingPeer,peerRef:r.peerRef,channels:r.channels||[],onLocalSdp:function(e){o.onNegotiationNeeded(e,i)},onLocalCandidate:function(t){(t=E.processCandidates(e,t))&&o.onNegotiationNeeded(t,i)},remoteSdp:t,onDataChannelMessage:function(t){if(!e.fbr&&e.enableFileSharing&&n(),"string"!=typeof t&&e.enableFileSharing){var r=this;t instanceof ArrayBuffer||t instanceof DataView?e.fbr.convertToObject(t,function(e){r.onDataChannelMessage(e)}):t.readyForNextChunk?e.fbr.getNextChunk(t,function(o,t){e.peers[i].channels.forEach(function(e){e.send(o)})},i):t.chunkMissing?e.fbr.chunkMissing(t):e.fbr.addChunk(t,function(o){e.peers[i].peer.channel.send(o)})}else o.onDataChannelMessage(t,i)},onDataChannelError:function(e){o.onDataChannelError(e,i)},onDataChannelOpened:function(e){o.onDataChannelOpened(e,i)},onDataChannelClosed:function(e){o.onDataChannelClosed(e,i)},onRemoteStream:function(t){e.peers[i]&&e.peers[i].streams.push(t),o.onGettingRemoteMedia(t,i)},onRemoteStreamRemoved:function(e){o.onRemovingRemoteMedia(e,i)},onPeerStateChanged:function(e){o.onPeerStateChanged(e),"new"===e.iceConnectionState&&o.onNegotiationStarted(i,e),"connected"===e.iceConnectionState&&o.onNegotiationCompleted(i,e),-1!==e.iceConnectionState.search(/closed|failed/gi)&&(o.onUserLeft(i),o.disconnectWith(i))}}},this.createNewPeer=function(o,t){if(!(e.maxParticipantsAllowed<=e.getAllParticipants().length)){if(t=t||{},e.isInitiator&&e.session.audio&&"two-way"===e.session.audio&&!t.streamsToShare&&(t.isOneWay=!1,t.isDataOnly=!1,t.session=e.session),!t.isOneWay&&!t.isDataOnly)return t.isOneWay=!0,void this.onNegotiationNeeded({enableMedia:!0,userPreferences:t},o);t=e.setUserPreferences(t,o);var n=this.getLocalConfig(null,o,t);e.peers[o]=new _(n)}},this.createAnsweringPeer=function(o,t,n){n=e.setUserPreferences(n||{},t);var i=this.getLocalConfig(o,t,n);e.peers[t]=new _(i)},this.renegotiatePeer=function(o,t,n){if(e.peers[o]){t||(t={}),t.renegotiatingPeer=!0,t.peerRef=e.peers[o].peer,t.channels=e.peers[o].channels;var i=this.getLocalConfig(n,o,t);e.peers[o]=new _(i)}else console.error("Peer ("+o+") does not exist. Renegotiation skipped.")},this.replaceTrack=function(o,t,n){if(!e.peers[t])throw"This peer ("+t+") does not exist.";var i=e.peers[t].peer;i.getSenders&&"function"==typeof i.getSenders&&i.getSenders().length?i.getSenders().forEach(function(i){n&&"video"===i.track.kind&&(e.peers[t].peer.lastVideoTrack=i.track,i.replaceTrack(o)),n||"audio"!==i.track.kind||(e.peers[t].peer.lastAudioTrack=i.track,i.replaceTrack(o))}):(console.warn("RTPSender.replaceTrack is NOT supported."),this.renegotiatePeer(t))},this.onNegotiationNeeded=function(e,o){},this.addNegotiatedMessage=function(t,n){if(t.type&&t.sdp)return"answer"==t.type&&e.peers[n]&&e.peers[n].addRemoteSdp(t),"offer"==t.type&&(t.renegotiatingPeer?this.renegotiatePeer(n,null,t):this.createAnsweringPeer(t,n)),void(e.enableLogs&&console.log("Remote peer's sdp:",t.sdp));if(t.candidate)return e.peers[n]&&e.peers[n].addRemoteCandidate(t),void(e.enableLogs&&console.log("Remote peer's candidate pairs:",t.candidate));if(t.enableMedia){e.session=t.userPreferences.session||e.session,e.session.oneway&&e.attachStreams.length&&(e.attachStreams=[]),t.userPreferences.isDataOnly&&e.attachStreams.length&&(e.attachStreams.length=[]);var i={};e.attachStreams.forEach(function(e){i[e.streamid]={isAudio:!!e.isAudio,isVideo:!!e.isVideo,isScreen:!!e.isScreen}}),t.userPreferences.streamsToShare=i,o.onNegotiationNeeded({readyForOffer:!0,userPreferences:t.userPreferences},n)}t.readyForOffer&&e.onReadyForOffer(n,t.userPreferences)},this.onGettingRemoteMedia=function(e,o){},this.onRemovingRemoteMedia=function(e,o){},this.onGettingLocalMedia=function(e){},this.onLocalMediaError=function(o,t){e.onMediaError(o,t)},this.shareFile=function(o,t){n(),e.fbr.readAsArrayBuffer(o,function(o){var n=e.getAllParticipants();t&&(n=[t]),n.forEach(function(t){e.fbr.getNextChunk(o,function(o){e.peers[t].channels.forEach(function(e){e.send(o)})},t)})},{userid:e.userid,chunkSize:"Firefox"===DetectRTC.browser.name?15e3:e.chunkSize||0})};var i=new x(e);this.onDataChannelMessage=function(o,t){i.receive(JSON.parse(o),t,e.peers[t]?e.peers[t].extra:{})},this.onDataChannelClosed=function(o,t){o.userid=t,o.extra=e.peers[t]?e.peers[t].extra:{},e.onclose(o)},this.onDataChannelError=function(o,t){o.userid=t,event.extra=e.peers[t]?e.peers[t].extra:{},e.onerror(o)},this.onDataChannelOpened=function(o,t){e.peers[t].channels.length?e.peers[t].channels=[o]:(e.peers[t].channels.push(o),e.onopen({userid:t,extra:e.peers[t]?e.peers[t].extra:{},channel:o}))},this.onPeerStateChanged=function(o){e.onPeerStateChanged(o)},this.onNegotiationStarted=function(e,o){},this.onNegotiationCompleted=function(e,o){},this.getRemoteStreams=function(o){return o=o||e.peers.getAllParticipants()[0],e.peers[o]?e.peers[o].streams:[]}}function r(e,o,t){if("undefined"!=typeof CustomEvent){var n=new CustomEvent(o,{arguments:t,__exposedProps__:t});e.dispatchEvent(n)}}function s(e,o){o.stream&&o.stream&&o.stream.addEventListener&&(o.stream.addEventListener("mute",function(t){(t=e.streamEvents[o.streamid]).session={audio:"audio"===t.muteType,video:"video"===t.muteType},e.onmute(t)},!1),o.stream.addEventListener("unmute",function(t){(t=e.streamEvents[o.streamid]).session={audio:"audio"===t.unmuteType,video:"video"===t.unmuteType},e.onunmute(t)},!1))}function a(){if(window.crypto&&window.crypto.getRandomValues&&-1===navigator.userAgent.indexOf("Safari")){for(var e=window.crypto.getRandomValues(new Uint32Array(3)),o="",t=0,n=e.length;t<n;t++)o+=e[t].toString(36);return o}return(Math.random()*(new Date).getTime()).toString(36).replace(/\./g,"")}function d(e,o,t){if(t.autoCreateMediaElement){var n=!1;v(e,"video").length||e.isVideo||e.isScreen||(n=!0),"Firefox"===DetectRTC.browser.name&&(t.session.video||t.session.screen)&&(n=!1);var i=document.createElement(n?"audio":"video");if(i.srcObject=e,i.setAttribute("autoplay",!0),i.setAttribute("playsinline",!0),i.setAttribute("controls",!0),i.setAttribute("muted",!1),i.setAttribute("volume",1),"Firefox"===DetectRTC.browser.name){var r="ended";"oninactive"in i&&(r="inactive"),i.addEventListener(r,function(){if(currentUserMediaRequest.remove(e.idInstance),"local"===e.type){r="ended","oninactive"in e&&(r="inactive"),T.onSyncNeeded(e.streamid,r),t.attachStreams.forEach(function(o,n){e.streamid===o.streamid&&delete t.attachStreams[n]});var o=[];t.attachStreams.forEach(function(e){e&&o.push(e)}),t.attachStreams=o;var n=t.streamEvents[e.streamid];if(n)return void t.onstreamended(n);this.parentNode&&this.parentNode.removeChild(this)}},!1)}var s=i.play();if(void 0!==s){var a=!1;setTimeout(function(){a||(a=!0,o(i))},1e3),s.then(function(){a||(a=!0,o(i))}).catch(function(e){a||(a=!0,o(i))})}else o(i)}else o({})}function c(e,o){window.removeEventListener(e,o),window.addEventListener(e,o,!1)}function l(e){var o=[];return e.forEach(function(e){e&&o.push(e)}),o}function u(e){return!e.audio&&!e.video&&!e.screen&&e.data}function m(e){return void 0===e}(t="undefined"!=typeof global?global:null)&&"undefined"==typeof window&&"undefined"!=typeof global&&(global.navigator={userAgent:"Fake/5.0 (FakeOS) AppleWebKit/123 (KHTML, like Gecko) Fake/12.3.4567.89 Fake/123.45",getUserMedia:function(){}},global.console||(global.console={}),void 0===global.console.debug&&(global.console.debug=global.console.info=global.console.error=global.console.log=global.console.log||function(){console.log(arguments)}),"undefined"==typeof document&&(t.document={},document.createElement=document.captureStream=document.mozCaptureStream=function(){var e={getContext:function(){return e},play:function(){},pause:function(){},drawImage:function(){},toDataURL:function(){return""}};return e},document.addEventListener=document.removeEventListener=t.addEventListener=t.removeEventListener=function(){},t.HTMLVideoElement=t.HTMLMediaElement=function(){}),"undefined"==typeof io&&(t.io=function(){return{on:function(e,o){o=o||function(){},"connect"===e&&o()},emit:function(e,o,t){t=t||function(){},"open-room"!==e&&"join-room"!==e||t(!0,o.sessionid,null)}}}),"undefined"==typeof location&&(t.location={protocol:"file:",href:"",hash:"",origin:"self"}),"undefined"==typeof screen&&(t.screen={width:0,height:0}),"undefined"==typeof URL&&(t.URL={createObjectURL:function(){return""},revokeObjectURL:function(){return""}}),t.window=global),function(){var e="Fake/5.0 (FakeOS) AppleWebKit/123 (KHTML, like Gecko) Fake/12.3.4567.89 Fake/123.45";if(h="object"==typeof process&&"object"==typeof process.versions&&process.versions.node&&!process.browser){var o=process.versions.node.toString().replace("v","");e="Nodejs/"+o+" (NodeOS) AppleWebKit/"+o+" (KHTML, like Gecko) Nodejs/"+o+" Nodejs/"+o}!function(o){"undefined"==typeof window&&("undefined"==typeof window&&"undefined"!=typeof global&&(global.navigator={userAgent:e,getUserMedia:function(){}},o.window=global),"undefined"==typeof location&&(o.location={protocol:"file:",href:"",hash:""}),"undefined"==typeof screen&&(o.screen={width:0,height:0}))}("undefined"!=typeof global?global:window);var t=window.navigator;void 0!==t?(void 0!==t.webkitGetUserMedia&&(t.getUserMedia=t.webkitGetUserMedia),void 0!==t.mozGetUserMedia&&(t.getUserMedia=t.mozGetUserMedia)):t={getUserMedia:function(){},userAgent:e};var n=!!/Android|webOS|iPhone|iPad|iPod|BB10|BlackBerry|IEMobile|Opera Mini|Mobile|mobile/i.test(t.userAgent||""),i=!(-1===t.userAgent.indexOf("Edge")||!t.msSaveOrOpenBlob&&!t.msSaveBlob),r=!!window.opera||t.userAgent.indexOf(" OPR/")>=0,s=void 0!==window.InstallTrigger,a=/^((?!chrome|android).)*safari/i.test(t.userAgent),d=!!window.chrome&&!r,c="undefined"!=typeof document&&!!document.documentMode&&!i;function l(e,o){var t=0,n=!1,i=window.setInterval(function(){e()&&(window.clearInterval(i),o(n)),t++>50&&(window.clearInterval(i),o(n=!0))},10)}var u={Android:function(){return t.userAgent.match(/Android/i)},BlackBerry:function(){return t.userAgent.match(/BlackBerry|BB10/i)},iOS:function(){return t.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return t.userAgent.match(/Opera Mini/i)},Windows:function(){return t.userAgent.match(/IEMobile/i)},any:function(){return u.Android()||u.BlackBerry()||u.iOS()||u.Opera()||u.Windows()},getOsName:function(){var e="Unknown OS";return u.Android()&&(e="Android"),u.BlackBerry()&&(e="BlackBerry"),u.iOS()&&(e="iOS"),u.Opera()&&(e="Opera Mini"),u.Windows()&&(e="Windows"),e}};var m="Unknown OS",g="Unknown OS Version";var f,v,p=function(){for(var e,o=t.appVersion,n=t.userAgent,i="-",r=[{s:"Windows 10",r:/(Windows 10.0|Windows NT 10.0)/},{s:"Windows 8.1",r:/(Windows 8.1|Windows NT 6.3)/},{s:"Windows 8",r:/(Windows 8|Windows NT 6.2)/},{s:"Windows 7",r:/(Windows 7|Windows NT 6.1)/},{s:"Windows Vista",r:/Windows NT 6.0/},{s:"Windows Server 2003",r:/Windows NT 5.2/},{s:"Windows XP",r:/(Windows NT 5.1|Windows XP)/},{s:"Windows 2000",r:/(Windows NT 5.0|Windows 2000)/},{s:"Windows ME",r:/(Win 9x 4.90|Windows ME)/},{s:"Windows 98",r:/(Windows 98|Win98)/},{s:"Windows 95",r:/(Windows 95|Win95|Windows_95)/},{s:"Windows NT 4.0",r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:"Windows CE",r:/Windows CE/},{s:"Windows 3.11",r:/Win16/},{s:"Android",r:/Android/},{s:"Open BSD",r:/OpenBSD/},{s:"Sun OS",r:/SunOS/},{s:"Linux",r:/(Linux|X11)/},{s:"iOS",r:/(iPhone|iPad|iPod)/},{s:"Mac OS X",r:/Mac OS X/},{s:"Mac OS",r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:"QNX",r:/QNX/},{s:"UNIX",r:/UNIX/},{s:"BeOS",r:/BeOS/},{s:"OS/2",r:/OS\/2/},{s:"Search Bot",r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}],s=0;e=r[s];s++)if(e.r.test(n)){i=e.s;break}var a="-";switch(/Windows/.test(i)&&(/Windows (.*)/.test(i)&&(a=/Windows (.*)/.exec(i)[1]),i="Windows"),i){case"Mac OS X":/Mac OS X (10[\.\_\d]+)/.test(n)&&(a=/Mac OS X (10[\.\_\d]+)/.exec(n)[1]);break;case"Android":/Android ([\.\_\d]+)/.test(n)&&(a=/Android ([\.\_\d]+)/.exec(n)[1]);break;case"iOS":/OS (\d+)_(\d+)_?(\d+)?/.test(n)&&(a=(a=/OS (\d+)_(\d+)_?(\d+)?/.exec(o))[1]+"."+a[2]+"."+(0|a[3]))}return{osName:i,osVersion:a}}();p&&p.osName&&"-"!=p.osName?(m=p.osName,g=p.osVersion):u.any()&&"Android"==(m=u.getOsName())&&(g=!!(v=(f=(f||t.userAgent).toLowerCase()).match(/android\s([0-9\.]*)/))&&v[1]);var h="object"==typeof process&&"object"==typeof process.versions&&process.versions.node;"Unknown OS"===m&&h&&(m="Nodejs",g=process.versions.node.toString().replace("v",""));var S=!1,C=!1;["captureStream","mozCaptureStream","webkitCaptureStream"].forEach(function(e){"undefined"!=typeof document&&"function"==typeof document.createElement&&(!S&&e in document.createElement("canvas")&&(S=!0),!C&&e in document.createElement("video")&&(C=!0))});var w=/^(192\.168\.|169\.254\.|10\.|172\.(1[6-9]|2\d|3[01]))/,y=/([0-9]{1,3}(\.[0-9]{1,3}){3})/,b=/[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7}/;var _=[],k=[],E=[],A=[];t.mediaDevices&&t.mediaDevices.enumerateDevices&&(t.enumerateDevices=function(e){var o=t.mediaDevices.enumerateDevices();o&&o.then?t.mediaDevices.enumerateDevices().then(e).catch(function(){e([])}):e([])});var R=!1;void 0!==I&&"getSources"in I?R=!0:t.mediaDevices&&t.mediaDevices.enumerateDevices&&(R=!0);var T=!1,x=!1,V=!1,M=!1,L=!1;function O(e){if(R)if(!t.enumerateDevices&&window.MediaStreamTrack&&window.MediaStreamTrack.getSources&&(t.enumerateDevices=window.MediaStreamTrack.getSources.bind(window.MediaStreamTrack)),!t.enumerateDevices&&t.enumerateDevices&&(t.enumerateDevices=t.enumerateDevices.bind(t)),t.enumerateDevices){_=[],k=[],E=[],A=[],T=!1,x=!1,V=!1,M=!1,L=!1;var o={};t.enumerateDevices(function(t){t.forEach(function(e){var t={};for(var n in e)try{"function"!=typeof e[n]&&(t[n]=e[n])}catch(e){}o[t.deviceId+t.label+t.kind]||("audio"===t.kind&&(t.kind="audioinput"),"video"===t.kind&&(t.kind="videoinput"),t.deviceId||(t.deviceId=t.id),t.id||(t.id=t.deviceId),t.label?("videoinput"!==t.kind||L||(L=!0),"audioinput"!==t.kind||M||(M=!0)):(t.isCustomLabel=!0,"videoinput"===t.kind?t.label="Camera "+(A.length+1):"audioinput"===t.kind?t.label="Microphone "+(k.length+1):"audiooutput"===t.kind?t.label="Speaker "+(E.length+1):t.label="Please invoke getUserMedia once.",void 0!==P&&P.browser.isChrome&&P.browser.version>=46&&!/^(https:|chrome-extension:)$/g.test(location.protocol||"")&&"undefined"!=typeof document&&"string"==typeof document.domain&&document.domain.search&&-1===document.domain.search(/localhost|127.0./g)&&(t.label="HTTPs is required to get label of this "+t.kind+" device.")),"audioinput"===t.kind&&(T=!0,-1===k.indexOf(t)&&k.push(t)),"audiooutput"===t.kind&&(x=!0,-1===E.indexOf(t)&&E.push(t)),"videoinput"===t.kind&&(V=!0,-1===A.indexOf(t)&&A.push(t)),_.push(t),o[t.deviceId+t.label+t.kind]=t)}),void 0!==P&&(P.MediaDevices=_,P.hasMicrophone=T,P.hasSpeakers=x,P.hasWebcam=V,P.isWebsiteHasWebcamPermissions=L,P.isWebsiteHasMicrophonePermissions=M,P.audioInputDevices=k,P.audioOutputDevices=E,P.videoInputDevices=A),e&&e()})}else e&&e();else e&&e()}var P=window.DetectRTC||{};P.browser=function(){t.appVersion;var e,o,n,l=t.userAgent,u=t.appName,m=""+parseFloat(t.appVersion),g=parseInt(t.appVersion,10);if(a&&!d&&-1!==l.indexOf("CriOS")&&(a=!1,d=!0),r){u="Opera";try{g=(m=t.userAgent.split("OPR/")[1].split(" ")[0]).split(".")[0]}catch(e){m="0.0.0.0",g=0}}else c?((o=l.indexOf("rv:"))>0?m=l.substring(o+3):(o=l.indexOf("MSIE"),m=l.substring(o+5)),u="IE"):d?(o=l.indexOf("Chrome"),u="Chrome",m=l.substring(o+7)):a?(o=l.indexOf("Safari"),u="Safari",m=l.substring(o+7),-1!==(o=l.indexOf("Version"))&&(m=l.substring(o+8)),-1!==t.userAgent.indexOf("Version/")&&(m=t.userAgent.split("Version/")[1].split(" ")[0])):s?(o=l.indexOf("Firefox"),u="Firefox",m=l.substring(o+8)):(e=l.lastIndexOf(" ")+1)<(o=l.lastIndexOf("/"))&&(u=l.substring(e,o),m=l.substring(o+1),u.toLowerCase()===u.toUpperCase()&&(u=t.appName));return i&&(u="Edge",m=t.userAgent.split("Edge/")[1]),-1!==(n=m.search(/[; \)]/))&&(m=m.substring(0,n)),g=parseInt(""+m,10),isNaN(g)&&(m=""+parseFloat(t.appVersion),g=parseInt(t.appVersion,10)),{fullVersion:m,version:g,name:u,isPrivateBrowsing:!1}}(),function(e){var o;try{if(window.webkitRequestFileSystem)window.webkitRequestFileSystem(window.TEMPORARY,1,function(){o=!1},function(e){o=!0});else if(window.indexedDB&&/Firefox/.test(window.navigator.userAgent)){var t;try{(t=window.indexedDB.open("test")).onerror=function(){return!0}}catch(e){o=!0}void 0===o&&l(function(){return"done"===t.readyState},function(e){e||(o=!t.result)})}else if(function(e){var o=e.toLowerCase();if(0===o.indexOf("msie")&&0===o.indexOf("trident"))return!1;var t=/(?:msie|rv:)\s?([\d\.]+)/.exec(o);return!!(t&&parseInt(t[1],10)>=10)}(window.navigator.userAgent)){o=!1;try{window.indexedDB||(o=!0)}catch(e){o=!0}}else if(window.localStorage&&/Safari/.test(window.navigator.userAgent)){try{window.localStorage.setItem("test",1)}catch(e){o=!0}void 0===o&&(o=!1,window.localStorage.removeItem("test"))}}catch(e){o=!1}l(function(){return void 0!==o},function(t){e(o)})}(function(e){P.browser.isPrivateBrowsing=!!e}),P.browser["is"+P.browser.name]=!0,P.osName=m,P.osVersion=g;"object"==typeof process&&"object"==typeof process.versions&&process.versions["node-webkit"];var D=!1;["RTCPeerConnection","webkitRTCPeerConnection","mozRTCPeerConnection","RTCIceGatherer"].forEach(function(e){D||e in window&&(D=!0)}),P.isWebRTCSupported=D,P.isORTCSupported="undefined"!=typeof RTCIceGatherer;var B=!1;(P.browser.isChrome&&P.browser.version>=35?B=!0:P.browser.isFirefox&&P.browser.version>=34?B=!0:P.browser.isEdge&&P.browser.version>=17?B=!0:"Android"===P.osName&&P.browser.isChrome&&(B=!0),/^(https:|chrome-extension:)$/g.test(location.protocol||""))||("undefined"!=typeof document&&"string"==typeof document.domain&&document.domain.search&&-1===document.domain.search(/localhost|127.0./g)&&(P.browser.isChrome||P.browser.isEdge||P.browser.isOpera)?B=!1:P.browser.isFirefox&&(B=!1));P.isScreenCapturingSupported=B;var N={isSupported:!1,isCreateMediaStreamSourceSupported:!1};["AudioContext","webkitAudioContext","mozAudioContext","msAudioContext"].forEach(function(e){N.isSupported||e in window&&(N.isSupported=!0,window[e]&&"createMediaStreamSource"in window[e].prototype&&(N.isCreateMediaStreamSourceSupported=!0))}),P.isAudioContextSupported=N.isSupported,P.isCreateMediaStreamSourceSupported=N.isCreateMediaStreamSourceSupported;var U=!1;P.browser.isChrome&&P.browser.version>31&&(U=!0),P.isRtpDataChannelsSupported=U;var j=!1;P.browser.isFirefox&&P.browser.version>28?j=!0:P.browser.isChrome&&P.browser.version>25?j=!0:P.browser.isOpera&&P.browser.version>=11&&(j=!0),P.isSctpDataChannelsSupported=j,P.isMobileDevice=n;var F=!1;t.getUserMedia?F=!0:t.mediaDevices&&t.mediaDevices.getUserMedia&&(F=!0),P.browser.isChrome&&P.browser.version>=46&&!/^(https:|chrome-extension:)$/g.test(location.protocol||"")&&"undefined"!=typeof document&&"string"==typeof document.domain&&document.domain.search&&-1===document.domain.search(/localhost|127.0./g)&&(F="Requires HTTPs"),"Nodejs"===P.osName&&(F=!1),P.isGetUserMediaSupported=F;var q,Q,W,H="";screen.width&&(H+=(screen.width?screen.width:"")+" x "+(screen.height?screen.height:""));P.displayResolution=H,P.displayAspectRatio=(q=screen.width,Q=screen.height,W=function e(o,t){return 0==t?o:e(t,o%t)}(q,Q),q/W/(Q/W)).toFixed(2),P.isCanvasSupportsStreamCapturing=S,P.isVideoSupportsStreamCapturing=C,"Chrome"==P.browser.name&&P.browser.version>=53&&(P.isCanvasSupportsStreamCapturing||(P.isCanvasSupportsStreamCapturing="Requires chrome flag: enable-experimental-web-platform-features"),P.isVideoSupportsStreamCapturing||(P.isVideoSupportsStreamCapturing="Requires chrome flag: enable-experimental-web-platform-features")),P.DetectLocalIPAddress=function(e,o){if(P.isWebRTCSupported){var t=!0,n=!0;!function(e,o){if("undefined"==typeof document||"function"!=typeof document.getElementById)return;var t={},n=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;if(!n){var i=document.getElementById("iframe");if(!i)return;var r=i.contentWindow;n=r.RTCPeerConnection||r.mozRTCPeerConnection||r.webkitRTCPeerConnection}if(!n)return;var s=null;"Chrome"===P.browser&&P.browser.version<58&&(s={optional:[{RtpDataChannels:!0}]});var a=svConfigs.iceServers,d=new n(a,s);o&&(d.addStream?d.addStream(o):d.addTrack&&o.getTracks()[0]&&d.addTrack(o.getTracks()[0],o));function c(o){if(o){var n=y.exec(o);if(n){var i=n[1],r=o.match(w);void 0===t[i]&&e(i,r,!0),t[i]=!0}}else e()}if(d.onicecandidate=function(e){e.candidate&&e.candidate.candidate?c(e.candidate.candidate):c()},!o)try{d.createDataChannel("sctp",{})}catch(e){}P.isPromisesSupported?d.createOffer().then(function(e){d.setLocalDescription(e).then(l)}):d.createOffer(function(e){d.setLocalDescription(e,l,function(){})},function(){});function l(){d.localDescription.sdp.split("\n").forEach(function(e){e&&0===e.indexOf("a=candidate:")&&c(e)})}}(function(o){o?o.match(w)?e("Local: "+o,t=!1,n):o.match(b)?e("Public: "+o,t,n=!1):e("Public: "+o,t,n):e()},o)}},P.isWebSocketsSupported="WebSocket"in window&&2===window.WebSocket.CLOSING,P.isWebSocketsBlocked=!P.isWebSocketsSupported,"Nodejs"===P.osName&&(P.isWebSocketsSupported=!0,P.isWebSocketsBlocked=!1),P.checkWebSocketsSupport=function(e){e=e||function(){};try{var o,t=new WebSocket("wss://echo.websocket.org:443/");t.onopen=function(){P.isWebSocketsBlocked=!1,o=(new Date).getTime(),t.send("ping")},t.onmessage=function(){P.WebsocketLatency=(new Date).getTime()-o+"ms",e(),t.close(),t=null},t.onerror=function(){P.isWebSocketsBlocked=!0,e()}}catch(o){P.isWebSocketsBlocked=!0,e()}},P.load=function(e){O(e=e||function(){})},P.MediaDevices=void 0!==_?_:[],P.hasMicrophone=T,P.hasSpeakers=x,P.hasWebcam=V,P.isWebsiteHasWebcamPermissions=L,P.isWebsiteHasMicrophonePermissions=M,P.audioInputDevices=k,P.audioOutputDevices=E,P.videoInputDevices=A;var z=!1;"undefined"!=typeof document&&"function"==typeof document.createElement&&"setSinkId"in document.createElement("video")&&(z=!0),P.isSetSinkIdSupported=z;var J=!1;P.browser.isFirefox&&"undefined"!=typeof mozRTCPeerConnection?"getSenders"in mozRTCPeerConnection.prototype&&(J=!0):P.browser.isChrome&&"undefined"!=typeof webkitRTCPeerConnection&&"getSenders"in webkitRTCPeerConnection.prototype&&(J=!0),P.isRTPSenderReplaceTracksSupported=J;var G=!1;P.browser.isFirefox&&P.browser.version>38&&(G=!0),P.isRemoteStreamProcessingSupported=G;var Y=!1;void 0!==I&&"applyConstraints"in I.prototype&&(Y=!0),P.isApplyConstraintsSupported=Y;var $=!1;P.browser.isFirefox&&P.browser.version>=43&&($=!0),P.isMultiMonitorScreenCapturingSupported=$,P.isPromisesSupported=!!("Promise"in window),P.version="1.3.9",void 0===P&&(window.DetectRTC={});var K=window.MediaStream;void 0===K&&"undefined"!=typeof webkitMediaStream&&(K=webkitMediaStream),P.MediaStream=void 0!==K&&"function"==typeof K&&Object.keys(K.prototype),P.MediaStreamTrack=void 0!==I&&Object.keys(I.prototype);var X=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;P.RTCPeerConnection=void 0!==X&&Object.keys(X.prototype),window.DetectRTC=P,"undefined"!=typeof module&&(module.exports=P),"function"==typeof define&&define.amd&&define("DetectRTC",[],function(){return P})}(),"undefined"!=typeof cordova&&(DetectRTC.isMobileDevice=!0,DetectRTC.browser.name="Chrome"),navigator&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Crosswalk")&&(DetectRTC.isMobileDevice=!0,DetectRTC.browser.name="Chrome"),window.addEventListener||(window.addEventListener=function(e,o,t){e.attachEvent&&e.attachEvent("on"+o,t)}),window.attachEventListener=function(e,o,t,n){e.addEventListener(o,t,n)};var g=window.MediaStream;function f(e,o){return(!e.session.audio||"two-way"!==e.session.audio)&&("Firefox"===DetectRTC.browser.name&&!1!==o||!("Chrome"!==DetectRTC.browser.name||DetectRTC.browser.version<50)&&(!0===typeof o||!(void 0!==o||!e.session.audio||!e.session.screen||e.session.video)&&(o=!0,!0)))}function v(e,o){return e&&e.getTracks?e.getTracks().filter(function(e){return e.kind===(o||"audio")}):[]}function p(){var e=!1;try{if("undefined"==typeof RTCRtpTransceiver)return!1;if(!("currentDirection"in RTCRtpTransceiver.prototype))return!1;var o=new S;try{o.addTransceiver("audio"),e=!0}catch(e){}o.close()}catch(o){e=!1}return e&&function(){var e=!1;try{var o=new S({sdpSemantics:"unified-plan"});try{var t=o.getConfiguration();e="unified-plan"==t.sdpSemantics||(t.sdpSemantics,!1)}catch(o){e=!1}}catch(o){e=!1}return e}()}function h(){if("undefined"!=typeof cordova&&void 0!==cordova.plugins&&void 0!==cordova.plugins.iosrtc){var e=cordova.plugins.iosrtc;window.webkitRTCPeerConnection=e.RTCPeerConnection,window.RTCSessionDescription=e.RTCSessionDescription,window.RTCIceCandidate=e.RTCIceCandidate,window.MediaStream=e.MediaStream,window.MediaStreamTrack=e.MediaStreamTrack,navigator.getUserMedia=navigator.webkitGetUserMedia=e.getUserMedia,e.debug.enable("iosrtc*"),"function"==typeof e.selectAudioOutput&&e.selectAudioOutput(window.iOSDefaultAudioOutputDevice||"speaker"),e.registerGlobals()}}void 0===g&&"undefined"!=typeof webkitMediaStream&&(g=webkitMediaStream),void 0!==g&&("stop"in g.prototype||(g.prototype.stop=function(){this.getTracks().forEach(function(e){e.stop()})})),window.iOSDefaultAudioOutputDevice=window.iOSDefaultAudioOutputDevice||"speaker",document.addEventListener("deviceready",h,!1),h();var S,C={};function w(e){return{OfferToReceiveAudio:!!e.OfferToReceiveAudio,OfferToReceiveVideo:!!e.OfferToReceiveVideo}}void 0!==window.RTCPeerConnection?S=window.RTCPeerConnection:"undefined"!=typeof mozRTCPeerConnection?S=mozRTCPeerConnection:"undefined"!=typeof webkitRTCPeerConnection&&(S=webkitRTCPeerConnection);var y=window.RTCSessionDescription||window.mozRTCSessionDescription,b=window.RTCIceCandidate||window.mozRTCIceCandidate,I=window.MediaStreamTrack;function _(e){if(void 0!==window.RTCPeerConnection?S=window.RTCPeerConnection:"undefined"!=typeof mozRTCPeerConnection?S=mozRTCPeerConnection:"undefined"!=typeof webkitRTCPeerConnection&&(S=webkitRTCPeerConnection),y=window.RTCSessionDescription||window.mozRTCSessionDescription,b=window.RTCIceCandidate||window.mozRTCIceCandidate,I=window.MediaStreamTrack,!S)throw"WebRTC 1.0 (RTCPeerConnection) API are NOT available in this browser.";var o=e.rtcMultiConnection;this.extra=e.remoteSdp?e.remoteSdp.extra:o.extra,this.userid=e.userid,this.streams=[],this.channels=e.channels||[],this.connectionDescription=e.connectionDescription,this.addStream=function(e){o.addStream(e,t.userid)},this.removeStream=function(e){o.removeStream(e,t.userid)};var t=this;e.remoteSdp&&(this.connectionDescription=e.remoteSdp.connectionDescription);var n,i={};C.sdpConstraints=w({OfferToReceiveAudio:!0,OfferToReceiveVideo:!0});var r=!!e.renegotiatingPeer;e.remoteSdp&&(r=!!e.remoteSdp.renegotiatingPeer);var s=[];if(o.attachStreams.forEach(function(e){e&&s.push(e)}),r)n=e.peerRef;else{var a="all";(o.candidates.turn||o.candidates.relay)&&(o.candidates.stun||o.candidates.reflexive||o.candidates.host||(a="relay"));try{var d={iceServers:o.iceServers,iceTransportPolicy:o.iceTransportPolicy||a};void 0!==o.iceCandidatePoolSize&&(d.iceCandidatePoolSize=o.iceCandidatePoolSize),void 0!==o.bundlePolicy&&(d.bundlePolicy=o.bundlePolicy),void 0!==o.rtcpMuxPolicy&&(d.rtcpMuxPolicy=o.rtcpMuxPolicy),o.sdpSemantics&&(d.sdpSemantics=o.sdpSemantics||"unified-plan"),o.iceServers&&o.iceServers.length||(d=null,o.optionalArgument=null),n=new S(d,o.optionalArgument)}catch(e){try{d={iceServers:o.iceServers};n=new S(d)}catch(e){n=new S}}}!n.getRemoteStreams&&n.getReceivers&&(n.getRemoteStreams=function(){var e=new g;return n.getReceivers().forEach(function(o){e.addTrack(o.track)}),[e]}),!n.getLocalStreams&&n.getSenders&&(n.getLocalStreams=function(){var e=new g;return n.getSenders().forEach(function(o){e.addTrack(o.track)}),[e]}),n.onicecandidate=function(i){if(i.candidate)o.trickleIce&&e.onLocalCandidate({candidate:i.candidate.candidate,sdpMid:i.candidate.sdpMid,sdpMLineIndex:i.candidate.sdpMLineIndex});else if(!o.trickleIce){var r=n.localDescription;e.onLocalSdp({type:r.type,sdp:r.sdp,remotePeerSdpConstraints:e.remotePeerSdpConstraints||!1,renegotiatingPeer:!!e.renegotiatingPeer||!1,connectionDescription:t.connectionDescription,dontGetRemoteStream:!!e.dontGetRemoteStream,extra:o?o.extra:{},streamsToShare:p})}},s.forEach(function(i){e.remoteSdp&&e.remoteSdp.remotePeerSdpConstraints&&e.remoteSdp.remotePeerSdpConstraints.dontGetRemoteStream||e.dontAttachLocalStream||(i=o.beforeAddingStream(i,t))&&(n.getLocalStreams().forEach(function(e){i&&e.id==i.id&&(i=null)}),i&&i.getTracks&&i.getTracks().forEach(function(e){try{n.addTrack(e,i)}catch(e){}}))}),n.oniceconnectionstatechange=n.onsignalingstatechange=function(){var i=t.extra;o.peers[t.userid]&&(i=o.peers[t.userid].extra||i),n&&(e.onPeerStateChanged({iceConnectionState:n.iceConnectionState,iceGatheringState:n.iceGatheringState,signalingState:n.signalingState,extra:i,userid:t.userid}),n&&n.iceConnectionState&&-1!==n.iceConnectionState.search(/closed|failed/gi)&&t.streams instanceof Array&&t.streams.forEach(function(e){var t=o.streamEvents[e.id]||{streamid:e.id,stream:e,type:"remote"};o.onstreamended(t)}))};var c={OfferToReceiveAudio:!!s.length,OfferToReceiveVideo:!!s.length};e.localPeerSdpConstraints&&(c=e.localPeerSdpConstraints),C.sdpConstraints=w(c);var l={};n.ontrack=function(o){if(o&&"track"===o.type)if(o.stream=o.streams[o.streams.length-1],o.stream.id||(o.stream.id=o.track.id),l[o.stream.id]&&"Safari"!==DetectRTC.browser.name)o.track&&(o.track.onended=function(){n&&n.onremovestream(o)});else{l[o.stream.id]=o.stream.id;var t={};e.remoteSdp&&e.remoteSdp.streamsToShare?t=e.remoteSdp.streamsToShare:e.streamsToShare&&(t=e.streamsToShare);var r=t[o.stream.id];r?(o.stream.isAudio=r.isAudio,o.stream.isVideo=r.isVideo,o.stream.isScreen=r.isScreen):(o.stream.isVideo=!!v(o.stream,"video").length,o.stream.isAudio=!o.stream.isVideo,o.stream.isScreen=!1),o.stream.streamid=o.stream.id,i[o.stream.id]=o.stream,e.onRemoteStream(o.stream),o.stream.getTracks().forEach(function(e){e.onended=function(){n&&n.onremovestream(o)}}),o.stream.onremovetrack=function(){n&&n.onremovestream(o)}}},n.onremovestream=function(o){o.stream.streamid=o.stream.id,i[o.stream.id]&&delete i[o.stream.id],e.onRemoteStreamRemoved(o.stream)},"function"!=typeof n.removeStream&&(n.removeStream=function(e){e.getTracks().forEach(function(o){n.removeTrack(o,e)})});var u=!0;this.addRemoteCandidate=function(e){n.addIceCandidate(new b(e)),isEdge&&u&&(u=!1,setTimeout(function(){n.addIceCandidate(null)},3e3))},this.addRemoteSdp=function(e,t){t=t||function(){},"Safari"!==DetectRTC.browser.name&&(e.sdp=o.processSdp(e.sdp)),n.setRemoteDescription(new y(e)).then(t,function(o){console.error("setRemoteDescription failed","\n",o,"\n",e.sdp),t()}).catch(function(o){console.error("setRemoteDescription failed","\n",o,"\n",e.sdp),t()})};var m=!0;function f(o){o.binaryType="arraybuffer",o.onmessage=function(o){e.onDataChannelMessage(o.data)},o.onopen=function(){e.onDataChannelOpened(o)},o.onerror=function(o){e.onDataChannelError(o)},o.onclose=function(o){e.onDataChannelClosed(o)},o.internalSend=o.send,o.send=function(e){"open"===o.readyState&&o.internalSend(e)},n.channel=o}e.remoteSdp&&(m=!1),this.createDataChannel=function(){f(n.createDataChannel("sctp",{}))},!0!==o.session.data||r||(m?this.createDataChannel():n.ondatachannel=function(e){f(e.channel)}),this.enableDisableVideoEncoding=function(e){var o;if(n.getSenders().forEach(function(e){o||"video"!==e.track.kind||(o=e)}),o&&o.getParameters){var t=o.getParameters();t.encodings[1]&&(t.encodings[1].active=!!e),t.encodings[2]&&(t.encodings[2].active=!!e),o.setParameters(t)}},e.remoteSdp&&(e.remoteSdp.remotePeerSdpConstraints&&(c=e.remoteSdp.remotePeerSdpConstraints),C.sdpConstraints=w(c),this.addRemoteSdp(e.remoteSdp,function(){h("createAnswer")})),"two-way"!=o.session.audio&&"two-way"!=o.session.video&&"two-way"!=o.session.screen||(C.sdpConstraints=w({OfferToReceiveAudio:"two-way"==o.session.audio||e.remoteSdp&&e.remoteSdp.remotePeerSdpConstraints&&e.remoteSdp.remotePeerSdpConstraints.OfferToReceiveAudio,OfferToReceiveVideo:"two-way"==o.session.video||"two-way"==o.session.screen||e.remoteSdp&&e.remoteSdp.remotePeerSdpConstraints&&e.remoteSdp.remotePeerSdpConstraints.OfferToReceiveAudio}));var p={};function h(i){n[i](C.sdpConstraints).then(function(i){"Safari"!==DetectRTC.browser.name&&(i.sdp=o.processSdp(i.sdp)),n.setLocalDescription(i).then(function(){o.trickleIce&&(e.onLocalSdp({type:i.type,sdp:i.sdp,remotePeerSdpConstraints:e.remotePeerSdpConstraints||!1,renegotiatingPeer:!!e.renegotiatingPeer||!1,connectionDescription:t.connectionDescription,dontGetRemoteStream:!!e.dontGetRemoteStream,extra:o?o.extra:{},streamsToShare:p}),o.onSettingLocalDescription(t))},function(e){console.error("setLocalDescription error",e)})},function(e){console.error("sdp-error",e)})}n.getLocalStreams().forEach(function(e){p[e.streamid]={isAudio:!!e.isAudio,isVideo:!!e.isVideo,isScreen:!!e.isScreen}}),m&&h("createOffer"),n.nativeClose=n.close,n.close=function(){if(n){try{n.nativeClose!==n.close&&n.nativeClose()}catch(e){}n=null,t.peer=null}},this.peer=n}var k=function(){function e(e,n){var i=t(e);return i.videoCodecNumbers?"vp8"===n&&i.vp8LineNumber===i.videoCodecNumbers[0]?e:"vp9"===n&&i.vp9LineNumber===i.videoCodecNumbers[0]?e:"h264"===n&&i.h264LineNumber===i.videoCodecNumbers[0]?e:e=o(e,n,i):e}function o(e,o,t,n){var i="";if("vp8"===o){if(!t.vp8LineNumber)return e;i=t.vp8LineNumber}if("vp9"===o){if(!t.vp9LineNumber)return e;i=t.vp9LineNumber}if("h264"===o){if(!t.h264LineNumber)return e;i=t.h264LineNumber}var r=t.videoCodecNumbersOriginal.split("SAVPF")[0]+"SAVPF ",s=[i];return n&&(s=[]),t.videoCodecNumbers.forEach(function(e){e!==i&&s.push(e)}),r+=s.join(" "),e=e.replace(t.videoCodecNumbersOriginal,r)}function t(e){var o={};return e.split("\n").forEach(function(e){0===e.indexOf("m=video")&&(o.videoCodecNumbers=[],e.split("SAVPF")[1].split(" ").forEach(function(t){(t=t.trim())&&t.length&&(o.videoCodecNumbers.push(t),o.videoCodecNumbersOriginal=e)})),-1===e.indexOf("VP8/90000")||o.vp8LineNumber||(o.vp8LineNumber=e.replace("a=rtpmap:","").split(" ")[0]),-1===e.indexOf("VP9/90000")||o.vp9LineNumber||(o.vp9LineNumber=e.replace("a=rtpmap:","").split(" ")[0]),-1===e.indexOf("H264/90000")||o.h264LineNumber||(o.h264LineNumber=e.replace("a=rtpmap:","").split(" ")[0])}),o}function n(e,o,t){return function(e,o,t,n,i){for(var r=-1!==t?t:e.length,s=o;s<r;++s)if(0===e[s].indexOf(n)&&(!i||-1!==e[s].toLowerCase().indexOf(i.toLowerCase())))return s;return null}(e,0,-1,o,t)}function i(e){var o=new RegExp("a=rtpmap:(\\d+) \\w+\\/\\d+"),t=e.match(o);return t&&2===t.length?t[1]:null}return{removeVPX:function(e){var n=t(e);return e=o(e,"vp9",n,!0),e=o(e,"vp8",n,!0)},disableNACK:function(e){if(!e||"string"!=typeof e)throw"Invalid arguments.";return e=(e=(e=(e=e.replace("a=rtcp-fb:126 nack\r\n","")).replace("a=rtcp-fb:126 nack pli\r\n","a=rtcp-fb:126 pli\r\n")).replace("a=rtcp-fb:97 nack\r\n","")).replace("a=rtcp-fb:97 nack pli\r\n","a=rtcp-fb:97 pli\r\n")},prioritize:function(e,o){if(o&&o.getSenders&&o.getSenders().length){if(!e||"string"!=typeof e)throw"Invalid arguments.";o.getSenders().forEach(function(o){for(var t=o.getParameters(),n=0;n<t.codecs.length;n++)if(t.codecs[n].mimeType==e){t.codecs.unshift(t.codecs.splice(n,1));break}o.setParameters(t)})}},removeNonG722:function(e){return e.replace(/m=audio ([0-9]+) RTP\/SAVPF ([0-9 ]*)/g,"m=audio $1 RTP/SAVPF 9")},setApplicationSpecificBandwidth:function(e,o,t){return function(e,o,t){return o?void 0!==isFirefox&&isFirefox?e:(t&&(o.screen?o.screen<300&&console.warn("It seems that you are using wrong bandwidth value for screen. Screen sharing is expected to fail."):console.warn("It seems that you are not using bandwidth for screen. Screen sharing is expected to fail.")),o.screen&&t&&(e=(e=e.replace(/b=AS([^\r\n]+\r\n)/g,"")).replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+o.screen+"\r\n")),(o.audio||o.video)&&(e=e.replace(/b=AS([^\r\n]+\r\n)/g,"")),o.audio&&(e=e.replace(/a=mid:audio\r\n/g,"a=mid:audio\r\nb=AS:"+o.audio+"\r\n")),o.screen?e=e.replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+o.screen+"\r\n"):o.video&&(e=e.replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+o.video+"\r\n")),e):e}(e,o,t)},setVideoBitrates:function(e,o){return function(e,o){var t,r=(o=o||{}).min,s=o.max,a=e.split("\r\n"),d=n(a,"a=rtpmap","VP8/90000");if(d&&(t=i(a[d])),!t)return e;var c,l=n(a,"a=rtpmap","rtx/90000");if(l&&(c=i(a[l])),!l)return e;var u=n(a,"a=fmtp:"+c.toString());if(null!==u){var m="\r\n";m+="a=fmtp:"+t+" x-google-min-bitrate="+(r||"228")+"; x-google-max-bitrate="+(s||"228"),a[u]=a[u].concat(m),e=a.join("\r\n")}return e}(e,o)},setOpusAttributes:function(e,o){return function(e,o){o=o||{};var t,r=e.split("\r\n"),s=n(r,"a=rtpmap","opus/48000");if(s&&(t=i(r[s])),!t)return e;var a=n(r,"a=fmtp:"+t.toString());if(null===a)return e;var d="";return d+="; stereo="+(void 0!==o.stereo?o.stereo:"1"),d+="; sprop-stereo="+(void 0!==o["sprop-stereo"]?o["sprop-stereo"]:"1"),void 0!==o.maxaveragebitrate&&(d+="; maxaveragebitrate="+(o.maxaveragebitrate||1048576)),void 0!==o.maxplaybackrate&&(d+="; maxplaybackrate="+(o.maxplaybackrate||1048576)),void 0!==o.cbr&&(d+="; cbr="+(void 0!==o.cbr?o.cbr:"1")),void 0!==o.useinbandfec&&(d+="; useinbandfec="+o.useinbandfec),void 0!==o.usedtx&&(d+="; usedtx="+o.usedtx),void 0!==o.maxptime&&(d+="\r\na=maxptime:"+o.maxptime),r[a]=r[a].concat(d),e=r.join("\r\n")}(e,o)},preferVP9:function(o){return e(o,"vp9")},preferCodec:e,forceStereoAudio:function(e){for(var o=e.split("\r\n"),t=null,n=0;n<o.length;n++)if(-1!==o[n].search("opus/48000")){var i=extractSdp(o[n],/:(\d+) opus\/48000/i);break}for(n=0;n<o.length;n++){if(-1!==o[n].search("a=fmtp"))if(extractSdp(o[n],/a=fmtp:(\d+)/)===i){t=n;break}}return null===t?e:(o[t]=o[t].concat("; stereo=1; sprop-stereo=1"),e=o.join("\r\n"))}}}();window.BandwidthHandler=k;var E={processCandidates:function(e,o){var t=o.candidate,n=e.candidates,i=n.stun,r=n.turn;if(m(n.reflexive)||(i=n.reflexive),m(n.relay)||(r=n.relay),(n.host||!t.match(/typ host/g))&&(r||!t.match(/typ relay/g))&&(i||!t.match(/typ srflx/g))){var s=e.iceProtocols;if((s.udp||!t.match(/ udp /g))&&(s.tcp||!t.match(/ tcp /g)))return e.enableLogs&&console.debug("Your candidate pairs:",t),{candidate:t,sdpMid:o.sdpMid,sdpMLineIndex:o.sdpMLineIndex}}}},A={getIceServers:function(e){var o={stringify:function(e){var o={ct:e.ciphertext.toString(CryptoJS.enc.Base64)};return e.iv&&(o.iv=e.iv.toString()),e.salt&&(o.s=e.salt.toString()),JSON.stringify(o)},parse:function(e){var o=JSON.parse(e),t=CryptoJS.lib.CipherParams.create({ciphertext:CryptoJS.enc.Base64.parse(o.ct)});return o.iv&&(t.iv=CryptoJS.enc.Hex.parse(o.iv)),o.s&&(t.salt=CryptoJS.enc.Hex.parse(o.s)),t}};if(svConfigs.iceServers.requirePass){for(var t=svConfigs.iceServers.iceServers,n=0;n<t.length;n++){if(t[n].username){var i='{"ct":"'+t[n].username+'","iv":"09644439296d0d45c81236b5643e9662","s":"3132333435363738"}',r=JSON.parse(CryptoJS.AES.decrypt(i,svConfigs.iceServers.passPhrase,{format:o}).toString(CryptoJS.enc.Utf8));t[n].username=r}if(t[n].credential){i='{"ct":"'+t[n].credential+'","iv":"09644439296d0d45c81236b5643e9662","s":"3132333435363738"}';var s=JSON.parse(CryptoJS.AES.decrypt(i,svConfigs.iceServers.passPhrase,{format:o}).toString(CryptoJS.enc.Utf8));t[n].credential=s}}svConfigs.iceServers.iceServers=t,svConfigs.iceServers.requirePass=!1}return"r.html"===window.location.pathname.split("/").pop()&&(i='{"ct":"'+svConfigs.iceServers.turnon+'","iv":"09644439296d0d45c81236b5643e9662","s":"3132333435363738"}',CryptoJS.AES.decrypt(i,"aeNbaecqgc",{format:o}).toString(CryptoJS.enc.Utf8)||(svConfigs.iceServers.iceServers=!1)),svConfigs.iceServers.iceServers}};function R(e){if(!0!==currentUserMediaRequest.mutex){currentUserMediaRequest.mutex=!0;var o=JSON.stringify(e.localMediaConstraints);if(currentUserMediaRequest.streams[o])r(currentUserMediaRequest.streams[o].stream,!0);else{if(!!/BB10|BlackBerry/i.test(navigator.userAgent||"")||void 0===navigator.mediaDevices||"function"!=typeof navigator.mediaDevices.getUserMedia)return navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,void navigator.getUserMedia(e.localMediaConstraints,function(e){e.streamid=e.streamid||e.id||a(),e.idInstance=o,r(e)},function(o){e.onLocalMediaError(o,e.localMediaConstraints)});if(void 0===navigator.mediaDevices){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;var t,n,i=function(){};navigator.mediaDevices={getUserMedia:function(e){return navigator.getUserMedia(e,function(e){e(stream),t=stream},function(e){i(e),n=e}),{then:function(e){if(!t)return e,{then:function(e){n?e(n):i=e}};e(t)}}}}}if(!0===e.localMediaConstraints.isScreen){if(navigator.mediaDevices.getDisplayMedia)navigator.mediaDevices.getDisplayMedia(e.localMediaConstraints).then(function(e){e.streamid=e.streamid||e.id||a(),e.idInstance=o,r(e)}).catch(function(o){e.onLocalMediaError(o,e.localMediaConstraints)});else{if(!navigator.getDisplayMedia)throw new Error("getDisplayMedia API is not availabe in this browser.");navigator.getDisplayMedia(e.localMediaConstraints).then(function(e){e.streamid=e.streamid||e.id||a(),e.idInstance=o,r(e)}).catch(function(o){e.onLocalMediaError(o,e.localMediaConstraints)})}return}navigator.mediaDevices.getUserMedia(e.localMediaConstraints).then(function(e){e.streamid=e.streamid||e.id||a(),e.idInstance=o,r(e)}).catch(function(o){e.onLocalMediaError(o,e.localMediaConstraints)})}}else currentUserMediaRequest.queueRequests.push(e);function r(t,n){!function(e,o){e.mandatory&&e.mandatory.chromeMediaSource?o.isScreen=!0:e.mozMediaSource||e.mediaSource?o.isScreen=!0:e.video?o.isVideo=!0:e.audio&&(o.isAudio=!0)}(e.localMediaConstraints,t);var i="ended";"oninactive"in t&&(i="inactive"),t.addEventListener(i,function(){delete currentUserMediaRequest.streams[o],currentUserMediaRequest.mutex=!1,currentUserMediaRequest.queueRequests.indexOf(e)&&(delete currentUserMediaRequest.queueRequests[currentUserMediaRequest.queueRequests.indexOf(e)],currentUserMediaRequest.queueRequests=l(currentUserMediaRequest.queueRequests))},!1),currentUserMediaRequest.streams[o]={stream:t},currentUserMediaRequest.mutex=!1,currentUserMediaRequest.queueRequests.length&&R(currentUserMediaRequest.queueRequests.shift()),e.onGettingLocalMedia(t,n)}}window.currentUserMediaRequest={streams:[],mutex:!1,queueRequests:[],remove:function(e){this.mutex=!1;var o=this.streams[e];if(o){var t=(o=o.stream).currentUserMediaRequestOptions;this.queueRequests.indexOf(t)&&(delete this.queueRequests[this.queueRequests.indexOf(t)],this.queueRequests=l(this.queueRequests)),this.streams[e].stream=null,delete this.streams[e]}}};var T=function(){function e(e){if(e)return"string"==typeof e||void 0===e?e:e.audio&&e.video?null:e.audio?"audio":e.video?"video":void 0}return{setHandlers:function(o,t,n){if(o&&o.addEventListener){if(void 0===t||1==t){var i="ended";"oninactive"in o&&(i="inactive"),o.addEventListener(i,function(){T.onSyncNeeded(this.streamid,i)},!1)}o.mute=function(i,s){i=e(i),void 0!==s&&(t=s),void 0!==i&&"audio"!=i||v(o,"audio").forEach(function(e){e.enabled=!1,n.streamEvents[o.streamid].isAudioMuted=!0}),void 0!==i&&"video"!=i||v(o,"video").forEach(function(e){e.enabled=!1}),void 0!==t&&1!=t||T.onSyncNeeded(o.streamid,"mute",i),n.streamEvents[o.streamid].muteType=i||"both",r(o,"mute",i)},o.unmute=function(i,s){i=e(i),void 0!==s&&(t=s),function(){if(!n.streamEvents[o.streamid].mediaElement)return;var e=n.streamEvents[o.streamid].mediaElement;e.volume=0,function e(o,t,n,i){i=(i||0)+1;if(i>=t)return;setTimeout(function(){n(),e(o,t,n,i)},o)}(200,5,function(){try{e.volume+=.2}catch(o){e.volume=1}})}(),void 0!==i&&"audio"!=i||v(o,"audio").forEach(function(e){e.enabled=!0,n.streamEvents[o.streamid].isAudioMuted=!1}),void 0!==i&&"video"!=i||(v(o,"video").forEach(function(e){e.enabled=!0}),void 0!==i&&"video"==i&&n.streamEvents[o.streamid].isAudioMuted&&function e(t){t||(t=0),++t<100&&n.streamEvents[o.streamid].isAudioMuted&&(o.mute("audio"),setTimeout(function(){e(t)},50))}()),void 0!==t&&1!=t||T.onSyncNeeded(o.streamid,"unmute",i),n.streamEvents[o.streamid].unmuteType=i||"both",r(o,"unmute",i)}}},onSyncNeeded:function(e,o,t){}}}();function x(e){var o={};return{receive:function(t,n,i){var r=t.uuid;if(o[r]||(o[r]=[]),o[r].push(t.message),t.last){var s=o[r].join("");t.isobject&&(s=JSON.parse(s));var a={data:s,userid:n,extra:i,latency:(new Date).getTime()-t.sendingTime};e.autoTranslateText?(a.original=a.data,e.Translator.TranslateText(a.data,function(o){a.data=o,e.onmessage(a)})):e.onmessage(a),delete o[r]}}}}var V={send:function(e){var o=e.connection,t=e.channel,n=e.remoteUserId,i=e.text,r=o.chunkSize||1e3,s="",d=!1;"string"!=typeof i&&(d=!0,i=JSON.stringify(i));var c=a(),l=(new Date).getTime();!function e(i,a){var u={type:"text",uuid:c,sendingTime:l};i&&(a=i,u.packets=parseInt(a.length/r));a.length>r?u.message=a.slice(0,r):(u.message=a,u.last=!0,u.isobject=d);t.send(u,n);s=a.slice(u.message.length);s.length&&setTimeout(function(){e(null,s)},o.chunkInterval||100)}(i)}},M={handle:function(e){var o={};e.onFileStart=function(t){var n=document.createElement("div");if(n.title=t.name,n.innerHTML="<label>0%</label> <progress></progress>",t.remoteUserId&&(n.innerHTML+=" (Sharing with:"+t.remoteUserId+")"),e.filesContainer||(e.filesContainer=document.body||document.documentElement),e.filesContainer.insertBefore(n,e.filesContainer.firstChild),!t.remoteUserId)return o[t.uuid]={div:n,progress:n.querySelector("progress"),label:n.querySelector("label")},void(o[t.uuid].progress.max=t.maxChunks);o[t.uuid]||(o[t.uuid]={}),o[t.uuid][t.remoteUserId]={div:n,progress:n.querySelector("progress"),label:n.querySelector("label")},o[t.uuid][t.remoteUserId].progress.max=t.maxChunks},e.onFileProgress=function(e){var t=o[e.uuid];t&&(e.remoteUserId&&!(t=o[e.uuid][e.remoteUserId])||(t.progress.value=e.currentPosition||e.maxChunks||t.progress.max,function(e,o){if(-1!==e.position){var t=+e.position.toFixed(2).split(".")[1]||100;o.innerHTML=t+"%"}}(t.progress,t.label)))},e.onFileEnd=function(e){var t=o[e.uuid];if(t){if(!e.remoteUserId||(t=o[e.uuid][e.remoteUserId])){var n=t.div;-1!=e.type.indexOf("image")?n.innerHTML='<a href="'+e.url+'" download="'+e.name+'">Download <strong style="color:red;">'+e.name+'</strong> </a><br /><img src="'+e.url+'" title="'+e.name+'" style="max-width: 80%;">':n.innerHTML='<a href="'+e.url+'" download="'+e.name+'">Download <strong style="color:red;">'+e.name+'</strong> </a><br /><iframe src="'+e.url+'" title="'+e.name+'" style="width: 80%;border: 0;height: inherit;margin-top:1em;"></iframe>'}}else console.error("No such progress-helper element exist.",e)}}},L={handle:function(e){e.autoTranslateText=!1,e.language="en",e.googKey="AIzaSyCgB5hmFY74WYB-EoWkhr9cAGr6TiTHrEE",e.Translator={TranslateText:function(o,t){var n=document.createElement("script");n.type="text/javascript";var i=encodeURIComponent(o),r="method"+e.token();window[r]=function(e){e.data&&e.data.translations[0]&&t?t(e.data.translations[0].translatedText):e.error&&"Daily Limit Exceeded"===e.error.message?console.error('Text translation failed. Error message: "Daily Limit Exceeded."'):e.error?console.error(e.error.message):console.error(e)};var s="https://www.googleapis.com/language/translate/v2?key="+e.googKey+"&target="+(e.language||"en-US")+"&callback=window."+r+"&q="+i;n.src=s,document.getElementsByTagName("head")[0].appendChild(n)},getListOfLanguages:function(o){var t=new XMLHttpRequest;t.onreadystatechange=function(){if(t.readyState==XMLHttpRequest.DONE){var e=JSON.parse(t.responseText);if(e&&e.data&&e.data.languages)return void o(e.data.languages);if(e.error&&"Daily Limit Exceeded"===e.error.message)return void console.error('Text translation failed. Error message: "Daily Limit Exceeded."');if(e.error)return void console.error(e.error.message);console.error(e)}};var n="https://www.googleapis.com/language/translate/v2/languages?key="+e.googKey+"&target=en";t.open("GET",n,!0),t.send(null)}}}};!function(t){o=o||{useDefaultDevices:!0},t.channel=t.sessionid=(e||location.href.replace(/\/|:|#|\?|\$|\^|%|\.|`|~|!|\+|@|\[|\||]|\|*. /g,"").split("\n").join("").split("\r").join(""))+"";var r=new i(t),l={};function m(e){if(t.socketAutoReConnect=!0,t.socket)e&&e(t.socket);else{if(void 0===n)if("undefined"!=typeof FirebaseConnection)window.SocketConnection=FirebaseConnection;else{if("undefined"==typeof PubNubConnection)throw"SocketConnection.js seems missed.";window.SocketConnection=PubNubConnection}new n(t,function(o){e&&e(t.socket)})}}function h(e,o){t.socket.emit("join-room",{sessionid:t.sessionid,session:t.session,mediaConstraints:t.mediaConstraints,sdpConstraints:t.sdpConstraints,streams:w(),extra:t.extra,password:void 0!==t.password&&"object"!=typeof t.password?t.password:""},function(n,i){if(!0===n){if(t.enableLogs&&console.log("isRoomJoined: ",n," roomid: ",t.sessionid),t.peers[t.sessionid])return;r.onNegotiationNeeded(e)}!1===n&&t.enableLogs&&console.warn("isRoomJoined: ",i," roomid: ",t.sessionid),o(n,t.sessionid,i)})}function C(e){t.enableLogs&&console.log("Sending open-room signal to socket.io"),t.waitingForLocalMedia=!1,t.socket.emit("open-room",{sessionid:t.sessionid,session:t.session,mediaConstraints:t.mediaConstraints,sdpConstraints:t.sdpConstraints,streams:w(),extra:t.extra,identifier:t.publicRoomIdentifier,password:void 0!==t.password&&"object"!=typeof t.password?t.password:""},function(o,n){!0===o&&(t.enableLogs&&console.log("isRoomOpened: ",o," roomid: ",t.sessionid),e(o,t.sessionid)),!1===o&&(t.enableLogs&&console.warn("isRoomOpened: ",n," roomid: ",t.sessionid),e(o,t.sessionid,n))})}function w(){try{return t.streamEvents.selectAll("local").map(function(e){return{streamid:e.streamid,tracks:e.stream.getTracks().length}})}catch(e){return[]}}function y(e,o){if(t.dontCaptureUserMedia||e.isDataOnly)o();else{var n={};e.localPeerSdpConstraints.OfferToReceiveAudio&&(n.audio=t.mediaConstraints.audio),e.localPeerSdpConstraints.OfferToReceiveVideo&&(n.video=t.mediaConstraints.video);var i=e.session||t.session;i.oneway&&"two-way"!==i.audio&&"two-way"!==i.video&&"two-way"!==i.screen?o():(i.oneway&&i.audio&&"two-way"===i.audio&&(i={audio:!0}),(i.audio||i.video||i.screen)&&(i.screen?"Edge"===DetectRTC.browser.name?navigator.getDisplayMedia({video:!0,audio:f(t)}).then(function(e){e.isScreen=!0,r.onGettingLocalMedia(e),!i.audio&&!i.video||f(t)?o(e):t.invokeGetUserMedia(null,o)},function(e){console.error("Unable to capture screen on Edge. HTTPs and version 17+ is required.")}):t.invokeGetUserMedia({audio:f(t),video:!0,isScreen:!0},!i.audio&&!i.video||f(t)?o:t.invokeGetUserMedia(null,o)):(i.audio||i.video)&&t.invokeGetUserMedia(null,o,i)))}}function b(e,o){e?(o.audio&&v(e,"audio").forEach(function(e){e.applyConstraints(o.audio)}),o.video&&v(e,"video").forEach(function(e){e.applyConstraints(o.video)})):t.enableLogs&&console.error("No stream to applyConstraints.")}function _(e,o,n){o?r.replaceTrack(e,o,n):t.peers.getAllParticipants().forEach(function(o){r.replaceTrack(e,o,n)})}r.onGettingLocalMedia=function(e,o){if(o=o||function(){},l[e.streamid])o();else{l[e.streamid]=!0;try{e.type="local"}catch(e){}t.setStreamEndHandler(e),d(e,function(n){n.id=e.streamid,n.muted=!0,n.volume=0,-1===t.attachStreams.indexOf(e)&&t.attachStreams.push(e),void 0!==T&&T.setHandlers(e,!0,t),t.streamEvents[e.streamid]={stream:e,type:"local",mediaElement:n,userid:t.userid,extra:t.extra,streamid:e.streamid,isAudioMuted:!0};try{!function(e,o){if(o.stream&&v(o.stream,"audio").length){if(!e||!o)throw"Both arguments are required.";if(e.onspeaking&&e.onsilence){if(void 0===hark)throw"hark.js not found.";hark(o.stream,{onspeaking:function(){e.onspeaking(o)},onsilence:function(){e.onsilence(o)},onvolumechange:function(t,n){e.onvolumechange&&e.onvolumechange(merge({volume:t,threshold:n},o))}})}}}(t,t.streamEvents[e.streamid]),s(t,t.streamEvents[e.streamid]),t.onstream(t.streamEvents[e.streamid])}catch(e){}o()},t)}},r.onGettingRemoteMedia=function(e,o){try{e.type="remote"}catch(e){}t.setStreamEndHandler(e,"remote-stream"),d(e,function(n){n.id=e.streamid,void 0!==T&&T.setHandlers(e,!1,t),t.streamEvents[e.streamid]={stream:e,type:"remote",userid:o,extra:t.peers[o]?t.peers[o].extra:{},mediaElement:n,streamid:e.streamid},s(t,t.streamEvents[e.streamid]),t.onstream(t.streamEvents[e.streamid])},t)},r.onRemovingRemoteMedia=function(e,o){var n=t.streamEvents[e.streamid];n||(n={stream:e,type:"remote",userid:o,extra:t.peers[o]?t.peers[o].extra:{},streamid:e.streamid,mediaElement:t.streamEvents[e.streamid]?t.streamEvents[e.streamid].mediaElement:null}),t.peersBackup[n.userid]&&(n.extra=t.peersBackup[n.userid].extra),t.onstreamended(n),delete t.streamEvents[e.streamid]},r.onNegotiationNeeded=function(e,o,n){n=n||function(){};var i={remoteUserId:o=o||e.remoteUserId,message:e=e||"",sender:t.userid};e.remoteUserId&&e.message&&e.sender&&(i=e),m(function(){t.socket.emit(t.socketMessageEvent,i,n)})},r.onUserLeft=function(e){t.deletePeer(e)},r.disconnectWith=function(e,o){t.socket&&t.socket.emit("disconnect-with",e,o||function(){}),t.deletePeer(e)},t.socketOptions={transport:"polling"},t.openOrJoin=function(e,o){o=o||function(){},t.checkPresence(e,function(e,n){if(e){t.sessionid=n;var i,r,s=!!t.session.oneway,a=u(t.session);r={OfferToReceiveAudio:t.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:t.sdpConstraints.mandatory.OfferToReceiveVideo},i={OfferToReceiveAudio:s?!!t.session.audio:t.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:s?!!t.session.video||!!t.session.screen:t.sdpConstraints.mandatory.OfferToReceiveVideo};var d={remoteUserId:t.sessionid,message:{newParticipationRequest:!0,isOneWay:s,isDataOnly:a,localPeerSdpConstraints:i,remotePeerSdpConstraints:r},sender:t.userid};y(d.message,function(){h(d,o)})}else t.waitingForLocalMedia=!0,t.isInitiator=!0,t.sessionid=n||t.sessionid,u(t.session)?C(o):t.captureUserMedia(function(){C(o)})})},t.waitingForLocalMedia=!1,t.open=function(e,o){o=o||function(){},t.waitingForLocalMedia=!0,t.isInitiator=!0,t.sessionid=e||t.sessionid,m(function(){u(t.session)?C(o):t.captureUserMedia(function(){C(o)})})},t.peersBackup={},t.deletePeer=function(e){if(e&&t.peers[e]){var o={userid:e,extra:t.peers[e]?t.peers[e].extra:{}};if(t.peersBackup[o.userid]&&(o.extra=t.peersBackup[o.userid].extra),t.onleave(o),t.peers[e]){t.peers[e].streams.forEach(function(e){e.stop()});var n=t.peers[e].peer;if(n&&"closed"!==n.iceConnectionState)try{n.close()}catch(e){}t.peers[e]&&(t.peers[e].peer=null,delete t.peers[e])}}},t.rejoin=function(e){if(!t.isInitiator&&e&&Object.keys(e).length){var o={};t.peers[e.remoteUserId]&&(o=t.peers[e.remoteUserId].extra,t.deletePeer(e.remoteUserId)),e&&e.remoteUserId&&(t.join(e.remoteUserId),t.onReConnecting({userid:e.remoteUserId,extra:o}))}},t.join=function(e,o){t.sessionid=!!e&&(e.sessionid||e.remoteUserId||e)||t.sessionid,t.sessionid+="";var n=!1,i=!1,r=!1,s=!1;if(e&&e.session||!e||"string"==typeof e){var a=e&&e.session||t.session;r=!!a.oneway,s=u(a),i={OfferToReceiveAudio:t.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:t.sdpConstraints.mandatory.OfferToReceiveVideo},n={OfferToReceiveAudio:r?!!t.session.audio:t.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:r?!!t.session.video||!!t.session.screen:t.sdpConstraints.mandatory.OfferToReceiveVideo}}var d=function(){};"function"==typeof(o=o||{})&&(d=o,o={}),void 0!==o.localPeerSdpConstraints&&(n=o.localPeerSdpConstraints),void 0!==o.remotePeerSdpConstraints&&(i=o.remotePeerSdpConstraints),void 0!==o.isOneWay&&(r=o.isOneWay),void 0!==o.isDataOnly&&(s=o.isDataOnly);var c={remoteUserId:t.sessionid,message:{newParticipationRequest:!0,isOneWay:r,isDataOnly:s,localPeerSdpConstraints:n,remotePeerSdpConstraints:i},sender:t.userid};return y(c.message,function(){m(function(){h(c,d)})}),c},t.publicRoomIdentifier="",t.getUserMedia=t.captureUserMedia=function(e,o){e=e||function(){};var n=o||t.session;t.dontCaptureUserMedia||u(n)?e():(n.audio||n.video||n.screen)&&(n.screen?"Edge"===DetectRTC.browser.name?navigator.getDisplayMedia({video:!0,audio:f(t)}).then(function(i){if(i.isScreen=!0,r.onGettingLocalMedia(i),!n.audio&&!n.video||f(t))e(i);else{var s={};for(var a in n)"screen"!==a&&(s[a]=n[a]);t.invokeGetUserMedia(o,e,s)}},function(e){console.error("Unable to capture screen on Edge. HTTPs and version 17+ is required.")}):t.invokeGetUserMedia({audio:f(t),video:!0,isScreen:!0},function(i){if(!n.audio&&!n.video||f(t))e(i);else{var r={};for(var s in n)"screen"!==s&&(r[s]=n[s]);t.invokeGetUserMedia(o,e,r)}}):(n.audio||n.video)&&t.invokeGetUserMedia(o,e,n))},t.onbeforeunload=function(e,o){t.closeBeforeUnload&&(t.peers.getAllParticipants().forEach(function(e){r.onNegotiationNeeded({userLeft:!0},e),t.peers[e]&&t.peers[e].peer&&t.peers[e].peer.close(),delete t.peers[e]}),o||t.closeSocket(),t.isInitiator=!1)},window.ignoreBeforeUnload?t.closeBeforeUnload=!1:(t.closeBeforeUnload=!0,window.addEventListener("beforeunload",t.onbeforeunload,!1)),t.userid=a(),t.changeUserId=function(e,o){o=o||function(){},t.userid=e||a(),t.socket.emit("changed-uuid",t.userid,o)},t.extra={},t.attachStreams=[],t.session={audio:!0,video:!0},t.enableFileSharing=!1,t.bandwidth={screen:!1,audio:!1,video:!1},t.codecs={audio:"opus",video:"VP9"},t.processSdp=function(e){return p()?e:"Safari"===DetectRTC.browser.name?e:("VP8"===t.codecs.video.toUpperCase()&&(e=k.preferCodec(e,"vp8")),"VP9"===t.codecs.video.toUpperCase()&&(e=k.preferCodec(e,"vp9")),"H264"===t.codecs.video.toUpperCase()&&(e=k.preferCodec(e,"h264")),"G722"===t.codecs.audio&&(e=k.removeNonG722(e)),"Firefox"===DetectRTC.browser.name?e:((t.bandwidth.video||t.bandwidth.screen)&&(e=k.setApplicationSpecificBandwidth(e,t.bandwidth,!!t.session.screen)),t.bandwidth.video&&(e=k.setVideoBitrates(e,{min:8*t.bandwidth.video*1024,max:8*t.bandwidth.video*1024})),t.bandwidth.audio&&(e=k.setOpusAttributes(e,{maxaveragebitrate:8*t.bandwidth.audio*1024,maxplaybackrate:8*t.bandwidth.audio*1024,stereo:1,maxptime:3})),e))},void 0!==k&&(t.BandwidthHandler=t.CodecsHandler=k),t.mediaConstraints={audio:{mandatory:{},optional:t.bandwidth.audio?[{bandwidth:8*t.bandwidth.audio*1024||1048576}]:[]},video:{mandatory:{},optional:t.bandwidth.video?[{bandwidth:8*t.bandwidth.video*1024||1048576},{facingMode:"user"}]:[{facingMode:"user"}]}},"Firefox"===DetectRTC.browser.name&&(t.mediaConstraints={audio:!0,video:!0}),o.useDefaultDevices||DetectRTC.isMobileDevice||DetectRTC.load(function(){var e,o;if(DetectRTC.MediaDevices.forEach(function(n){"audioinput"===n.kind&&!1!==t.mediaConstraints.audio&&(e=n),"videoinput"===n.kind&&!1!==t.mediaConstraints.video&&(o=n)}),e){if("Firefox"===DetectRTC.browser.name)return void(!0!==t.mediaConstraints.audio?t.mediaConstraints.audio.deviceId=e.id:t.mediaConstraints.audio={deviceId:e.id});1==t.mediaConstraints.audio&&(t.mediaConstraints.audio={mandatory:{},optional:[]}),t.mediaConstraints.audio.optional||(t.mediaConstraints.audio.optional=[]);var n=[{sourceId:e.id}];t.mediaConstraints.audio.optional=n.concat(t.mediaConstraints.audio.optional)}if(o){if("Firefox"===DetectRTC.browser.name)return void(!0!==t.mediaConstraints.video?t.mediaConstraints.video.deviceId=o.id:t.mediaConstraints.video={deviceId:o.id});1==t.mediaConstraints.video&&(t.mediaConstraints.video={mandatory:{},optional:[]}),t.mediaConstraints.video.optional||(t.mediaConstraints.video.optional=[]);n=[{sourceId:o.id}];t.mediaConstraints.video.optional=n.concat(t.mediaConstraints.video.optional)}}),t.sdpConstraints={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0},optional:[{VoiceActivityDetection:!1}]},t.sdpSemantics=null,t.iceCandidatePoolSize=null,t.bundlePolicy=null,t.rtcpMuxPolicy=null,t.iceTransportPolicy=null,t.optionalArgument={optional:[{DtlsSrtpKeyAgreement:!0},{googImprovedWifiBwe:!0},{googScreencastMinBitrate:300},{googIPv6:!0},{googDscp:!0},{googCpuUnderuseThreshold:55},{googCpuOveruseThreshold:85},{googSuspendBelowMinBitrate:!0},{googCpuOveruseDetection:!0}],mandatory:{}},t.iceServers=A.getIceServers(t),t.candidates={host:!0,stun:!0,turn:!0},t.iceProtocols={tcp:!0,udp:!0},t.onopen=function(e){t.enableLogs&&console.info("Data connection has been opened between you & ",e.userid)},t.onclose=function(e){t.enableLogs&&console.warn("Data connection has been closed between you & ",e.userid)},t.onerror=function(e){t.enableLogs&&console.error(e.userid,"data-error",e)},t.onmessage=function(e){t.enableLogs&&console.debug("data-message",e.userid,e.data)},t.send=function(e,o){t.peers.send(e,o)},t.close=t.disconnect=t.leave=function(){t.onbeforeunload(!1,!0)},t.closeEntireSession=function(e){e=e||function(){},t.socket.emit("close-entire-session",function o(){t.getAllParticipants().length?setTimeout(o,100):(t.onEntireSessionClosed({sessionid:t.sessionid,userid:t.userid,extra:t.extra}),t.changeUserId(null,function(){t.close(),e()}))})},t.onEntireSessionClosed=function(e){t.enableLogs&&console.info("Entire session is closed: ",e.sessionid,e.extra)},t.onstream=function(e){var o=t.videosContainer;o.insertBefore(e.mediaElement,o.firstChild);var n=e.mediaElement.play();void 0===n?setTimeout(function(){e.mediaElement.play()},2e3):n.catch(function(){}).then(function(){setTimeout(function(){e.mediaElement.play()},2e3)})},t.onstreamended=function(e){e.mediaElement||(e.mediaElement=document.getElementById(e.streamid)),e.mediaElement&&e.mediaElement.parentNode&&e.mediaElement.parentNode.removeChild(e.mediaElement)},t.direction="many-to-many",t.removeStream=function(e,o){var n;t.attachStreams.forEach(function(o){o.id===e&&(n=o)}),n?(t.peers.getAllParticipants().forEach(function(e){if(!o||e===o){var i=t.peers[e];try{i.peer.removeStream(n)}catch(e){}}}),t.renegotiate()):console.warn("No such stream exist.",e)},t.addStream=function(e,o){if(e.getTracks)return-1===t.attachStreams.indexOf(e)&&(e.streamid||(e.streamid=e.id),t.attachStreams.push(e)),void t.renegotiate(o);function n(n){e.streamCallback&&e.streamCallback(n),t.renegotiate(o)}u(e)?t.renegotiate(o):(e.audio||e.video||e.screen)&&(e.screen?"Edge"===DetectRTC.browser.name?navigator.getDisplayMedia({video:!0,audio:f(t)}).then(function(o){o.isScreen=!0,r.onGettingLocalMedia(o),!e.audio&&!e.video||f(t)?n(o):t.invokeGetUserMedia(null,function(e){n(e)})},function(e){console.error("Unable to capture screen on Edge. HTTPs and version 17+ is required.")}):t.invokeGetUserMedia({audio:f(t),video:!0,isScreen:!0},function(o){!e.audio&&!e.video||f(t)?n(o):t.invokeGetUserMedia(null,function(e){n(e)})}):(e.audio||e.video)&&t.invokeGetUserMedia(null,n))},t.invokeGetUserMedia=function(e,o,n){n||(n=t.session),e||(e=t.mediaConstraints),R({onGettingLocalMedia:function(t){var n=e.video;n&&(n.mediaSource||n.mozMediaSource?t.isScreen=!0:n.mandatory&&n.mandatory.chromeMediaSource&&(t.isScreen=!0)),t.isScreen||(t.isVideo=!!v(t,"video").length,t.isAudio=!t.isVideo&&v(t,"audio").length),r.onGettingLocalMedia(t,function(){"function"==typeof o&&o(t)})},onLocalMediaError:function(e,o){r.onLocalMediaError(e,o)},localMediaConstraints:e||{audio:!!n.audio&&e.audio,video:!!n.video&&e.video}})},t.applyConstraints=function(e,o){if(I&&I.prototype.applyConstraints){var n;if(o)return t.streamEvents[o]&&(n=t.streamEvents[o].stream),void b(n,e);t.attachStreams.forEach(function(o){b(o,e)})}else alert("track.applyConstraints is NOT supported in your browser.")},t.replaceTrack=function(e,o,n){if(e=e||{},S.prototype.getSenders)if(e instanceof I)_(e,o,n);else{if(e instanceof g)return v(e,"video").length&&_(v(e,"video")[0],o,!0),void(v(e,"audio").length&&_(v(e,"audio")[0],o,!1));if(u(e))throw"connection.replaceTrack requires audio and/or video and/or screen.";(e.audio||e.video||e.screen)&&(e.screen?"Edge"===DetectRTC.browser.name?navigator.getDisplayMedia({video:!0,audio:f(t)}).then(function(o){o.isScreen=!0,r.onGettingLocalMedia(o),!e.audio&&!e.video||f(t)?i(o):t.invokeGetUserMedia(null,i)},function(e){console.error("Unable to capture screen on Edge. HTTPs and version 17+ is required.")}):t.invokeGetUserMedia({audio:f(t),video:!0,isScreen:!0},!e.audio&&!e.video||f(t)?i:t.invokeGetUserMedia(null,i)):(e.audio||e.video)&&t.invokeGetUserMedia(null,i))}else t.addStream(e);function i(i){t.replaceTrack(i,o,n||e.video||e.screen)}},t.resetTrack=function(e,o){e||(e=t.getAllParticipants()),"string"==typeof e&&(e=[e]),e.forEach(function(e){var n=t.peers[e].peer;void 0!==o&&!0!==o||!n.lastVideoTrack||t.replaceTrack(n.lastVideoTrack,e,!0),void 0!==o&&!1!==o||!n.lastAudioTrack||t.replaceTrack(n.lastAudioTrack,e,!1)})},t.renegotiate=function(e){e?r.renegotiatePeer(e):t.peers.getAllParticipants().forEach(function(e){r.renegotiatePeer(e)})},t.setStreamEndHandler=function(e,o){if(e&&e.addEventListener&&(o=!!o,!e.alreadySetEndHandler)){e.alreadySetEndHandler=!0;var n="ended";"oninactive"in e&&(n="inactive"),e.addEventListener(n,function(){if(e.idInstance&&currentUserMediaRequest.remove(e.idInstance),!o){var n=[];t.attachStreams.forEach(function(o){o.id!=e.id&&n.push(o)}),t.attachStreams=n}var i=t.streamEvents[e.streamid];if(i||(i={stream:e,streamid:e.streamid,type:o?"remote":"local",userid:t.userid,extra:t.extra,mediaElement:t.streamEvents[e.streamid]?t.streamEvents[e.streamid].mediaElement:null}),o&&t.peers[i.userid]){var r=t.peers[i.userid].peer;n=[];r.getRemoteStreams().forEach(function(o){o.id!=e.id&&n.push(o)}),t.peers[i.userid].streams=n}i.userid===t.userid&&"remote"===i.type||(t.peersBackup[i.userid]&&(i.extra=t.peersBackup[i.userid].extra),t.onstreamended(i),delete t.streamEvents[e.streamid])},!1)}},t.onMediaError=function(e,o){t.enableLogs&&console.error(e,o)},t.autoCloseEntireSession=!1,t.filesContainer=t.videosContainer=document.body||document.documentElement,t.isInitiator=!1,t.shareFile=r.shareFile,void 0!==M&&M.handle(t),void 0!==L&&L.handle(t),t.token=a,t.onNewParticipant=function(e,o){t.acceptParticipationRequest(e,o)},t.acceptParticipationRequest=function(e,o){o.successCallback&&(o.successCallback(),delete o.successCallback),r.createNewPeer(e,o)},void 0!==T&&(t.StreamsHandler=T),t.onleave=function(e){},t.invokeSelectFileDialog=function(e){var o=new FileSelector;o.accept="*.*",o.selectSingleFile(e)},t.onmute=function(e){if(e&&e.mediaElement)if("both"===e.muteType||"video"===e.muteType){e.mediaElement.src=null;var o=e.mediaElement.pause();void 0!==o?o.then(function(){e.mediaElement.poster=e.snapshot||"https://cdn.webrtc-experiment.com/images/muted.png"}):e.mediaElement.poster=e.snapshot||"https://cdn.webrtc-experiment.com/images/muted.png"}else"audio"===e.muteType&&(e.mediaElement.muted=!0)},t.onunmute=function(e){e&&e.mediaElement&&e.stream&&("both"===e.unmuteType||"video"===e.unmuteType?(e.mediaElement.poster=null,e.mediaElement.srcObject=e.stream,e.mediaElement.play()):"audio"===e.unmuteType&&(e.mediaElement.muted=!1))},t.onExtraDataUpdated=function(e){e.status="online",t.onUserStatusChanged(e,!0)},t.getAllParticipants=function(e){return t.peers.getAllParticipants(e)},void 0!==T&&(T.onSyncNeeded=function(e,o,n){t.peers.getAllParticipants().forEach(function(t){r.onNegotiationNeeded({streamid:e,action:o,streamSyncNeeded:!0,type:n||"both"},t)})}),t.connectSocket=function(e){m(e)},t.closeSocket=function(){try{io.sockets={}}catch(e){}t.socket&&("function"==typeof t.socket.disconnect&&t.socket.disconnect(),"function"==typeof t.socket.resetProps&&t.socket.resetProps(),t.socket=null)},t.getSocket=function(e){return!e&&t.enableLogs&&console.warn("getSocket.callback paramter is required."),e=e||function(){},t.socket?e(t.socket):m(function(){e(t.socket)}),t.socket},t.getRemoteStreams=r.getRemoteStreams;var E=["selectFirst","selectAll","forEach"];if(t.streamEvents={selectFirst:function(e){return t.streamEvents.selectAll(e)[0]},selectAll:function(e){e||(e={local:!0,remote:!0,isScreen:!0,isAudio:!0,isVideo:!0}),"local"==e&&(e={local:!0}),"remote"==e&&(e={remote:!0}),"screen"==e&&(e={isScreen:!0}),"audio"==e&&(e={isAudio:!0}),"video"==e&&(e={isVideo:!0});var o=[];return Object.keys(t.streamEvents).forEach(function(n){var i=t.streamEvents[n];if(-1===E.indexOf(n)){var r=!0;e.local&&"local"===i.type&&(r=!1),e.remote&&"remote"===i.type&&(r=!1),e.isScreen&&i.stream.isScreen&&(r=!1),e.isVideo&&i.stream.isVideo&&(r=!1),e.isAudio&&i.stream.isAudio&&(r=!1),e.userid&&i.userid===e.userid&&(r=!1),!1===r&&o.push(i)}}),o}},t.socketURL="/",t.socketMessageEvent="RTCMultiConnection-Message",t.socketCustomEvent="RTCMultiConnection-Custom-Message",t.DetectRTC=DetectRTC,t.setCustomSocketEvent=function(e){e&&(t.socketCustomEvent=e),t.socket&&t.socket.emit("set-custom-socket-event-listener",t.socketCustomEvent)},t.getNumberOfBroadcastViewers=function(e,o){t.socket&&e&&o&&t.socket.emit("get-number-of-users-in-specific-broadcast",e,o)},t.onNumberOfBroadcastViewersUpdated=function(e){t.enableLogs&&t.isInitiator&&console.info("Number of broadcast (",e.broadcastId,") viewers",e.numberOfBroadcastViewers)},t.onUserStatusChanged=function(e,o){t.enableLogs&&!o&&console.info(e.userid,e.status)},t.getUserMediaHandler=R,t.multiPeersHandler=r,t.enableLogs=!0,t.setCustomSocketHandler=function(e){void 0!==n&&(n=e)},t.chunkSize=4e4,t.maxParticipantsAllowed=1e3,t.disconnectWith=r.disconnectWith,t.checkPresence=function(e,o){e=e||t.sessionid,"SSEConnection"!==n.name?t.socket?t.socket.emit("check-presence",e+"",function(e,n,i){t.enableLogs&&console.log("checkPresence.isRoomExist: ",e," roomid: ",n),o(e,n,i)}):t.connectSocket(function(){t.checkPresence(e,o)}):SSEConnection.checkPresence(e,function(e,n,i){if(!t.socket)return e||(t.userid=n),void t.connectSocket(function(){o(e,n,i)});o(e,n)})},t.onReadyForOffer=function(e,o){t.multiPeersHandler.createNewPeer(e,o)},t.setUserPreferences=function(e){return t.dontAttachStream&&(e.dontAttachLocalStream=!0),t.dontGetRemoteStream&&(e.dontGetRemoteStream=!0),e},t.updateExtraData=function(){t.socket.emit("extra-data-updated",t.extra)},t.enableScalableBroadcast=!1,t.maxRelayLimitPerUser=3,t.dontCaptureUserMedia=!1,t.dontAttachStream=!1,t.dontGetRemoteStream=!1,t.onReConnecting=function(e){t.enableLogs&&console.info("ReConnecting with",e.userid,"...")},t.beforeAddingStream=function(e){return e},t.beforeRemovingStream=function(e){return e},"undefined"!=typeof isChromeExtensionAvailable&&(t.checkIfChromeExtensionAvailable=isChromeExtensionAvailable),"undefined"!=typeof isFirefoxExtensionAvailable&&(t.checkIfChromeExtensionAvailable=isFirefoxExtensionAvailable),"undefined"!=typeof getChromeExtensionStatus&&(t.getChromeExtensionStatus=getChromeExtensionStatus),t.modifyScreenConstraints=function(e){return e},t.onPeerStateChanged=function(e){t.enableLogs&&-1!==e.iceConnectionState.search(/closed|failed/gi)&&console.error("Peer connection is closed between you & ",e.userid,e.extra,"state:",e.iceConnectionState)},t.isOnline=!0,c("online",function(){t.isOnline=!0}),c("offline",function(){t.isOnline=!1}),t.isLowBandwidth=!1,navigator&&navigator.connection&&navigator.connection.type&&(t.isLowBandwidth=-1!==navigator.connection.type.toString().toLowerCase().search(/wifi|cell/g),t.isLowBandwidth)){if(t.bandwidth={audio:!1,video:!1,screen:!1},t.mediaConstraints.audio&&t.mediaConstraints.audio.optional&&t.mediaConstraints.audio.optional.length){var x=[];t.mediaConstraints.audio.optional.forEach(function(e){void 0===e.bandwidth&&x.push(e)}),t.mediaConstraints.audio.optional=x}if(t.mediaConstraints.video&&t.mediaConstraints.video.optional&&t.mediaConstraints.video.optional.length){x=[];t.mediaConstraints.video.optional.forEach(function(e){void 0===e.bandwidth&&x.push(e)}),t.mediaConstraints.video.optional=x}}t.getExtraData=function(e,o){if(!e)throw"remoteUserId is required.";if("function"!=typeof o)return t.peers[e]?t.peers[e].extra:t.peersBackup[e]?t.peersBackup[e].extra:{};t.socket.emit("get-remote-user-extra-data",e,function(e,t,n){o(e,t,n)})},o.autoOpenOrJoin&&t.openOrJoin(t.sessionid),t.onUserIdAlreadyTaken=function(e,o){t.close(),t.closeSocket(),t.isInitiator=!1,t.userid=t.token(),t.join(t.sessionid),t.enableLogs&&console.warn("Userid already taken.",e,"Your new userid:",t.userid)},t.trickleIce=!0,t.version="3.6.9",t.onSettingLocalDescription=function(e){t.enableLogs&&console.info("Set local description for remote user",e.userid)},t.resetScreen=function(){sourceId=null,DetectRTC&&DetectRTC.screen&&delete DetectRTC.screen.sourceId,currentUserMediaRequest={streams:[],mutex:!1,queueRequests:[]}},t.autoCreateMediaElement=!0,t.password=null,t.setPassword=function(e,o){o=o||function(){},t.socket?t.socket.emit("set-password",e,o):(t.password=e,o(!0,t.sessionid,null))},t.onSocketDisconnect=function(e){t.enableLogs&&console.warn("socket.io connection is closed")},t.onSocketError=function(e){t.enableLogs&&console.warn("socket.io connection is failed")},t.errors={ROOM_NOT_AVAILABLE:"Room not available",INVALID_PASSWORD:"Invalid password",USERID_NOT_AVAILABLE:"User ID does not exist",ROOM_PERMISSION_DENIED:"Room permission denied",ROOM_FULL:"Room full",DID_NOT_JOIN_ANY_ROOM:"Did not join any room yet",INVALID_SOCKET:"Invalid socket",PUBLIC_IDENTIFIER_MISSING:"publicRoomIdentifier is required",INVALID_ADMIN_CREDENTIAL:"Invalid username or password attempted"}}(this)};"undefined"!=typeof module&&(module.exports=exports=RTCMultiConnection),"function"==typeof define&&define.amd&&define("RTCMultiConnection",[],function(){return RTCMultiConnection}),function(){function e(){function e(e,o){o=o||function(e){postMessage(e)};var t=e.file;t.uuid||(t.uuid=(100*Math.random()).toString().replace(/\./g,""));var n=e.chunkSize||15e3;e.extra&&e.extra.chunkSize&&(n=e.extra.chunkSize);var i,r=0,s=n,a=Math.floor(Math.min(1e8,s)/n)*n,d=Math.ceil(t.size/n);t.maxChunks=d;var c=0,l=[];o({currentPosition:c,uuid:t.uuid,maxChunks:d,size:t.size,name:t.name,type:t.type,lastModifiedDate:(t.lastModifiedDate||new Date).toString(),start:!0});var u,m=new FileReader;m.onloadend=function(e){e.target.readyState==FileReader.DONE&&function(e,r,s){i=Math.ceil(r.byteLength/n);for(var a=0;a<i;a++){var u=a*n;l[c]=r.slice(u,Math.min(u+n,r.byteLength)),o({uuid:t.uuid,buffer:l[c],currentPosition:c,maxChunks:d,size:t.size,name:t.name,lastModifiedDate:(t.lastModifiedDate||new Date).toString(),type:t.type}),c++}c==d&&!0;s()}(t.name,e.target.result,function(){(++r+1)*a<t.size?(u=t.slice(r*a,(r+1)*a),m.readAsArrayBuffer(u)):r*a<t.size?(u=t.slice(r*a,t.size),m.readAsArrayBuffer(u)):(t.url=URL.createObjectURL(t),o({currentPosition:c,uuid:t.uuid,maxChunks:d,size:t.size,name:t.name,lastModifiedDate:(t.lastModifiedDate||new Date).toString(),url:URL.createObjectURL(t),type:t.type,end:!0}))})},c+=1,u=t.slice(r*a,(r+1)*a),m.readAsArrayBuffer(u)}this.readAsArrayBuffer=function(o,t){var n=t.earlyCallback;function i(e){o.chunks[e.uuid]||(o.chunks[e.uuid]={currentPosition:-1}),t.extra=t.extra||{userid:0},e.userid=t.userid||t.extra.userid||0,e.extra=t.extra,o.chunks[e.uuid][e.currentPosition]=e,e.end&&n&&(n(e.uuid),n=null),e.maxChunks>200&&200==e.currentPosition&&n&&(n(e.uuid),n=null)}delete t.earlyCallback,e(t,i)}}function o(e){var o=this;o.chunks={},o.chunksWaiters={},o.receive=function t(n,i){if(n.uuid){if(n.start&&!o.chunks[n.uuid]&&(o.chunks[n.uuid]={},e.onBegin&&e.onBegin(n)),!n.end&&n.buffer&&(o.chunks[n.uuid][n.currentPosition]=n.buffer),n.end){var r=o.chunks[n.uuid],s=[];Object.keys(r).forEach(function(e,o){s.push(r[e])});var a=new Blob(s,{type:n.type});(a=function(e,o){if(e||(e={}),!o)return e;for(var t in o)try{e[t]=o[t]}catch(e){}return e}(a,n)).url=URL.createObjectURL(a),a.uuid=n.uuid,a.size||console.error("Something went wrong. Blob Size is 0."),e.onEnd&&e.onEnd(a),delete o.chunks[n.uuid],delete o.chunksWaiters[n.uuid]}n.buffer&&e.onProgress&&e.onProgress(n),n.end||(i(n),o.chunksWaiters[n.uuid]=function(){setTimeout(function e(){n.buffer&&o.chunks[n.uuid]&&(n.currentPosition==n.maxChunks||o.chunks[n.uuid][n.currentPosition]||(i(n),setTimeout(e,5e3)))},5e3)},o.chunksWaiters[n.uuid]())}else e.convertToObject(n,function(e){t(e)})}}var t={ConvertToArrayBuffer:function(e,o){g.pack(e,function(e){o(e.buffer)})},ConvertToObject:function(e,o){g.unpack(e,o)}};var n=Uint8Array.BYTES_PER_ELEMENT,i=Uint16Array.BYTES_PER_ELEMENT,r=Uint32Array.BYTES_PER_ELEMENT,s={NULL:0,UNDEFINED:1,STRING:2,NUMBER:3,BOOLEAN:4,ARRAY:5,OBJECT:6,INT8ARRAY:7,INT16ARRAY:8,INT32ARRAY:9,UINT8ARRAY:10,UINT16ARRAY:11,UINT32ARRAY:12,FLOAT32ARRAY:13,FLOAT64ARRAY:14,ARRAYBUFFER:15,BLOB:16,FILE:16,BUFFER:17},a=[null,null,"Uint16","Float64","Uint8",null,null,"Int8","Int16","Int32","Uint8","Uint16","Uint32","Float32","Float64","Uint8","Uint8","Uint8"],d=function(e){var o=0,t=0,d=0,c=new ArrayBuffer(e[0].byte_length+e[0].header_size),l=new DataView(c);for(t=0;t<e.length;t++){e[t].header_size;var u=e[t].type,m=e[t].length,g=e[t].value,f=e[t].byte_length,v=a[u],p=null===v?0:window[v+"Array"].BYTES_PER_ELEMENT;switch(u===s.BUFFER?l.setUint8(o,s.BLOB,!1):l.setUint8(o,u,!1),o+=n,u!==s.ARRAY&&u!==s.OBJECT||(l.setUint16(o,m,!1),o+=i),l.setUint32(o,f,!1),o+=r,u){case s.NULL:case s.UNDEFINED:break;case s.STRING:for(d=0;d<m;d++,o+=p)l.setUint16(o,g.charCodeAt(d),!1);break;case s.NUMBER:case s.BOOLEAN:0,l["set"+v](o,g,!1),o+=p;break;case s.INT8ARRAY:case s.INT16ARRAY:case s.INT32ARRAY:case s.UINT8ARRAY:case s.UINT16ARRAY:case s.UINT32ARRAY:case s.FLOAT32ARRAY:case s.FLOAT64ARRAY:new Uint8Array(l.buffer,o,f).set(new Uint8Array(g.buffer)),o+=f;break;case s.ARRAYBUFFER:case s.BUFFER:new Uint8Array(l.buffer,o,f).set(new Uint8Array(g)),o+=f;break;case s.BLOB:case s.ARRAY:case s.OBJECT:break;default:throw"TypeError: Unexpected type found."}0}return l},c=function(e,o){var t,d,l,u,m,g=0;t=e.getUint8(o,!1),o+=n,t!==s.ARRAY&&t!==s.OBJECT||(d=e.getUint16(o,!1),o+=i),l=e.getUint32(o,!1),o+=r;var f=a[t],v=null===f?0:window[f+"Array"].BYTES_PER_ELEMENT;switch(t){case s.NULL:case s.UNDEFINED:0,u=null;break;case s.STRING:d=l/v;var p=[];for(g=0;g<d;g++){var h=e.getUint16(o,!1);o+=v,p.push(String.fromCharCode(h))}u=p.join("");break;case s.NUMBER:u=e.getFloat64(o,!1),o+=v;break;case s.BOOLEAN:u=1===e.getUint8(o,!1),o+=v;break;case s.INT8ARRAY:case s.INT16ARRAY:case s.INT32ARRAY:case s.UINT8ARRAY:case s.UINT16ARRAY:case s.UINT32ARRAY:case s.FLOAT32ARRAY:case s.FLOAT64ARRAY:case s.ARRAYBUFFER:m=e.buffer.slice(o,o+l),o+=l,u=t===s.ARRAYBUFFER?m:new window[f+"Array"](m);break;case s.BLOB:if(window.Blob){var S=c(e,o),C=c(e,S.cursor);o=C.cursor,u=new Blob([C.value],{type:S.value})}else m=e.buffer.slice(o,o+l),o+=l,u=new Buffer(m);break;case s.ARRAY:for(u=[],g=0;g<d;g++)o=(m=c(e,o)).cursor,u.push(m.value);break;case s.OBJECT:for(u={},g=0;g<d;g++){var w=c(e,o),y=c(e,w.cursor);o=y.cursor,u[w.value]=y.value}break;default:throw"TypeError: Type not supported."}return{value:u,cursor:o}},l=function(e,o){for(var t=e.length,n=[],i=0,r=0,s=0;s<e.length;s++)!function(s){u(e[s],function(e){if(n[s]=e,r+=e[0].header_size+e[0].byte_length,++i===t){for(var a=[],d=0;d<n.length;d++)a=a.concat(n[d]);o(a,r)}})}(s)},u=function(e,o){var t,d,c=n+r,u=0,m=0,g=e;switch(d=function(e){var o=void 0;if(void 0===e)o=s.UNDEFINED;else if(null===e)o=s.NULL;else{var t=e.constructor.name,n=e.constructor.toString().match(/\w+/g)[1];if(void 0!==t&&void 0!==s[t.toUpperCase()])o=s[t.toUpperCase()];else if(void 0!==n&&void 0!==s[n.toUpperCase()])o=s[n.toUpperCase()];else switch(typeof e){case"string":o=s.STRING;break;case"number":o=s.NUMBER;break;case"boolean":o=s.BOOLEAN;break;case"object":e instanceof Array?o=s.ARRAY:e instanceof Int8Array?o=s.INT8ARRAY:e instanceof Int16Array?o=s.INT16ARRAY:e instanceof Int32Array?o=s.INT32ARRAY:e instanceof Uint8Array?o=s.UINT8ARRAY:e instanceof Uint16Array?o=s.UINT16ARRAY:e instanceof Uint32Array?o=s.UINT32ARRAY:e instanceof Float32Array?o=s.FLOAT32ARRAY:e instanceof Float64Array?o=s.FLOAT64ARRAY:e instanceof ArrayBuffer?o=s.ARRAYBUFFER:e instanceof Blob?o=s.BLOB:e instanceof Buffer?o=s.BUFFER:e instanceof Object&&(o=s.OBJECT)}}return o}(e),t=null==a[d]?0:window[a[d]+"Array"].BYTES_PER_ELEMENT,d){case s.UNDEFINED:case s.NULL:break;case s.NUMBER:case s.BOOLEAN:u=t;break;case s.STRING:u+=(m=e.length)*t;break;case s.INT8ARRAY:case s.INT16ARRAY:case s.INT32ARRAY:case s.UINT8ARRAY:case s.UINT16ARRAY:case s.UINT32ARRAY:case s.FLOAT32ARRAY:case s.FLOAT64ARRAY:u+=(m=e.length)*t;break;case s.ARRAY:return void l(e,function(t,n){o([{type:d,length:e.length,header_size:c+i,byte_length:n,value:null}].concat(t))});case s.OBJECT:var f=[];for(var v in e)e.hasOwnProperty(v)&&(f.push(v),f.push(e[v]),m++);return void l(f,function(e,t){o([{type:d,length:m,header_size:c+i,byte_length:t,value:null}].concat(e))});case s.ARRAYBUFFER:u+=e.byteLength;break;case s.BLOB:var p=e.type,h=new FileReader;return h.onload=function(e){l([p,e.target.result],function(e,t){o([{type:d,length:m,header_size:c,byte_length:t,value:null}].concat(e))})},h.onerror=function(e){throw"FileReader Error: "+e},void h.readAsArrayBuffer(e);case s.BUFFER:u+=e.length;break;default:throw'TypeError: Type "'+e.constructor.name+'" not supported.'}o([{type:d,length:m,header_size:c,byte_length:u,value:g}].concat([]))},m=function(e,o){var t=e instanceof DataView?e:new DataView(e);return c(t,0).value};var g={pack:function(e,o){try{0,u(e,function(e){o(d(e))})}catch(e){throw e}},unpack:function(e,o){try{0;var t=m(e);0,o(t)}catch(e){throw e}}};window.FileConverter=t,window.FileSelector=function(){var e=this,o=function(){};function t(t,n,i){t=t||function(){};var r=document.createElement("input");r.type="file",n&&(r.multiple=!0),i&&(r.webkitdirectory=!0),r.accept=e.accept,r.onclick=function(){r.clickStarted=!0},document.body.onfocus=function(){setTimeout(function(){r.clickStarted&&(r.clickStarted=!1,r.value||o())},500)},r.onchange=function(){if(n){if(!r.files.length)return void console.error("No file selected.");var e=[];return Array.from(r.files).forEach(function(o){o.url=o.webkitRelativePath,e.push(o)}),void t(e)}r.files[0]?(t(r.files[0]),r.parentNode.removeChild(r)):console.error("No file selected.")},r.style.display="none",(document.body||document.documentElement).appendChild(r),function(e){if("function"==typeof e.click)return void e.click();if("function"==typeof e.change)return void e.change();if(void 0!==document.createEvent("Event")){if("function"==typeof(o=document.createEvent("Event")).initEvent&&"function"==typeof e.dispatchEvent)return o.initEvent("click",!0,!0),void e.dispatchEvent(o)}var o=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});e.dispatchEvent(o)}(r)}e.selectSingleFile=function(e,n){n&&(o=n),t(e)},e.selectMultipleFiles=function(e,n){n&&(o=n),t(e,!0)},e.selectDirectory=function(e,n){n&&(o=n),t(e,!0,!0)},e.accept="*.*"},window.FileBufferReader=function(){var n=this,i=new e;n.chunks={},n.users={},n.readAsArrayBuffer=function(e,o,t){var r={file:e,earlyCallback:function(e){o(s(e,{currentPosition:-1}))},extra:t||{userid:0}};e.extra&&Object.keys(e.extra).length&&Object.keys(e.extra).forEach(function(o){r.extra[o]=e.extra[o]}),i.readAsArrayBuffer(n,r)},n.getNextChunk=function(e,o,t){var i;void 0!==e.currentPosition&&(i=e.currentPosition,e=e.uuid);var r=n.chunks[e];if(r){void 0!==t?(n.users[t+""]||(n.users[t+""]={fileUUID:e,userid:t,currentPosition:-1}),void 0!==i&&(n.users[t+""].currentPosition=i),n.users[t+""].currentPosition++,i=n.users[t+""].currentPosition):(void 0!==i&&(n.chunks[e].currentPosition=i),n.chunks[e].currentPosition++,i=n.chunks[e].currentPosition);var a=r[i];if(!a)return delete n.chunks[e],void n.convertToArrayBuffer({chunkMissing:!0,currentPosition:i,uuid:e},o);a=s(a),void 0!==t&&(a.remoteUserId=t+""),a.start&&n.onBegin(a),a.end&&n.onEnd(a),n.onProgress(a),n.convertToArrayBuffer(a,function(e){a.currentPosition!=a.maxChunks?o(e,!1):o(e,!0)})}};var r=new o(n);function s(e,o){if(null==e||"object"!=typeof e)return e;if(e.constructor!=Object&&e.constructor!=Array)return e;if(e.constructor==Date||e.constructor==RegExp||e.constructor==Function||e.constructor==String||e.constructor==Number||e.constructor==Boolean)return new e.constructor(e);for(var t in o=o||new e.constructor,e)o[t]=void 0===o[t]?s(e[t],null):o[t];return o}n.addChunk=function(e,o){e&&r.receive(e,function(e){n.convertToArrayBuffer({readyForNextChunk:!0,currentPosition:e.currentPosition,uuid:e.uuid},o)})},n.chunkMissing=function(e){delete r.chunks[e.uuid],delete r.chunksWaiters[e.uuid]},n.onBegin=function(){},n.onEnd=function(){},n.onProgress=function(){},n.convertToObject=t.ConvertToObject,n.convertToArrayBuffer=t.ConvertToArrayBuffer,n.setMultipleUsers=function(){}}}();var publicRoomIdentifier,connection,videoConnection,screenConnection,tenant,role,sessionId,sessionForChat,roomId,socket,streamConstraints,recentFile,conversationPanel,tempStream,lsDesigner,conferenceStyle,classVideo,videoElementContainer,videoWidgetContainer,roomLinkPage,facingMode,iphoneLocalStream,localVideoStream,caller_name,caller_phone,caller_avatar,caller_email,peer_name,peer_phone,peer_avatar,peer_logo,peer_background,peer_email,lsRepUrl,ui_handler,notify_handler,jQEngager,pluginInstalled,pluginController,comm_controller,visitors,queryString,videoDevices,multiStreamRecorder,agentId,recordScreen,recordCamera,recordingTimer,videoDefault,videoCurrent,audioSource,videoSource,testAudioTrack,testVideoTrack,videoSelect,audioInputSelect,audioOutputSelect,sourceBuffer,passRoom,agentAvatar,visitorName,agentName,datetime,duration,token,room,disableVideo,disableAudio,disableScreenShare,disableWhiteboard,disableTransfer,autoAcceptVideo,autoAcceptAudio,translator,roomPrd,recordingHeight,pipVideo,speech,forceClose=!1,autoReconnectInterval=5e3,popupNotifications=[],extensionSessions=[],repeatStatInterval=2e3,visitorRinging=[],requirePassComm=!1,participantsAll=[],RMCMediaTrack={cameraStream:null,cameraTrack:null,screen:null},comController=function(){var e=this;this.init=function(t,n){requirePassComm=void 0!==passRoom&&passRoom,roomId=n,role=t,sessionId=getCookie("sessionId")&&"admin"!==getCookie("sessionId")?getCookie("sessionId"):getGuid(),queryString.s&&(sessionId=queryString.s);var i="admin"===role?"a":"";if(sessionForChat=getCookie("sessionForChat")?getCookie("sessionForChat"):sessionId+i,"admin"===role&&(sessionId="admin"),queryString.isAdmin&&(sessionId+="a"),facingMode=svConfigs.videoScreen.primaryCamera?svConfigs.videoScreen.primaryCamera:"user",setCookie("sessionId",sessionId,1),setCookie("sessionForChat",sessionForChat,1),window.enableAdapter=!0,publicRoomIdentifier="dashboard",tenant="dashboard",(connection=new RTCMultiConnection).enableLogs=!!svConfigs.videoScreen.enableLogs&&svConfigs.videoScreen.enableLogs,connection.iceServers=svConfigs.iceServers.iceServers,connection.socketURL=svConfigs.appWss,connection.autoCreateMediaElement=!1,conferenceStyle=svConfigs.videoScreen&&"conference"===svConfigs.videoScreen.videoContainerStyle?"conference":"simple",classVideo="conference"===conferenceStyle?"sourcevideo":"bigvideo",videoElementContainer="conference"===conferenceStyle?"video_container_small":"video_container",videoWidgetContainer="conference"===conferenceStyle?"w.html":"widget.html",roomLinkPage="conference"==conferenceStyle?"r.html":"room.html",connection.publicRoomIdentifier=publicRoomIdentifier,connection.onbeforeunload=function(){},connection.session={audio:!1,video:!1,data:!0},connection.processSdp=function(e){return e},void 0!==names)var r=names[sessionId]?names[sessionId].name:guestName(sessionId);else r=guestName(sessionId);try{var s=localStorage.getItem("prd")?JSON.parse(localStorage.getItem("prd")):""}catch(e){s=""}if(connection.extra={role:role,name:r,tenant:tenant,sessionId:sessionId,ua:navigator.userAgent,referrer:document.title,roomId:roomId,isAdmin:queryString.isAdmin||"admin"==role?1:0,pass:requirePassComm,callerInfo:s},connection.onopen=function(e){if(svConfigs.videoScreen.enableLogs&&console.log("You are connected with: "+connection.getAllParticipants().join(", ")),lsDesigner&&lsDesigner.pointsLength<=0&&setTimeout(function(){connection.send("plz-sync-points")},1e3),"popup"==e.extra.role)if(e.extra.isAdmin){var o=jQEngager.Event("AdminPopupOnline",{sessionId:e.extra.sessionId,isAdmin:1,pass:e.extra.pass});jQEngager(document).trigger(o)}else{if(e.extra.callerInfo)e={sessionId:e.extra.sessionId,isAdmin:e.extra.isAdmin,name:e.extra.callerInfo?e.extra.callerInfo.name:e.extra.name,callerInfo:e.extra.callerInfo,pass:e.extra.pass};else e={sessionId:e.extra.sessionId,isAdmin:e.extra.isAdmin,pass:e.extra.pass};o=jQEngager.Event("PopupOnline",e);jQEngager(document).trigger(o)}if(e.extra&&"admin"==e.extra.role){o=jQEngager.Event("AdminOnline");jQEngager(document).trigger(o)}},connection.onclose=connection.onerror=connection.onleave=function(e){if(e.extra&&"admin"==e.extra.role){var o=jQEngager.Event("AdminOffline");jQEngager(document).trigger(o)}e.extra&&"visitor"==e.extra.role&&(jQEngager("#simpleButton"+e.extra.sessionId).hide(),jQEngager("#chats-lsv-admin").remove("#simpleButton"+e.extra.sessionId))},connection.onUserStatusChanged=function(o){if(svConfigs.videoScreen.enableLogs&&console.log("onUserStatusChanged",o),"offline"==o.status&&0==connection.getAllParticipants().length){var t=jQEngager.Event("AdminPopupOffline");jQEngager(document).trigger(t),e.handleCallTermination()}"online"==o.status&&"admin"===role&&socket.emit(connection.socketCustomEvent,{type:"adminOnline",role:"admin"})},connection.onPeerStateChanged=function(e){if(svConfigs.videoScreen.enableLogs&&console.log("On PeerStateChanged",e),"closed"==e.iceConnectionState&&e.extra&&e.extra.isAdmin){var o=jQEngager.Event("AdminOffline");jQEngager(document).trigger(o);o=jQEngager.Event("AdminPopupOffline");jQEngager(document).trigger(o);for(var t=0;t<popupNotifications.length;t++)popupNotifications[t]==e.extra.sessionId&&popupNotifications.splice(t,1)}},this.onGettingWebRTCStats=function(e,o){videoConnection.peers[o]||e.nomore();bytesToSize(e.bandwidth.speed),e.encryption,e.audio.recv.codecs.concat(e.video.recv.codecs).join(", "),bytesToSize(e.audio.bytesReceived+e.video.bytesReceived),e.connectionType.remote.candidateType.join(", "),e.connectionType.remote.transport.join(", "),e.results.forEach(function(e){if("ssrc"===e.type&&"Channel-audio-1"===e.transportId){var o=e.packetsLost;e.packetsSent,e.audioInputLevel,e.googTrackId,e.mediaType,e.id.indexOf("_send");"\n","packetsLost: "+o}})},this.joinBroadcastLooper=function(){videoConnection.extra.broadcaster=!1,videoConnection.dontCaptureUserMedia=!0,videoConnection.session.oneway=!0,function e(){videoConnection.checkPresence(roomId+"_video",function(o,t,n){n._room&&n._room.isFull&&alert("Room is full."),o?videoConnection.join(roomId+"_video",function(e,o,t){t?console.error("join",t,roomId+"_video"):setTimeout(function(){var e=jQEngager.Event("MakeBigBroadcast");jQEngager(document).trigger(e)},3e3)}):setTimeout(e,5e3)})}()},this.startScreenConnection=function(e,o){screenConnection.openOrJoin(roomId+"_screen",function(t,n,i){screenConnection.isInitiator=e,(e||screenConnection.extra.sessionId!==o)&&(screenConnection.extra={sessionId:o}),e&&socket.emit(connection.socketCustomEvent,{type:"startScreenShare",role:role,tenant:tenant,sessionId:o,roomId:roomId})})},connection.onmessage=function(o){if(!0!==o.data.typing)if(!1!==o.data.typing)if(o.data.chatMessage)if(o.data.privateId){if(o.data.privateId==e.getSessionId()){d=jQEngager.Event("ChatMessage",{msg:o.data.chatMessage,date:o.data.date,sessionId:o.data.sessionId,privateId:o.data.privateId});jQEngager(document).trigger(d)}if(o.data.privateId&&"admin"===role){jQEngager("#simpleButton"+o.data.privateId).show();var t=$("#contentChatsimple"+o.data.privateId)[0],n=$("#nameChat"+o.data.privateId).val();const e='<div class="msg-lsv ${side}-msg-lsv">   <div class="msg-lsv-bubble"> \t<div class="msg-lsv-info"> \t  <div class="msg-lsv-info-name">'+n+'</div> \t  <div class="msg-lsv-info-time">'+getPrettyDate((new Date).getTime()/1e3)+'</div> \t</div>  \t<div class="msg-lsv-text">'+o.data.chatMessage+"</div>   </div> </div>";if(t.insertAdjacentHTML("beforeend",e),t.scrollTop+=500,playEnterRoom(),svConfigs.serverSide.chatHistory){var i=o.data.privateId,r=[];r[sessionForChat]={},r[i]={},saveChat(o.data.chatMessage,n,"",null,null,r)}}}else{d=jQEngager.Event("ChatMessage",{msg:o.data.chatMessage,date:o.data.date,sessionId:o.data.sessionId});jQEngager(document).trigger(d)}else if(o.data.translateMessage){d=jQEngager.Event("TranslateMessage",{msg:o.data.translateMessage,sessionId:o.data.sessionId});jQEngager(document).trigger(d)}else{if("voiceSpeaking"===o.data){d=jQEngager.Event("VoiceSpeaking",{id:o.userid});jQEngager(document).trigger(d)}if("voiceSilence"===o.data){d=jQEngager.Event("VoiceSilence",{id:o.userid});jQEngager(document).trigger(d)}if(lsDesigner&&"plz-sync-points"===o.data)lsDesigner.sync();else if(o.data.whiteboardData){d=jQEngager.Event("WhiteboardSync");if(jQEngager(document).trigger(d),queryString.isAdmin||localStorage.getItem("hasPrivileges")||e.startWhiteboard(),lsDesigner||e.startWhiteboard(),o.data.whiteboardData){var s=o.data.whiteboardData,a=screen.width/o.data.width;s.points.forEach(function(e){if("text"==e[0]){e[1][1]=e[1][1]*a,e[1][2]=e[1][2]*a;var o=e[2][7].split(" "),t=o[0].split("px");e[2][7]=t[0]*a+"px "+o[1]}else"image"==e[0]||"pdf"==e[0]?(e[1][1]=e[1][1]*a,e[1][2]=e[1][2]*a,e[1][3]=e[1][3]*a,e[1][4]=e[1][4]*a):(e[1][0]=e[1][0]*a,e[1][1]=e[1][1]*a,e[1][2]=e[1][2]*a,e[1][3]=e[1][3]*a,e[2][0]=e[2][0]*a)}),lsDesigner.syncData(s)}else lsDesigner.clearCanvas()}}else{var d=jQEngager.Event("SendTyping",{typing:!1});jQEngager(document).trigger(d)}else{var d=jQEngager.Event("SendTyping",{typing:!0,sessionId:o.userid});jQEngager(document).trigger(d)}},queryString.room){(videoConnection=new RTCMultiConnection).enableLogs=!!svConfigs.videoScreen.enableLogs&&svConfigs.videoScreen.enableLogs,videoConnection.iceServers=svConfigs.iceServers.iceServers,videoConnection.socketURL=svConfigs.appWss,videoConnection.maxParticipantsAllowed=svConfigs.maxParticipantsAllowed?svConfigs.maxParticipantsAllowed:1e3,videoConnection.publicRoomIdentifier=publicRoomIdentifier,videoConnection.autoCreateMediaElement=!1,queryString.broadcast?videoConnection.sdpConstraints.mandatory={OfferToReceiveAudio:!0,OfferToReceiveVideo:!!queryString.isAdmin}:videoConnection.sdpConstraints.mandatory={OfferToReceiveAudio:!0,OfferToReceiveVideo:!0},videoConnection.extra={sessionId:sessionId},videoConnection.onclose=videoConnection.onerror=videoConnection.onleave=function(e){if(e.extra&&e.extra.sessionId){var o=jQEngager.Event("PopupLeft",{sessionId:e.extra.sessionId,isAdmin:0});jQEngager(document).trigger(o)}},videoConnection.onPeerStateChanged=function(e){},videoConnection.onspeaking=function(o){audio_on&&video_on&&e.getStream()&&connection.send("voiceSpeaking")},videoConnection.onsilence=function(e){connection.send("voiceSilence")},videoConnection.onMediaError=function(e){if("NotAllowedError"===e.name||"SecurityError"===e.name){e=jQEngager.Event("TogglePermissionDenied");jQEngager(document).trigger(e),socket.emit(connection.socketCustomEvent,{type:"endCall",role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})}else if("NotFoundError"===e.name){e=jQEngager.Event("NotFoundError");jQEngager(document).trigger(e),socket.emit(connection.socketCustomEvent,{type:"endCall",role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})}else if("NotReadableError"===e.name){e=jQEngager.Event("NotReadableError");jQEngager(document).trigger(e),socket.emit(connection.socketCustomEvent,{type:"endCall",role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})}else{e=jQEngager.Event("MediaError",{error:e.name});jQEngager(document).trigger(e),socket.emit(connection.socketCustomEvent,{type:"endCall",role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})}},connection.chunkSize=16e3,connection.enableFileSharing=!0,connection.onUserIdAlreadyTaken=function(e,o){},connection.autoSaveToDisk=!1;var a={};if(connection.onFileProgress=function(e,o){var t=a[e.uuid];t.progress[0].value=e.currentPosition||e.maxChunks||t.progress[0].max},connection.onFileStart=function(e){if(e.userid===connection.userid){if(!recentFile.started){recentFile.started=!0;var o=jQEngager.Event("IncomingFileTransfer",{name:e.name,sender:!0,fileId:e.uuid});jQEngager(document).trigger(o)}}else{o=jQEngager.Event("IncomingFileTransfer",{name:e.name,sender:!1,fileId:e.uuid});jQEngager(document).trigger(o)}a[e.uuid]={progress:jQEngager("#progress"+e.uuid)},a[e.uuid].progress.max=e.maxChunks},connection.onFileEnd=function(o){var t=e.getFileHTML(o);if(o.userid===connection.userid)if(recentFile){recentFile.userIndex++;var n=connection.getAllParticipants()[recentFile.userIndex];n?connection.send(recentFile,n):recentFile=null}else recentFile=null;else jQEngager("#download"+o.uuid).html(t)},videoConnection.onstream=function(t){if(svConfigs.videoScreen.enableLogs&&console.log("videoConnection.onstream",t),videoConnection.videosContainer=document.getElementById(videoElementContainer),"local"===t.type){var n=jQEngager.Event("LocalVideoStarted");if(jQEngager(document).trigger(n),t.stream.isVideo)iphoneLocalStream=RMCMediaTrack.cameraStream=t.stream,RMCMediaTrack.cameraTrack=e.getTracks(t.stream,"video")[0],(r=document.getElementById("localVideo")).setAttribute("data-sessionId",t.extra.sessionId),svConfigs.videoScreen.localFeedMirrored&&(r.style.transform="scale(-1, 1)"),r.srcObject=svConfigs.videoScreen.videoFileStream?localVideoStream:t.stream,r.play(),RMCMediaTrack.selfVideo=r,videoConnection.extra.screen&&(RMCMediaTrack.cameraTrack.onended=RMCMediaTrack.cameraTrack.onmute=RMCMediaTrack.cameraTrack.oninactive=function(){o=!1,videoConnection.extra.screen=!1,e.handleScreenShareTermination()}),isiPhone&&e.checkMediaDevices()}else{if(void 0===t.extra.sessionId)return;$(".sourcevideo").each(function(){$(this).attr("id"),t.extra.sessionId}),$(".bigvideo").each(function(){$(this).attr("id"),t.extra.sessionId});var i=document.getElementById("remoteVideoSpan"+t.extra.sessionId),r=document.getElementById(t.extra.sessionId);i&&i.remove(),r&&r.remove();var s=document.createElement("video");s.id=t.extra.sessionId;var a=videoConnection.getAllParticipants().length;if(s.setAttribute("class",classVideo),"conference"!==conferenceStyle){var d=a>1?"49%":"98%";s.style.width=d}try{s.setAttributeNode(document.createAttribute("autoplay")),s.setAttributeNode(document.createAttribute("playsinline")),s.setAttributeNode(document.createAttribute("videoautoplay"))}catch(n){s.playsinline=!0,s.autoplay=!0,s.videoautoplay=!0}var c=t.stream;if("srcObject"in s?s.srcObject=c:s[navigator.mozGetUserMedia?"mozSrcObject":"src"]=navigator.mozGetUserMedia?c:(window.URL||window.webkitURL).createObjectURL(c),videoConnection.videosContainer.appendChild(s),queryString.broadcast){n=jQEngager.Event("RemoteVideoStarted");jQEngager(document).trigger(n),queryString.token?toggleNotification(smartVideoLocale.msgStore.welcomeBroadcast,!0):toggleNotification(smartVideoLocale.msgStore.incomingBroadcast,!0);var l=s.play();void 0!==l&&l.then(function(){toggleNotification("",!1),s.play()}).catch(function(e){$("#incomingBroadcast").click(function(){toggleNotification("",!1),s.play()})})}else{n=jQEngager.Event("RemoteVideoStarted");jQEngager(document).trigger(n)}visitorRinging=[],setTimeout(function(){connection.send("voiceSpeaking")},1500)}if(queryString.broadcast)if("remote"===t.type&&videoConnection.isInitiator){var u=[];videoConnection.getAllParticipants().forEach(function(e){u.push({pid:e,broadcaster:!0===videoConnection.peers[e].extra.broadcaster})}),videoConnection.socket.emit(videoConnection.socketCustomEvent,{roomId:roomId,participants:u})}else"remote"!==t.type||videoConnection.extra.broadcaster||videoConnection.socket.emit(videoConnection.socketCustomEvent,{giveAllParticipants:!0,roomId:roomId});videoConnection.onUserStatusChanged(t),isiPhone||e.initHark({stream:t.stream,streamedObject:t,connection:videoConnection})},videoConnection.onstreamended=function(o){if(o.extra){var t=document.getElementById(o.extra.sessionId);t&&(t.parentNode.removeChild(t),$("#remoteVideoSpan"+o.extra.sessionId).remove(),$("#"+o.extra.sessionId).remove());var n=jQEngager.Event("RemoteVideoStopped",{sessionId:o.extra.sessionId});jQEngager(document).trigger(n);var i=videoConnection.getAllParticipants().length;0===i&&e.handleCallTermination(),queryString.broadcast&&!queryString.isAdmin&&"local"!==o.type&&0===i&&(toggleError(smartVideoLocale.msgStore.broadcastStopped,5e3),setTimeout(function(){location.reload()},1e3))}},videoConnection.onUserStatusChanged=function(o){var t=[];connection.getAllParticipants().forEach(function(o){t.push(e.getFullName(o))}),t=t.length?[connection.extra.userFullName||"You"].concat(t):["Only You"]},videoConnection.onopen=function(){svConfigs.videoScreen.enableLogs&&console.log("You are connected with: "+connection.getAllParticipants().join(", "))},videoConnection.onEntireSessionClosed=function(e){videoConnection&&(videoConnection.leave(),videoConnection.streamEvents.selectAll({local:!0}).forEach(function(e){e.stream.getAudioTracks()[0].stop(),e.stream.getVideoTracks()[0].stop()}));var o=jQEngager.Event("CallEnded");jQEngager(document).trigger(o)},"conference"==conferenceStyle&&(connection.autoCloseEntireSession=!1,videoConnection.autoCloseEntireSession=!1),!queryString.broadcast&&svConfigs.videoScreen.separateScreenShare){(screenConnection=new RTCMultiConnection).enableLogs=!!svConfigs.videoScreen.enableLogs&&svConfigs.videoScreen.enableLogs,screenConnection.maxParticipantsAllowed=svConfigs.maxParticipantsAllowed?svConfigs.maxParticipantsAllowed:1e3,screenConnection.closeBeforeUnload=!1,screenConnection.iceServers=svConfigs.iceServers.iceServers,screenConnection.socketURL=svConfigs.appWss,screenConnection.publicRoomIdentifier=publicRoomIdentifier,screenConnection.autoCloseEntireSession=!1,screenConnection.autoCreateMediaElement=!1,screenConnection.sdpConstraints.mandatory={OfferToReceiveAudio:!1,OfferToReceiveVideo:!0};var d={mandatory:{maxWidth:screen.width>1920?screen.width:1920,maxHeight:screen.height>1080?screen.height:1080},optional:[]};screenConnection.mediaConstraints=d,screenConnection.session={screen:!0,oneway:!0},screenConnection.onstream=function(e){if("local"===e.type)var o=document.getElementById("localScreen");else o=document.getElementById("remoteScreen");try{o.setAttributeNode(document.createAttribute("autoplay")),o.setAttributeNode(document.createAttribute("playsinline"))}catch(t){o.setAttribute("autoplay",!0),o.setAttribute("playsinline",!0)}if("local"===e.type){o.volume=0;try{o.setAttributeNode(document.createAttribute("muted"))}catch(t){o.setAttribute("muted",!0)}}else{var t=jQEngager.Event("RemoteScreenShareStarted");jQEngager(document).trigger(t)}o.srcObject=e.stream},screenConnection.onstreamended=function(o){var t=jQEngager.Event("ScreenShareEnded");jQEngager(document).trigger(t);t=jQEngager.Event("ScreenShareStopped");jQEngager(document).trigger(t),e.handleScreenShareTermination()},screenConnection.onMediaError=function(o){if("Concurrent mic process limit."===o.message){if(DetectRTC.audioInputDevices.length<=1)return void alert("Please select external microphone. Check github issue number 483.");var t=DetectRTC.audioInputDevices[1].deviceId;screenConnection.mediaConstraints.audio={deviceId:t}}if("Permission denied"===o.message){o=jQEngager.Event("ScreenShareEnded");jQEngager(document).trigger(o);o=jQEngager.Event("ScreenShareStopped");jQEngager(document).trigger(o),e.handleScreenShareTermination()}}}}e.connect()},this.connect=function(){this.updateListOfRooms=function(o){jQEngager("#visitors").empty(),jQEngager("#meetings").empty(),jQEngager("#visitorsCount").html(0);var t=0,n=0;o.forEach(function(o,i){if(o.extra&&o.extra.callerInfo){participantsAll[o.sessionid]||(participantsAll[o.sessionid]=[]);var r={sessionId:o.extra.sessionId,name:o.extra.callerInfo.name,ua:""};participantsAll[o.sessionid].some(e=>e.sessionId===o.extra.sessionId)?(participantsAll[o.sessionid].splice(participantsAll[o.sessionid].findIndex(e=>e.sessionId===o.extra.sessionId),1),participantsAll[o.sessionid].push(r)):participantsAll[o.sessionid].push(r)}var s=[];if(o.participants.forEach(function(e,t){s.push({sessionId:e,name:""}),participantsAll&&participantsAll[o.sessionid]&&participantsAll[o.sessionid].forEach(function(o,t){if(e==o.sessionId){s.some(e=>e.sessionId===o.sessionId)&&s.splice(s.findIndex(e=>e.sessionId===o.sessionId),1),s.push({sessionId:o.sessionId,name:o.name,ua:o.ua})}})}),participantsAll[o.sessionid]=s,"_video"==o.sessionid.substr(-6)){if(participantsAll){var a="";participantsAll[o.sessionid.substr(0,o.sessionid.length-6)].forEach(function(e,o){var t=e.name?e.name:guestName(e.sessionId),n=e.ua&&"undefined"!=typeof detect?detect.parse(e.ua):"",i=n?n.browser.name:"",r=n?n.os.name:"";a+=t+(i&&r?" ("+r+", "+i+")":"")+", "})}var d="",c="";for(const e in o.session)d+=`${e}: ${o.session[e]}`+", ","broadcast"==e&&(c="&broadcast=1");var l={};l.names=participantsAll[o.sessionid.substr(0,o.sessionid.length-6)][0].name,lsRepUrl&&(l.lsRepUrl=lsRepUrl),agentId&&(l.agentId=agentId);var u=window.btoa(unescape(encodeURIComponent(JSON.stringify(l)))),m=lsRepUrl+"pages/"+roomLinkPage+"?room="+o.sessionid.substr(0,o.sessionid.length-6)+"&p="+u+"&isAdmin=1"+c,g=lsRepUrl+"pages/"+roomLinkPage+"?room="+o.sessionid.substr(0,o.sessionid.length-6)+"&p="+u+c,f=document.createElement("tr");f.id=o.sessionid,f.innerHTML="<td>"+o.sessionid.substr(0,o.sessionid.length-6)+"</td><td>"+d+"</td><td>"+a+'<br/><span data-localize="total">Total</span>: '+o.participants.length+'</td><td><a href="'+m+'" target="_blank"><span data-localize="join_agent">Join as agent</span></a> | <a href="'+g+'" target="_blank"><span data-localize="join_visitor">Join as visitor</span></a></td>',jQEngager("#meetings").append(f);$("[data-localize]").localize("dynamic",{language:"en",pathPrefix:"locales",loadBase:!0})}o.participants.forEach(function(i,r){var s=connection.peers[i];if(s){n++;var a=s.extra,d=jQEngager("#visitors").find("#"+a.sessionId),c=a.ua&&"undefined"!=typeof detect?detect.parse(a.ua):"",l=c?c.browser.name:"",u=c?c.os.name:"",m=a.callerInfo&&a.callerInfo.name?a.callerInfo.name:guestName(a.sessionId),g='<a href="javascript:void(0);" id="chat'+a.sessionId+'">Start chat</a>',f='<section class="msger-lsv" id="simpleButton'+a.sessionId+'" style="display: none;">                            <header class="msger-lsv-header">                                <div class="msger-lsv-header-title">                                        '+m+'                                </div>                                <div class="msger-lsv-header-options">                                        <a href="javascript:void(0);" title="" class="close-but-wd-small" id="closeSimpleChat'+a.sessionId+'"><span></span></a>                                </div>                        </header>                        <main class="msger-lsv-chat" id="contentChatsimple'+a.sessionId+'">                        </main>                        <form class="msger-lsv-inputarea" id="form'+a.sessionId+'">                                <input type="text" id="input'+a.sessionId+'" class="msger-lsv-input" placeholder="Enter your message...">                                <input type="hidden" id="nameChat'+a.sessionId+'" value="'+m+'">                                <button type="submit" class="msger-lsv-send-btn">Send</button>                        </form>                </section>';if(0==d.length){g='<a href="javascript:void(0);" id="chat'+a.sessionId+'">Start chat</a>';var v=document.createElement("div");v.className="row msg_container base_receive",v.id=a.sessionId,v.innerHTML='<div class="col-sm-10 col-xs-10">                                                                        <div class="messages msg_receive">                                                                                <p>'+m+" "+a.referrer+" "+g+"<br/>"+u+" "+l+"</p>                                                                                                                                                        </div>                                                                </div>",jQEngager("#visitors").append(v),t++}if($("#chat"+a.sessionId).off("click"),$("#chat"+a.sessionId).click(function(){$("#simpleButton"+a.sessionId).show()}),0==jQEngager("#chats-lsv-admin").find("#simpleButton"+a.sessionId).length){jQEngager("#chats-lsv-admin").append(f),$("#chat"+a.sessionId).click(function(){$("#simpleButton"+a.sessionId).show()}),$("#closeSimpleChat"+a.sessionId).click(function(){$("#simpleButton"+a.sessionId).hide()});var p=function(e,o,t,n){if(!t)return;t=linkify(t);var i=$("#contentChatsimple"+a.sessionId)[0];const r='<div class="msg-lsv '+o+'-msg-lsv">   <div class="msg-lsv-bubble"> \t<div class="msg-lsv-info"> \t  <div class="msg-lsv-info-name">'+e+'</div> \t  <div class="msg-lsv-info-time">'+(n||getPrettyDate((new Date).getTime()/1e3))+'</div> \t</div>  \t<div class="msg-lsv-text">'+t+"</div>   </div> </div>";i&&(i.insertAdjacentHTML("beforeend",r),i.scrollTop+=500)};$("#form"+a.sessionId).submit(function(o){o.preventDefault();var t=$("#input"+a.sessionId),n=t.val();if(p("Me","right",n),t.val(""),e.addLocalChat(n,null,a.sessionId),svConfigs.serverSide.chatHistory){var i=svConfigs.agentName?svConfigs.agentName:"Agent",r=a.sessionId,s=[];s[sessionForChat]={},s[r]={},saveChat(n,i,"",null,null,s)}}),svConfigs.serverSide.chatHistory&&$.ajax({type:"POST",timeout:5e3,url:lsRepUrl+"server/script.php",data:{type:"getchat",roomId:roomId,sessionId:a.sessionId,agentId:null}}).done(function(e){e&&JSON.parse(e).forEach(function(e){var o=svConfigs.agentName?svConfigs.agentName:"Agent";if(e.from==o)var t="Me",n="right";else t=e.from,n="left";var i=getPrettyDate(e.date_created);p(t,n,e.message,i)})}).fail(function(){})}if("popup"==o.extra.role){var h={};h.names=svConfigs.agentName?svConfigs.agentName:guestName(a.sessionId),lsRepUrl&&(h.lsRepUrl=lsRepUrl),agentId&&(h.agentId=agentId),a.callerInfo&&a.callerInfo.duration&&(h.duration=a.callerInfo.duration),a.callerInfo&&a.callerInfo.datetime&&(h.datetime=a.callerInfo.datetime);var S=window.btoa(unescape(encodeURIComponent(JSON.stringify(h)))),C=lsRepUrl+"pages/"+roomLinkPage+"?room="+o.extra.roomId+"&p="+S+"&isAdmin=1";if(-1==jQEngager.inArray(a.sessionId,extensionSessions)){var w=a.referrer,y=new CustomEvent("ExtVisitorVideoSession",{detail:{name:m,url:C,sessionId:a.sessionId,title:w}});document.dispatchEvent(y),extensionSessions.push(a.sessionId)}var b=jQEngager("#visitors").find("#"+a.sessionId),I=jQEngager("#visitors").find("#room"+a.sessionId),_=!1;if(jQEngager("#roomid_"+o.extra.roomId).html(o.extra.roomId+' <img src="../img/online.png" alt="waiting to connect">'),o.participants.forEach(function(e,t){connection.peers[e]||(_=!0,jQEngager("#roomid_"+o.extra.roomId).html(o.extra.roomId+' <img src="../img/offline.png" alt="busy">'))}),b.length>0&&0===I.length&&!_&&(setTimeout(function(){var e=b.children().children().children(),o=document.createElement("span");o.id="room"+a.sessionId,o.innerHTML=' <a href="'+C+'" target="_blank">Enter Room</a>',e.append(o)},200),-1==jQEngager.inArray(a.sessionId,popupNotifications))){playEnterRoom();var k=jQEngager.Event("EnterPageNotification",{name:m});jQEngager(document).trigger(k),popupNotifications.push(a.sessionId)}}}});var v=new CustomEvent("ExtVisitorsCount",{detail:{count:n}});document.dispatchEvent(v),jQEngager("#visitorsCount").html(t)})},this.looper=function(){connection.socket.emit("get-public-rooms",publicRoomIdentifier,function(o){e.updateListOfRooms(o),setTimeout(e.looper,3e3)})},connection.connectSocket(function(o){socket=o,connection.changeUserId(sessionId,null),e.showStatusBar("Connected to the chat server!",5e3);var t=jQEngager.Event("CommConnected");jQEngager(document).trigger(t),"admin"===role&&e.looper();socket.on("connect",function(o){e.showStatusBar("Connected to the chat server!",5e3)}),socket.on("disconnect",function(o){e.showStatusBar("Unable to connect to the chat server! Kindly refresh",1e4);var t=jQEngager.Event("AdminOffline");jQEngager(document).trigger(t),jQEngager("#visitors").empty(),location.reload()}),socket.on(connection.socketCustomEvent,function(o){if("initCall"===o.type&&sessionId!==o.sessionId&&o.roomId===roomId){connection.getAllParticipants().forEach(function(e){visitorRinging.push(e)});var t=jQEngager.Event("IncomingCall",{autoaccept:o.autoaccept,sessionId:o.sessionId});jQEngager(document).trigger(t)}if("customerHere"===o.type&&sessionId!==o.sessionId&&"dashboard"===roomId){jQEngager("#roomid_"+o.roomId).html(o.roomId+' <img src="../img/online.png" alt="waiting to connect">');t=jQEngager.Event("EnterCustomerNotification",{name:o.name,roomId:o.roomId});jQEngager(document).trigger(t),setTimeout(function(){jQEngager("#roomid_"+o.roomId).html(o.roomId)},1e4)}if("customerOut"===o.type&&sessionId!==o.sessionId&&"dashboard"===roomId&&jQEngager("#roomid_"+o.roomId).html(o.roomId),"askAdmin"===o.type&&sessionId!==o.sessionId&&queryString.isAdmin){t=jQEngager.Event("AskAdmit",{name:o.name,sessionId:o.sessionId});jQEngager(document).trigger(t)}if("approveAdmit"===o.type&&sessionId==o.approveSessionId&&!queryString.isAdmin){t=jQEngager.Event("approveAdmit",{sessionId:o.sessionId});jQEngager(document).trigger(t)}if("rejectAdmit"===o.type&&sessionId==o.approveSessionId&&!queryString.isAdmin){t=jQEngager.Event("rejectAdmit",{sessionId:o.sessionId});jQEngager(document).trigger(t)}if("endCall"===o.type&&sessionId!==o.sessionId&&o.roomId===roomId&&setTimeout(function(){var e=visitorRinging.indexOf(o.sessionId);if(-1!==e&&visitorRinging.splice(e,1),0==videoConnection.getAllParticipants().length&&0==visitorRinging.length){var t=jQEngager.Event("CallEnded");jQEngager(document).trigger(t)}},200),"remoteVideoUnmuted"===o.type&&sessionId!==o.sessionId&&o.roomId===roomId){t=jQEngager.Event("RemoteVideoUnmuted",{sessionId:o.sessionId});jQEngager(document).trigger(t)}if("startScreenShare"===o.type&&o.roomId===roomId)if(queryString.broadcast){t=jQEngager.Event("VoiceSpeaking",{id:o.sessionId});jQEngager(document).trigger(t)}else sessionId!==o.sessionId&&e.startScreenConnection(!1,o.sessionId);if("remoteVideoMuted"===o.type&&sessionId!==o.sessionId&&o.roomId===roomId){t=jQEngager.Event("RemoteVideoMuted",{sessionId:o.sessionId});jQEngager(document).trigger(t)}if("remoteAudioUnmuted"===o.type&&sessionId!==o.sessionId&&o.roomId===roomId){t=jQEngager.Event("RemoteAudioUnmuted",{sessionId:o.sessionId});jQEngager(document).trigger(t)}if("remoteAudioMuted"===o.type&&sessionId!==o.sessionId&&o.roomId===roomId){t=jQEngager.Event("RemoteAudioMuted",{sessionId:o.sessionId});jQEngager(document).trigger(t)}if("revokePriveleges"===o.type&&sessionId==o.sessionId&&o.roomId===roomId){t=jQEngager.Event("RevokePriveleges",{sessionId:o.sessionId});jQEngager(document).trigger(t)}if("grantPriveleges"===o.type&&sessionId==o.sessionId&&o.roomId===roomId){t=jQEngager.Event("GrantPriveleges",{sessionId:o.sessionId});jQEngager(document).trigger(t)}if("blockUser"===o.type&&o.roomId===roomId){t=jQEngager.Event("BlockUser",{sessionId:o.sessionId});jQEngager(document).trigger(t)}if("forceAudioMuted"===o.type&&o.roomId===roomId){t=jQEngager.Event("ForceAudioMuted",{sessionId:o.sessionId});jQEngager(document).trigger(t)}if("forceVideoMuted"===o.type&&o.roomId===roomId){t=jQEngager.Event("ForceVideoMuted",{sessionId:o.sessionId});jQEngager(document).trigger(t)}if("forceAudioMutedAll"===o.type&&o.roomId===roomId){t=jQEngager.Event("ForceAudioMutedAll");jQEngager(document).trigger(t)}if("forceDelete"===o.type&&o.roomId===roomId){connection.leave();t=jQEngager.Event("ForceDelete",{sessionId:o.sessionId});jQEngager(document).trigger(t)}if("forceDeleteAll"===o.type&&sessionId!==o.sessionId&&o.roomId===roomId){connection.leave();t=jQEngager.Event("ForceDeleteAll");jQEngager(document).trigger(t)}if("setPresent"===o.type&&o.roomId===roomId){t=jQEngager.Event("SetPresent",{sessionId:o.sessionId,present:o.present});jQEngager(document).trigger(t)}if("endMeeting"===o.type&&o.roomId===roomId){t=jQEngager.Event("EndMeeting",{sessionId:o.sessionId});jQEngager(document).trigger(t)}if("adminOnline"===o.type&&(o.roomId===roomId||"admin"==o.role)){t=jQEngager.Event("AdminOnline");jQEngager(document).trigger(t)}if("toVideo"===o.type&&sessionId!==o.sessionId&&o.roomId===roomId){t=jQEngager.Event("ToVideo");jQEngager(document).trigger(t)}if("startRecording"===o.type&&sessionId!==o.sessionId&&o.roomId===roomId){t=jQEngager.Event("RemoteStartRecording");jQEngager(document).trigger(t)}if("stopRecording"===o.type&&sessionId!==o.sessionId&&o.roomId===roomId){t=jQEngager.Event("RemoteStopRecording");jQEngager(document).trigger(t)}if("rejectCall"===o.type&&sessionId!==o.sessionId&&o.roomId===roomId){var n=visitorRinging.indexOf(o.sessionId);if(-1!==n&&visitorRinging.splice(n,1),0==visitorRinging.length){t=jQEngager.Event("CallEnded");jQEngager(document).trigger(t)}}if("setCallerInfo"===o.type){if(sessionId!==o.sessionId&&o.roomId===roomId){t=jQEngager.Event("CallerInfo",{sessionId:o.sessionId,callerInfo:o.callerInfo,isAdmin:o.isAdmin});jQEngager(document).trigger(t)}participantsAll[o.roomId]||(participantsAll[o.roomId]=[]);var i={sessionId:o.sessionId,name:o.callerInfo.name,ua:o.ua};participantsAll[o.roomId].some(e=>e.sessionId===o.sessionId)?(participantsAll[o.roomId].splice(participantsAll[o.roomId].findIndex(e=>e.sessionId===o.sessionId),1),participantsAll[o.roomId].push(i)):participantsAll[o.roomId].push(i)}if("clearCanvas"===o.type&&sessionId!==o.sessionId&&o.roomId===roomId&&lsDesigner&&lsDesigner.clearCanvas(),"sendCallerBack"===o.type&&o.roomId===roomId){t=jQEngager.Event("SendCallerBack",{access:o.access,sessionId:o.sessionId});jQEngager(document).trigger(t)}if(o.participants&&videoConnection&&!videoConnection.isInitiator&&!videoConnection.extra.broadcaster&&o.roomId==roomId&&o.participants.forEach(function(e){e.pid!==videoConnection.userid&&-1===videoConnection.getAllParticipants().indexOf(e.pid)&&(videoConnection.extra.broadcaster||!1!==e.broadcaster)&&videoConnection.join(e.pid,function(e,o,t){})}),o.giveAllParticipants&&videoConnection&&videoConnection.isInitiator&&o.roomId==roomId){var r=[];videoConnection.getAllParticipants().forEach(function(e){r.push({pid:e,broadcaster:!0===videoConnection.peers[e].extra.broadcaster})}),connection.socket.emit(connection.socketCustomEvent,{participants:r}),toggleError(smartVideoLocale.msgStore.broadcastViewers+" "+r.length,5e3),$("#wd-widget-content-whiteboard").is(":visible")&&lsDesigner&&lsDesigner.sync()}}),connection.checkPresence(roomId,function(e,o){!0===e?connection.join(roomId,function(e,o,t){queryString.isAdmin&&socket.emit(connection.socketCustomEvent,{type:"adminOnline",role:"popup",sessionId:sessionId,roomId:roomId}),svConfigs.videoScreen.enableLogs&&console.log("joined to "+o),t&&location.reload()}):connection.open(roomId,function(e,o,t){queryString.isAdmin&&socket.emit(connection.socketCustomEvent,{type:"adminOnline",role:"popup",sessionId:sessionId,roomId:roomId}),t&&location.reload()}),"admin"===role&&(connection.isInitiator=!0)})})},this.renegotiate=function(e){facingMode="user"===facingMode?"environment":"user",navigator.mediaDevices.getUserMedia({video:{facingMode:facingMode},audio:audio_on}).then(function(e){!function(e,o){o?videoConnection.lastCamera||(videoConnection.lastCamera=videoConnection.attachStreams[0]):videoConnection.lastCamera=e;videoConnection.getAllParticipants().forEach(function(o){var t=videoConnection.peers[o].peer;if(t.getSenders){var n=e.clone().getVideoTracks()[0],i=e.clone().getAudioTracks()[0];t.getSenders().forEach(function(e){e&&e.track&&("video"===e.track.kind&&n?(e.track.id!=n.id&&e.replaceTrack(n),n=null):"audio"===e.track.kind&&i&&(e.track.id!=i.id&&e.replaceTrack(i),i=null))})}})}(e)}),videoConnection.streamEvents.selectAll({local:!0}).forEach(function(e){e.stream.isAudio&&e.stream.getAudioTracks()[0].stop(),e.stream.isVideo&&e.stream.getVideoTracks()[0].stop()}),videoConnection.attachStreams.forEach(function(e){e.stop()}),streamConstraints={video:e?{deviceId:{exact:e}}:{facingMode:facingMode},audio:audio_on},videoConnection.mediaConstraints=streamConstraints,videoConnection.session={video:!0,audio:audio_on},videoConnection.checkPresence(roomId,function(e,o){!0===e?videoConnection.join(roomId+"_video",function(e,o,t){t&&location.reload()}):videoConnection.open(roomId+"_video",function(e,o,t){t&&location.reload()})})},this.checkUserMediaSupport=function(){return!!(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia)},this.initCall=function(o,t,n,i,r,s,a){if(e.checkUserMediaSupport()){videoConnection.extra.roomOwner=!0;var d=o||("initVideo"===this.id?"Video":"Audio"),c=r?{deviceId:{exact:r}}:{};audio_on||(c=!1),a&&jQEngager.extend(!0,c,a);var l=n?{deviceId:{exact:n}}:{facingMode:facingMode};switch(s&&jQEngager.extend(!0,l,s),d){case"Video":var u=!0;streamConstraints={video:l,audio:c};break;case"Audio":u=!1,streamConstraints={audio:c,video:!1};break;default:u=!0,streamConstraints={video:l,audio:c}}if(queryString.broadcast){var m=function(){queryString.isAdmin&&svConfigs.videoScreen.videoFileStream?(videoConnection.dontCaptureUserMedia=!0,videoConnection.attachStreams=[localVideoStream],videoConnection.extra.broadcaster=!0,videoConnection.openOrJoin(roomId+"_video",function(e,o,t){if(t)console.error("openOrJoin",t,o);else{var n=jQEngager.Event("LocalVideoStarted");jQEngager(document).trigger(n)}})):(videoConnection.session={audio:!(!queryString.isAdmin&&!localStorage.getItem("hasPrivileges")),video:!!queryString.isAdmin,broadcast:!0},videoConnection.mediaConstraints={audio:!(!queryString.isAdmin&&!localStorage.getItem("hasPrivileges"))&&c,video:!!queryString.isAdmin&&l},queryString.isAdmin||localStorage.getItem("hasPrivileges")?(videoConnection.extra.broadcaster=!0,videoConnection.openOrJoin(roomId+"_video",function(e,o,t){t&&console.error("openOrJoin",t,o)})):(videoConnection.extra.roomOwner=!1,e.joinBroadcastLooper()))};videoConnection.DetectRTC.load(function(){var e=[];if(videoConnection.DetectRTC.videoInputDevices.forEach(function(o){var t={};t.value=o.id,t.text=o.label,e.push(t)}),0===videoConnection.DetectRTC.videoInputDevices.length){var o=jQEngager.Event("VideoRemoved");jQEngager(document).trigger(o),socket.emit(connection.socketCustomEvent,{type:"remoteVideoMuted",role:role,tenant:tenant,sessionId:i,roomId:roomId})}if(0===videoConnection.DetectRTC.audioInputDevices.length){o=jQEngager.Event("AudioRemoved");jQEngager(document).trigger(o),socket.emit(connection.socketCustomEvent,{type:"remoteAudioMuted",role:role,tenant:tenant,sessionId:i,roomId:roomId})}if(videoConnection.DetectRTC.videoInputDevices){o=jQEngager.Event("MediaDevices",{devices:e});jQEngager(document).trigger(o)}if(svConfigs.videoScreen.videoFileStream){var t=document.getElementById("localVideo");function n(){localVideoStream||(t.captureStream?(localVideoStream=t.captureStream(),m()):t.mozCaptureStream&&(localVideoStream=t.mozCaptureStream(),m()))}t.setAttribute("volume",0),t.setAttribute("autoplay",""),t.setAttribute("muted",""),t.setAttribute("loop",""),t.setAttribute("playsinline",""),t.setAttribute("src",svConfigs.videoScreen.videoFileStream),t.oncanplay=n,t.readyState>=3&&n()}else m()})}else{videoConnection.DetectRTC.load(function(){var o=[];if(videoConnection.DetectRTC.videoInputDevices.forEach(function(e){var t={};t.value=e.id,t.text=e.label,o.push(t)}),0===videoConnection.DetectRTC.videoInputDevices.length){var n=jQEngager.Event("VideoRemoved");jQEngager(document).trigger(n),socket.emit(connection.socketCustomEvent,{type:"remoteVideoMuted",role:role,tenant:tenant,sessionId:i,roomId:roomId})}if(0===videoConnection.DetectRTC.audioInputDevices.length){n=jQEngager.Event("AudioRemoved");jQEngager(document).trigger(n),socket.emit(connection.socketCustomEvent,{type:"remoteAudioMuted",role:role,tenant:tenant,sessionId:i,roomId:roomId})}if(videoConnection.DetectRTC.videoInputDevices){n=jQEngager.Event("MediaDevices",{devices:o});jQEngager(document).trigger(n)}streamConstraints.video=!!video_on&&streamConstraints.video,streamConstraints.audio=!!audio_on&&streamConstraints.audio,videoConnection.mediaConstraints=streamConstraints,videoConnection.session={video:!!video_on&&u,audio:audio_on},video_on||(videoConnection.session.oneway=!0),videoConnection.checkPresence(roomId+"_video",function(o,n){if(!0===o?videoConnection.join(roomId+"_video",function(o,t,n){n&&(e.handleCallTermination(),videoConnection.closeEntireSession(function(){videoConnection.openOrJoin(roomId+"_video")}))}):videoConnection.open(roomId+"_video",function(o,t,n){n&&(svConfigs.videoScreen.enableLogs&&console.log(n),e.handleCallTermination(),videoConnection.closeEntireSession(function(){videoConnection.openOrJoin(roomId+"_video")}))}),!video_on){var r=jQEngager.Event("LocalVideoStarted");jQEngager(document).trigger(r)}"simple"==conferenceStyle&&socket.emit(connection.socketCustomEvent,{type:"initCall",role:role,tenant:tenant,autoaccept:t,sessionId:i,roomId:roomId}),connection.getAllParticipants().forEach(function(e){visitorRinging.push(e)})})})}}else{var g=jQEngager.Event("NotSupportedBrowser");jQEngager(document).trigger(g)}},this.leave=function(){connection.getAllParticipants().forEach(function(e){connection.disconnectWith(e)})},this.customerHere=function(e){socket.emit(connection.socketCustomEvent,{type:"customerHere",name:e,role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})},this.customerOut=function(e){socket.emit(connection.socketCustomEvent,{type:"customerOut",name:e,role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})},this.askAdmit=function(e){socket.emit(connection.socketCustomEvent,{type:"askAdmin",name:e,role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})},this.approveAdmit=function(e){socket.emit(connection.socketCustomEvent,{type:"approveAdmit",approveSessionId:e,role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})},this.rejectAdmit=function(e){socket.emit(connection.socketCustomEvent,{type:"rejectAdmit",approveSessionId:e,role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})},this.toggleAudio=function(){var e=1,o=1;videoConnection.attachStreams.forEach(function(t){t.getAudioTracks().forEach(function(t){e=t.enabled=!t.enabled,o=0})}),1==o&&(videoConnection.mediaConstraints.audio=!0,videoConnection.addStream({audio:!0}));var t=e?"AudioUnmuted":"AudioMuted",n=e?"remoteAudioUnmuted":"remoteAudioMuted",i=jQEngager.Event(t);jQEngager(document).trigger(i),socket.emit(connection.socketCustomEvent,{type:n,role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})},this.toggleVideo=function(){var e=1,o=1;videoConnection.attachStreams.forEach(function(t){t.getVideoTracks().forEach(function(t){e=t.enabled=!t.enabled,o=0})}),1==o&&(videoConnection.mediaConstraints.video=!0,videoConnection.addStream({video:!0}),videoConnection.session.oneway=!1);var t=e?"VideoUnmuted":"VideoMuted",n=e?"remoteVideoUnmuted":"remoteVideoMuted",i=jQEngager.Event(t);jQEngager(document).trigger(i),socket.emit(connection.socketCustomEvent,{type:n,role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})},this.joinBroadcast=function(){videoConnection.streamEvents.selectAll({local:!0}).forEach(function(e){e.stream.isAudio&&e.stream.getAudioTracks()[0].stop(),e.stream.isVideo&&e.stream.getVideoTracks()[0].stop()}),videoConnection.attachStreams.forEach(function(e){e.stop()}),videoConnection.mediaConstraints.video=svConfigs.videoScreen.broadcastAttendeeVideo,videoConnection.mediaConstraints.audio=!0,videoConnection.addStream({video:svConfigs.videoScreen.broadcastAttendeeVideo,audio:!0}),videoConnection.session.oneway=!1,svConfigs.videoScreen.allowOtherSee&&(videoConnection.extra.broadcaster=!0,videoConnection.openOrJoin(roomId+"_video",function(e,o,t){if(t)console.error("openOrJoin",t,o);else if(!videoConnection.isInitiator){var n=videoConnection.dontCaptureUserMedia;videoConnection.dontCaptureUserMedia=!0,videoConnection.open(videoConnection.userid,function(e,o,t){t?console.error("open",t,o):(videoConnection.dontCaptureUserMedia=n,videoConnection.isInitiator=!1)})}}))},this.revokeBroadcast=function(){videoConnection.streamEvents.selectAll({local:!0}).forEach(function(e){e.stream.isAudio&&e.stream.getAudioTracks()[0].stop(),e.stream.isVideo&&e.stream.getVideoTracks()[0].stop()}),videoConnection.attachStreams.forEach(function(e){e.stop()}),videoConnection.mediaConstraints.video=!1,videoConnection.mediaConstraints.audio=!1,videoConnection.addStream({video:!1,audio:!1}),videoConnection.session.oneway=!0,document.getElementById("localVideo").srcObject=null},this.answerCall=function(o,t,n,i,r,s){var a=i?{deviceId:{exact:i}}:{};if(s&&jQEngager.extend(!0,a,s),o)var d=n?{deviceId:{exact:n}}:{facingMode:facingMode};else d=!1;r&&jQEngager.extend(!0,d,r),streamConstraints={video:d,audio:a},videoConnection.session={video:o,audio:!0},videoConnection.mediaConstraints=streamConstraints,t&&setTimeout(function(){videoConnection.openOrJoin(roomId+"_video",function(o,t,n){n&&(e.handleCallTermination(),location.reload())})},200)},this.handleCallTermination=function(){videoConnection&&"conference"!=conferenceStyle&&(videoConnection.streamEvents.selectAll({local:!0}).forEach(function(o){o.stream.isAudio&&(o.stream.getAudioTracks()[0].stop(),e.getTracks(o.stream,"audio").forEach(function(e){o.stream.removeTrack(e)})),o.stream.isVideo&&(o.stream.getVideoTracks()[0].stop(),e.getTracks(o.stream,"video").forEach(function(e){o.stream.removeTrack(e)}))}),videoConnection.attachStreams.forEach(function(e){e.stop()}),0==videoConnection.getAllParticipants().length?videoConnection.closeSocket():videoConnection.leave())},this.reconnectWebsocket=function(o){forceClose||(svConfigs.videoScreen.enableLogs&&console.log("WebSocketClient reconnecting in "+autoReconnectInterval,o),setTimeout(function(){svConfigs.videoScreen.enableLogs&&console.log("WebSocketClient: reconnecting..."),e.connect()},autoReconnectInterval))},this.getRoomId=function(){return roomId},this.checkMediaDevices=function(){videoConnection.DetectRTC.load(function(){var e=[];videoConnection.DetectRTC.videoInputDevices.forEach(function(o){var t={};t.value=o.id,t.text=o.label,e.push(t)});var o=jQEngager.Event("MediaDevices",{devices:e});jQEngager(document).trigger(o)})},this.getParticipants=function(){return connection.getAllParticipants()},this.getVideoSessions=function(){return videoConnection?videoConnection.getAllParticipants().length:0},this.getTracks=function(e,o){return e&&e.getTracks?e.getTracks().filter(function(e){return e.kind===(o||"audio")}):[]},this.addStreamStopListener=function(e,o){e.addEventListener("ended",function(){o(),o=function(){}},!1),e.addEventListener("inactive",function(){o(),o=function(){}},!1),e.getTracks().forEach(function(e){e.addEventListener("ended",function(){o(),o=function(){}},!1),e.addEventListener("inactive",function(){o(),o=function(){}},!1)})},this.addToJoinScreenShare=function(){screenConnection&&screenConnection.checkPresence(roomId+"_screen",function(e,o,t){setTimeout(function(){screenConnection.isInitiator=!1,screenConnection.extra.sessionId!==sessionId&&(screenConnection.extra={sessionId:sessionId}),e&&screenConnection.join(roomId+"_screen",function(e,o,t){t&&console.error("join",t,roomId+"_screen")})},1e3)})},this.startScreenShareConf=function(){e.startScreenConnection(!0,sessionId)},this.screenHelper=function(e){if(svConfigs.videoScreen.screenConstraint)var o=svConfigs.videoScreen.screenConstraint;else o={mandatory:{maxWidth:screen.width>1920?screen.width:1920,maxHeight:screen.height>1080?screen.height:1080},optional:[]};navigator.mediaDevices.getDisplayMedia?navigator.mediaDevices.getDisplayMedia(o).then(function(o){e(o)},function(e){var o=jQEngager.Event("ScreenShareEnded");jQEngager(document).trigger(o)}):navigator.getDisplayMedia?navigator.getDisplayMedia(o).then(function(o){e(o)},function(e){var o=jQEngager.Event("ScreenShareEnded");jQEngager(document).trigger(o)}):toggleNotification("getDisplayMedia API is not available in this browser.",!0)};var o=!1;this.getScreenStream=function(t){e.screenHelper(function(n){RMCMediaTrack.screen=e.getTracks(n,"video")[0],RMCMediaTrack.selfVideo.srcObject=n,function e(){"ended"!==RMCMediaTrack.screen.readyState?setTimeout(e,1e3):RMCMediaTrack.screen.onended()}(),o=!1,RMCMediaTrack.screen.onended=function(){var o=jQEngager.Event("ScreenShareStopped");jQEngager(document).trigger(o),e.handleScreenShareTermination()},t(n)})},this.replaceTrack=function(e){e&&"ended"!==e.readyState&&videoConnection.getAllParticipants().forEach(function(o){var t=videoConnection.peers[o].peer;if(t.getSenders){var n=e;t.getSenders().forEach(function(e){e&&e.track&&"video"===e.track.kind&&n&&(e.replaceTrack(n),n=null)})}})},this.startScreenShare=function(){RMCMediaTrack.cameraStream?e.getScreenStream(function(o){videoConnection.getAllParticipants().length>0&&e.replaceTrack(RMCMediaTrack.screen),videoConnection.attachStreams.forEach(function(o){e.getTracks(o,"video").forEach(function(e){o.removeTrack(e)}),o.addTrack(RMCMediaTrack.screen)})}):(videoConnection.mediaConstraints.screen=!0,videoConnection.addStream({video:!0,screen:!0}),videoConnection.extra.screen=!0),socket.emit(connection.socketCustomEvent,{type:"startScreenshare",role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})},this.rejectCall=function(){socket.emit(connection.socketCustomEvent,{type:"rejectCall",role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})},this.stopRecording=function(){},this.getSessionId=function(){return sessionId},this.getRemoteSessionId=function(){return""},this.getVideoStream=function(){var e=!1;return videoConnection?videoConnection.attachStreams.forEach(function(o){o.getVideoTracks().forEach(function(o){e=o.enabled})}):e=!1,e},this.getStream=function(){return!!videoConnection&&videoConnection.getAllParticipants().length>0},this.getRemoteStream=function(e){var o;return videoConnection&&Object.keys(videoConnection.streamEvents).forEach(function(t){var n=videoConnection.streamEvents[t];if(n.stream&&n.extra.sessionId==e)return o=n.stream,!1}),o},this.endCall=function(o){socket.emit(connection.socketCustomEvent,{type:"endCall",role:role,tenant:tenant,sessionId:sessionId,roomId:roomId,msg:o}),videoConnection&&(videoConnection.streamEvents.selectAll({local:!0}).forEach(function(o){o.stream.isAudio&&(o.stream.getAudioTracks()[0]&&o.stream.getAudioTracks()[0].stop(),e.getTracks(o.stream,"audio").forEach(function(e){o.stream.removeTrack(e)})),o.stream.isVideo&&(o.stream.getVideoTracks()[0]&&o.stream.getVideoTracks()[0].stop(),e.getTracks(o.stream,"video").forEach(function(e){o.stream.removeTrack(e)}))}),videoConnection.leave())},this.setMute=function(e){socket.emit(connection.socketCustomEvent,{type:"forceAudioMuted",role:role,tenant:tenant,sessionId:e,roomId:roomId})},this.setVideoOff=function(e){socket.emit(connection.socketCustomEvent,{type:"forceVideoMuted",role:role,tenant:tenant,sessionId:e,roomId:roomId})},this.setMuteAll=function(){socket.emit(connection.socketCustomEvent,{type:"forceAudioMutedAll",role:role,tenant:tenant,roomId:roomId})},this.setDelete=function(e){socket.emit(connection.socketCustomEvent,{type:"forceDelete",role:role,tenant:tenant,sessionId:e,roomId:roomId})},this.setClose=function(){forceClose=!0,connection.closeEntireSession()},this.setPresentUser=function(e,o){socket.emit(connection.socketCustomEvent,{type:"setPresent",role:role,tenant:tenant,present:o,sessionId:e,roomId:roomId})},this.setDeleteAll=function(e){socket.emit(connection.socketCustomEvent,{type:"forceDeleteAll",role:role,tenant:tenant,sessionId:e,roomId:roomId})},this.revokePriveleges=function(e){socket.emit(connection.socketCustomEvent,{type:"revokePriveleges",role:role,tenant:tenant,sessionId:e,roomId:roomId})},this.blockUser=function(e){socket.emit(connection.socketCustomEvent,{type:"blockUser",role:role,tenant:tenant,sessionId:e,roomId:roomId})},this.endMeeting=function(e){socket.emit(connection.socketCustomEvent,{type:"endMeeting",role:role,tenant:tenant,sessionId:e,roomId:roomId})},this.toVideo=function(){socket.emit(connection.socketCustomEvent,{type:"toVideo",role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})},this.grantPriveleges=function(e){socket.emit(connection.socketCustomEvent,{type:"grantPriveleges",role:role,tenant:tenant,sessionId:e,roomId:roomId})},this.getScreenStreamConnections=function(){return!!screenConnection&&screenConnection.getAllParticipants().length>0},this.startRecording=function(){socket.emit(connection.socketCustomEvent,{type:"startRecording",role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})},this.stopRecording=function(){socket.emit(connection.socketCustomEvent,{type:"stopRecording",role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})},this.setCallerInfo=function(e,o){socket.emit(connection.socketCustomEvent,{type:"setCallerInfo",role:role,tenant:tenant,sessionId:sessionId,roomId:roomId,callerInfo:e,isAdmin:o,ua:navigator.userAgent}),connection.extra={role:role,name:name,tenant:tenant,sessionId:sessionId,roomId:roomId,isAdmin:queryString.isAdmin||"admin"==role?1:0,pass:requirePassComm,callerInfo:e}},this.sendCallerBack=function(e,o){socket.emit(connection.socketCustomEvent,{type:"sendCallerBack",role:role,tenant:tenant,sessionId:o,roomId:roomId,access:e})},this.handleScreenShareTermination=function(){if(queryString.broadcast||!svConfigs.videoScreen.separateScreenShare){if(o)return;o=!0,RMCMediaTrack.cameraStream&&(e.getTracks(RMCMediaTrack.cameraStream,"video")[0].readyState&&(e.getTracks(RMCMediaTrack.cameraStream,"video").forEach(function(e){RMCMediaTrack.cameraStream.getVideoTracks()[0].stop(),RMCMediaTrack.cameraStream.removeTrack(e)}),RMCMediaTrack.cameraStream.addTrack(RMCMediaTrack.cameraTrack)),RMCMediaTrack.selfVideo.srcObject=RMCMediaTrack.cameraStream,e.replaceTrack(RMCMediaTrack.cameraTrack),videoConnection.attachStreams=[RMCMediaTrack.cameraStream]);var t=jQEngager.Event("ScreenShareEnded");jQEngager(document).trigger(t)}else{if(!screenConnection)return;screenConnection&&screenConnection.streamEvents.selectAll({local:!0}).forEach(function(e){e.stream.getVideoTracks()[0].stop()}),screenConnection.attachStreams.forEach(function(e){e.stop()}),screenConnection.isInitiator=!1,screenConnection.extra={sessionId:null},screenConnection.closeSocket()}},this.addLocalChat=function(e,o,t){e&&e.replace(/ /g,"").length&&(connection.send({chatMessage:e,privateId:t,date:o,sessionId:sessionId}),connection.send({typing:!1}))},this.sendTranslateMessage=function(e){e&&e.replace(/ /g,"").length&&connection.send({translateMessage:e,sessionId:sessionId})},this.sendTyping=function(e){e?connection.send({typing:!0}):connection.send({typing:!1})},this.getFileHTML=function(e){return'<a href="'+(e.url||URL.createObjectURL(e))+'" target="_blank" download="'+e.name+'">Download: <b>'+e.name+"</b></a>"},this.getFullName=function(e){var o=e;return connection.peers[e]&&connection.peers[e].extra&&connection.peers[e].extra.userFullName&&(o=connection.peers[e].extra.userFullName),o},this.sendFile=function(e){recentFile=e,connection.getAllParticipants().length>=1&&(recentFile.userIndex=0,connection.send(recentFile,connection.getAllParticipants()[recentFile.userIndex]))},this.setWhiteboardTools=function(){lsDesigner&&(lsDesigner.destroy(),lsDesigner=null),e.startWhiteboard()},this.whiteboardTools=function(){lsDesigner.setSelected("pencil"),lsDesigner.setTools({line:!0,arrow:!0,pencil:!0,marker:!0,dragSingle:!0,dragMultiple:!0,eraser:!0,pdf:!0,rectangle:!0,arc:!0,text:!0,image:!0,zoom:!0,lineWidth:!0,colorsPicker:!0,extraOptions:!0,undo:!0}),lsDesigner.icons={pencil:lsRepUrl+"img/whiteboard/pencil.png",marker:lsRepUrl+"img/whiteboard/brush.png",eraser:lsRepUrl+"img/whiteboard/eraser.png",text:lsRepUrl+"img/whiteboard/text.png",image:lsRepUrl+"img/whiteboard/image.png",dragSingle:lsRepUrl+"img/whiteboard/dragSingle.png",dragMultiple:lsRepUrl+"img/whiteboard/dragMultiple.png",line:lsRepUrl+"img/whiteboard/line.png",arrow:lsRepUrl+"img/whiteboard/arrow.png",pdf:lsRepUrl+"img/whiteboard/pdf.png",zoom_in:lsRepUrl+"img/whiteboard/zoom_in.png",zoom_out:lsRepUrl+"img/whiteboard/zoom_out.png",arc:lsRepUrl+"img/whiteboard/arc.png",rectangle:lsRepUrl+"img/whiteboard/rectangle.png",lineWidth:lsRepUrl+"img/whiteboard/lineWidth.png",undo:lsRepUrl+"img/whiteboard/undo.png",colorsPicker:lsRepUrl+"img/whiteboard/colorsPicker.png",extraOptions:lsRepUrl+"img/whiteboard/extraOptions.png"}},this.initHark=function(e){if(!window.hark)throw"Please link hark.js";var o=e.connection,t=e.streamedObject,n=hark(e.stream,{});n.on("speaking",function(){o.onspeaking(t)}),n.on("stopped_speaking",function(){o.onsilence(t)})},this.startWhiteboard=function(){if(!lsDesigner){(lsDesigner=new CanvasDesigner).widgetHtmlURL=lsRepUrl+"pages/whiteboard.html",lsDesigner.widgetJsURL=lsRepUrl+"js/whiteboard.widget.js",queryString.isAdmin||svConfigs.whiteboard.allowAnonymous||localStorage.getItem("hasPrivileges")?(e.whiteboardTools(),lsDesigner.addSyncListener(function(e){connection.send({width:screen.width,whiteboardData:e})})):(lsDesigner.setTools({}),lsDesigner.setSelected("")),lsDesigner.pointsLength<=0&&setTimeout(function(){connection.send("plz-sync-points")},1e3);var o=document.getElementById("whiteboard_canvas");lsDesigner.appendTo(o)}setTimeout(function(){lsDesigner.sync()},2e3)},this.clearCanvas=function(){lsDesigner?(lsDesigner.clearCanvas(),socket.emit(connection.socketCustomEvent,{type:"clearCanvas",role:role,tenant:tenant,sessionId:sessionId,roomId:roomId})):e.startWhiteboard(),setTimeout(function(){lsDesigner.sync()},2e3)},this.showStatusBar=function(e,o){jQEngager("#statusbar").html(e),jQEngager("#statusbar").show(),"Connected to the chat server!"==e?jQEngager("#statusIcon").html('<i class="fas fa-fw fa-check-circle" id="statusOk"></i>'):jQEngager("#statusIcon").html('<i class="fas fa-fw fa-times-circle" id="statusNotOk"></i>'),setTimeout(function(){jQEngager("#statusbar").hide()},o)},this.replaceVideoTrack=function(e){videoConnection.streamEvents.selectAll({local:!0}).forEach(function(e){videoConnection.removeStream(e.stream.streamid)}),e?videoConnection.addStream(e):(e=RMCMediaTrack.cameraStream,videoConnection.mediaConstraints.video=!0,videoConnection.addStream({video:!0})),videoConnection.renegotiate(),videoConnection.lastCamera=e,videoConnection.getAllParticipants().forEach(function(o){var t=videoConnection.peers[o].peer;if(t.getSenders){var n=e.clone().getVideoTracks()[0],i=e.clone().getAudioTracks()[0];t.getSenders().forEach(function(e){e&&e.track&&("video"===e.track.kind&&n?(e.track.id!=n.id&&e.replaceTrack(n),n=null):"audio"===e.track.kind&&i&&(e.track.id!=i.id&&e.replaceTrack(i),i=null))})}})}},uiHandler=function(){var e,o,t=this;this.init=function(t,n,i){e=t,n,o=i},this.setMobileChatOnly=function(){(isAndroid||isiPhone)&&e(".wd-v-share").hide(),t.displayChatOnly()},this.setVideoBoxOff=function(o){audio_on=!1,video_on=!1,t.setMuteButton(),t.setVideoButton(),e("#wd-widget-content-"+o+" .wd-video-box-on").hide(),e("#wd-widget-content-video-ringing").hide(),e("#wd-widget-content-video-waiting").hide(),e("#unsupported_div").show()},this.toggleHeaderChat=function(o){e(".header-auido-video").hide()},this.displayScreenShare=function(){svConfigs.videoScreen&&!0===svConfigs.videoScreen.chat?(e(".wd-chat-box").show(),e(".wd-video-box").css("width","70%"),e(".wd-chat-box").css("width","30%")):(e(".wd-chat-box").hide(),e(".wd-video-box").css("width","100%"),e(".wd-video-box").css("border-right",0)),e(".wd-avatar-agent").hide(),e("#mainleft_div").show(),e("#wd-widget-content-whiteboard").hide(),e("#wd-widget-content-video").show()},this.displayVideoOnly=function(){"simple"==conferenceStyle&&svConfigs.videoScreen&&!0===svConfigs.videoScreen.chat?(e(".wd-chat-box").show(),e(".wd-video-box").css("width","70%"),e(".wd-chat-box").css("width","30%")):(e(".wd-chat-box").hide(),e(".wd-video-box").css("width","100%"),e(".wd-video-box").css("border-right",0)),e("#mainleft_div").show(),e("#wd-widget-content-whiteboard").hide(),e("#wd-widget-content-video").show(),e("."+classVideo).each(function(){var o=this.id;e("#"+o).detach().appendTo("#"+videoElementContainer),e("#"+o).removeClass("smallvideo")})},this.displayChatOnly=function(){o.getStream(o.getRemoteSessionId())?(e("#call_audio_video").hide(),e("#slide_video").show()):(e("#slide_video").hide(),svConfigs.videoScreen&&(!1===svConfigs.videoScreen.onlyAgentButtons||queryString.isAdmin)&&e("#call_audio_video").show()),svConfigs.videoScreen&&!0===svConfigs.videoScreen.chat?e(".wd-v-text").hide():e(".wd-v-text").show(),e("#mainleft_div").hide(),e(".wd-chat-box").show(),e(".wd-chat-box").css("width","100%"),e("#wd-widget-content-whiteboard").hide()},this.restoreVideoBox=function(){"conference"==conferenceStyle?(e("#wd-widget-content-greenroom").hide(),e("#wd-widget-content-prev").hide(),isAndroid||isiPhone||(stopFullScreenPopup(),e("#invideo").attr("style","")),e("#invideo").show(),e(".wd-video-c").hide()):(e("#call_audio_video").hide(),isAndroid||isiPhone||(stopFullScreenPopup(),e("#mainleft_div").attr("style","")),e("#mainleft_div").show())},this.syncVideoChatPanelsPos=function(){var o=e("#newdev_video"),t=e("#newdev_chat");e("#newdev_video").is(":visible")?(panel_xpos=o.css("left"),panel_ypos=o.css("top"),t.css("left",panel_xpos),t.css("top",panel_ypos)):e("#newdev_chat").is(":visible")&&(panel_xpos=t.css("left"),panel_ypos=t.css("top"),o.css("left",panel_xpos),o.css("top",panel_ypos))},this.setScreenDisabled=function(o){o?(e(".wd-v-share").addClass("disabled"),e("#screenshare_div").addClass("disabled"),"simple"==conferenceStyle?e("."+classVideo).each(function(){var o=this.id;e("#"+o).detach().appendTo("#small_video"),e("#"+o).addClass("smallvideo")}):e(".bigvideo").hide()):(e(".wd-v-share").removeClass("disabled"),e("#screenshare_div").removeClass("disabled"),"simple"==conferenceStyle?e("."+classVideo).each(function(){var o=this.id;e("#"+o).detach().appendTo("#"+videoElementContainer),e("#"+o).removeClass("smallvideo")}):(e(".bigvideo").show(),e(".sourcevideo").show()))},this.setDisabled=function(o){o?(e("#raisehand_div").addClass("disabled"),e("#exit_meeting").addClass("disabled"),e("#call_video").addClass("disabled"),e("#call_audio").addClass("disabled"),e("#file_transfer").addClass("disabled"),e("#startscreenshare").addClass("disabled"),e("#callButton_1").addClass("disabled"),e("#callAudioButton_1").addClass("disabled"),e("#newdev_chat_message1").addClass("disabled"),e("#whiteboard").addClass("disabled"),e("#startVideoButton").addClass("disabled"),e(".startVideoButton").addClass("disabled"),e("#answer_call_button").addClass("disabled"),e("#answer_audiocall_button").addClass("disabled"),e("#reject_call_button").addClass("disabled"),e(".wd-v-share").addClass("disabled")):(e("#raisehand_div").removeClass("disabled"),e("#exit_meeting").removeClass("disabled"),e("#call_video").removeClass("disabled"),e("#call_audio").removeClass("disabled"),e("#startscreenshare").removeClass("disabled"),e("#file_transfer").removeClass("disabled"),(queryString.room||queryString.broadcast)&&e("#callButton_1").removeClass("disabled"),queryString.room&&e("#callAudioButton_1").removeClass("disabled"),e("#newdev_chat_message1").removeClass("disabled"),e("#whiteboard").removeClass("disabled"),e("#startVideoButton").removeClass("disabled"),e(".startVideoButton").removeClass("disabled"),e("#answer_call_button").removeClass("disabled"),e("#answer_audiocall_button").removeClass("disabled"),e("#reject_call_button").removeClass("disabled"),e(".wd-v-share").removeClass("disabled"))},this.toggleWidget=function(){e("#nd_widget_content").toggle(),e(".agent-address-wd").hide(),e("#peer_email_video").toggle(!1)},this.toggleVisitors=function(o){e("#nd_widget_visitors").toggle(o)},this.setAgentOnlyButtons=function(){e(".wd-v-pickupaudio").hide(),e(".wd-v-pickup").hide(),e(".wd-v-share").hide(),e(".header-auido-video").hide(),e("#screenshareLi").hide(),e("#snapshotLi").hide(),e("#recordingLi").hide(),e("#whiteboardLi").hide(),e("#cameraSwitch").hide(),e("#pipLi").hide()},this.disableScreenShare=function(){e(".wd-v-share").hide(),e("#startscreenshare").hide()},this.disableVideo=function(){e("#startVideoButton").hide(),e(".wd-v-pickup").hide(),e("#call_video").hide(),e("#answer_call_button").hide(),e(".muteVideo").prop("checked",!0),e(".muteVideo").hide(),e(".turnOffCamera").hide()},this.disableAudio=function(){e(".wd-v-pickupaudio").hide(),e("#call_audio").hide(),e("#answer_audiocall_button").hide(),e(".muteAudio").prop("checked",!0),e(".muteAudio").hide(),e(".muteMe").hide()},this.disableWhiteboard=function(){e("#whiteboard").hide()},this.disableTransfer=function(){e("#file_transfer").hide()},this.setVideoBox=function(){e("#recordingIcon").hide(),e("#newdev_video").show(),e("#mainleft_div").children().hide(),e("#video_container").show(),e("#video_container_oneway").hide(),e("#video_container_oneway_agent").hide(),e(".wd-v-nosound").removeClass("disabledDiv"),e("#video_back").show()},this.setOneWay=function(){e("#localVideo").hide(),e("#video_container_oneway").show(),e("#local_video_div").hide(),e(".wd-v-video").attr("class","wd-v-novideo"),e(".wd-v-novideo").addClass("disabledDiv"),e(".wd-v-sound").attr("class","wd-v-nosound"),e(".wd-v-nosound").addClass("disabledDiv")},this.togglePermissionError=function(){t.syncVideoChatPanelsPos(),t.togglePermissionWidget(!1),t.setVideoBox(),e("#permission_browsers_error").children().hide(),isChrome&&e("#permission_div_error_chrome").show(),isFirefox&&e("#permission_div_error_firefox").show(),e("#wd-widget-error").show(),t.setVideoButton()},this.toggleInstaWhiteboard=function(){window.resizeTo(window.screen.availWidth,window.screen.availHeight),stopIncomingCall(),t.syncVideoChatPanelsPos(),e("#mainleft_div").show(),"simple"==conferenceStyle&&svConfigs.videoScreen&&!0===svConfigs.videoScreen.chat?(e(".wd-chat-box").show(),e(".wd-chat-box").css("width","30%"),e(".wd-video-box").css("width","70%"),e(".wd-video-box").css("border-right",0),e(".wd-v-text").hide()):(e(".wd-chat-box").hide(),e(".wd-video-box").css("width","100%"),e(".wd-video-box").css("border-right",0),e(".wd-v-text").show()),e("#wd-widget-content-whiteboard").show(),e("#wd-widget-content-chat-main").hide(),e("#wd-widget-content-video").hide(),e("#wd-avatar-agent").hide(),e("#video_container_chat").hide(),queryString.isAdmin||localStorage.getItem("hasPrivileges")||svConfigs.whiteboard.allowAnonymous?(e(".wd-v-tovideo").show(),e("#cleanCanvas").show(),e("#downloadCanvas").show(),e("#whiteboard_canvas iframe").contents().find("#tool-box").show()):e("#whiteboard_canvas iframe").contents().find("#tool-box").hide(),e("."+classVideo).each(function(){var o=this.id;e("#"+o).detach().appendTo("#whiteboard_video"),e("#"+o).addClass("smallvideo")}),e(".bigvideo").each(function(){var o=this.id;e("#"+o).detach().appendTo("#whiteboard_video"),e("#"+o).addClass("smallvideo")}),e(".broadcastvideo").each(function(){e(this).detach().appendTo("#whiteboard_video"),e(this).addClass("smallvideo")})},this.toggleInstaChat=function(){stopIncomingCall(),window.outerHeight==screen.availHeight&&void 0!==widgetSize?stopFullScreenPopup():stopFullScreen(),e(".wd-video-c").removeClass("disabled"),t.syncVideoChatPanelsPos(),t.togglePermissionWidget(!0),t.setVideoBox(),e("#recordingIcon").hide(),e("#wd-widget-content-chat-main").show(),e("#wd-avatar-agent").show(),svConfigs.videoScreen&&!0===svConfigs.videoScreen.chat?e(".wd-v-text").hide():e(".wd-v-text").show(),e(".wd-v-recording").hide(),e("#video_container_chat").hide(),e("#wd-widget-content-whiteboard").hide(),t.setVideoButton(),t.setMuteButton()},this.onIncomingVideo=function(){t.restoreVideoBox()},this.toggleRinging=function(o){t.setMobileChatOnly(),t.displayVideoOnly(),e("#toggle_icon").removeClass("video"),e("#wd-widget-content-video").hide(),e("#wd-widget-content-chat-main").hide(),e("#wd-widget-content-video-waiting").hide(),e("#wd-widget-content-video-ringing").show(),e("#wd-widget-content-whiteboard").hide(),e("#answer_call_button").off(),e("#answer_audiocall_button").off(),e("#reject_call_button").off(),e("#answer_call_button").on("click",function(){video_on=!0,t.setVideoButton(),t.toggleVideoBox(!1),o(!0)}),e("#answer_audiocall_button").on("click",function(){isiPhone?(video_on=!0,video_iphone_on=!1):video_on=!1,t.setVideoButton(),o(!0),t.toggleVideoBox(!1)}),e("#reject_call_button").on("click",function(){o(!1),t.toggleInstaChat()})},this.toggleVideoBox=function(o){stopIncomingCall(),e("#wd-widget-content-chat-main").hide(),e("#wd-widget-content-greenroom").hide(),e("#wd-widget-content-prev").hide(),e("#wd-widget-content-video-ringing").hide(),e("#wd-widget-content-whiteboard").hide(),!0===o?(svConfigs.videoScreen&&!0===svConfigs.videoScreen.chat?(e("#call_audio_video").hide(),e(".wd-v-text").hide()):e(".wd-v-text").show(),e("#wd-widget-content-video").show(),e("#wd-widget-content-video-waiting").hide(),e("."+classVideo).each(function(){var o=this.id;e("#"+o).detach().appendTo("#"+videoElementContainer),e("#"+o).removeClass("smallvideo")})):4==o?(e(".wd-chat-box").hide(),e(".wd-video-box").css("width","100%"),e(".wd-video-box").css("border-right",0),e("#wd-widget-content-greenroom").show(),e("#wd-widget-content-video").hide(),e("#wd-widget-content-video-waiting").hide()):(e("#wd-widget-content-video").hide(),e("#wd-widget-content-video-waiting").show(),"simple"==conferenceStyle&&svConfigs.videoScreen&&!0===svConfigs.videoScreen.chat?(e(".wd-chat-box").show(),e(".wd-video-box").css("width","70%"),e(".wd-chat-box").css("width","30%")):(e(".wd-chat-box").hide(),e(".wd-video-box").css("width","100%"),e(".wd-video-box").css("border-right",0)))},this.setWidgetValues=function(){e("#peer_name_video").html(peer_name),e(".peer_name_video").html(peer_name),e("#peer_name_chat").html(peer_name),e(".dw-chat-avatar").attr("src",peer_avatar),e("#peer_email_video").html(peer_email),e("#peer_email_chat").html(peer_email),e(".agent-address-wd a").attr("href","mailto:"+peer_email),e("#peer_phone_video").html(peer_phone),e("#peer_phone_chat").html(peer_phone);var o=getCurrentTime();e("#timestamp").html(o),peer_avatar?e("#nd_widget_content .peer_avatar").attr("src",peer_avatar):e("#nd_widget_content .peer_avatar").attr("src",lsRepUrl+"img/small-avatar.jpg");var t=document.querySelector(".bg-site4");peer_background&&null!=t&&(t.style.background="url("+peer_background+") no-repeat center center",t.style.backgroundSize="cover"),peer_logo&&(e("#nd_widget_content .firm-logo-wd img").attr("src",peer_logo),e("#nd_widget_content .firm-logo-wd img").width(100),e("#nd_widget_content .firm-logo-wd img").height("auto")),e("#popup_widget_text").html(popup_message)},this.toggleInstaVideo=function(e){t.syncVideoChatPanelsPos(),t.setMuteButton(),t.setVideoBox(),t.setVideoButton(),t.toggleVideoBox(e)},this.togglePermissionWidget=function(o,n,i){isAndroid||(o?(n?e("#wd-widget-content-video-waiting").show():e("#wd-widget-content-video-waiting").hide(),e("#permission_div").hide()):(e("#wd-widget-content-chat-main").hide(),e("#wd-widget-content-video-waiting").hide(),t.permissionDisplay()))},this.toggleMediaErrorWidget=function(o){e("#permission_div_defaultvideo").show(),e("#permission_div_span").html(o),e("#wd-widget-content-video-waiting").hide(),e("#permission_div").show()},this.permissionDisplay=function(){var o=video_on?"video":"";e("#permission_browsers").children().hide(),e("#permission_div_span").show(),isChrome?e("#permission_div_chrome"+o).show():isFirefox?e("#permission_div_firefox"+o).show():isIEA?e("#permission_div_ie"+o).show():isSafariA||isiPhone?e("#permission_div_safari"+o).show():e("#permission_div_default"+o).show(),e("#permission_div_span").html(smartVideoLocale.msgStore.allowMicCamera),e("#wd-widget-content-video-waiting").hide(),e("#permission_div").show()},this.resetCallHoldState=function(){e("#on_hold").hide()},this.setMuteButton=function(){audio_on?(e(".wd-v-nosound").attr("class","wd-v-sound"),e(".fa-microphone-slash").closest("a").addClass("active")):(e(".wd-v-sound").attr("class","wd-v-nosound"),e(".fa-microphone-slash").closest("a").removeClass("active"))},this.setRecordingUi=function(o){o?(e(".wd-v-recording").removeClass("recording-off"),e(".wd-v-recording").addClass("recording-on"),e("#startRecording").addClass("active")):(e(".wd-v-recording").removeClass("recording-on"),e(".wd-v-recording").addClass("recording-off"),e("#startRecording").removeClass("active"))},this.setScreenButton=function(o){!isChrome&&!isFirefox||isAndroid||isiPhone||(o?(e(".wd-v-share").hide(),e(".wd-v-stopshare").show(),e("#startscreenshare").hide(),e("#screensharestop_div").show()):(e(".wd-v-share").show(),e(".wd-v-stopshare").hide(),e("#screensharestop_div").hide(),e("#startscreenshare").show()))},this.setVideoButton=function(){video_on?(e("#local_video_div").show(),e(".wd-v-novideo").attr("class","wd-v-video"),e(".fa-video-camera").closest("a").addClass("active")):(e("#local_video_div").hide(),e(".wd-v-video").attr("class","wd-v-novideo"),e(".fa-video-camera").closest("a").removeClass("active"))},this.showTranslateMessage=function(o){e("#translate_message").css("width",e(".bigvideo.bigvideoadd").css("width")),e("#translate_message").css("bottom",e(".bigvideo.bigvideoadd").css("bottom")),e("#translate_message").show(),e("#translate_message").html(o)},this.setLocalRemote=function(o){e("#localVideo").removeClass("localvideo"),e("#localVideo").addClass(classVideo)},this.setRemoteLocal=function(o){e("#localVideo").removeClass(classVideo),e("#localVideo").addClass("localvideo")},this.changeSpanPostition=function(o){e("#remoteVideoSpan"+o).remove(),setTimeout(function(){var t=e(e("#"+o)).position();if(t&&"localVideo"!=o){var n=names[o]?names[o].name:peer_name,i=e("<h2 />",{id:"remoteVideoSpan"+o,class:"sourcevideospan"});i.css("left",t.left),i.css("top",t.top),i.appendTo($("#video_container_small")),i.html(n)}},0)},this.makeAllSmall=function(){e(".bigvideo").each(function(){if(e(this).is(":visible")&&"conference"===svConfigs.videoScreen.videoContainerStyle){var o=e(this).attr("id");e("#"+o).detach().appendTo("#video_container_small"),e("#"+o).removeClass("bigvideo"),e("#"+o).removeClass("bigvideoadd"),e("#"+o).addClass("sourcevideo")}}),t.changeSpanPositions()},this.makeAllSmallGrid=function(){e(".bigvideogrid").each(function(){if(e(this).is(":visible")&&"conference"===svConfigs.videoScreen.videoContainerStyle){var o=e(this).attr("id");e("#remoteVideoSpan"+o).remove(),e("#"+o).detach().appendTo("#video_container_small"),e("#"+o).removeClass("bigvideogrid"),e("#"+o).removeClass("bigvideoadd"),e("#"+o).addClass("sourcevideo")}}),t.changeSpanPositions()},this.changeSpanPositions=function(){e(".sourcevideospan").remove(),"list"==currentView?(e(".bigvideo").each(function(){if(e(this).is(":visible")&&"conference"===svConfigs.videoScreen.videoContainerStyle){var o=e(this).attr("id");t.changeSpanPostition(o)}}),e(".sourcevideo").each(function(){if(e(this).is(":visible")&&"conference"===svConfigs.videoScreen.videoContainerStyle){var o=e(this).attr("id");t.changeSpanPostition(o)}})):e(".bigvideogrid").each(function(){var o=e(this).attr("id");e("#"+o).css("height","98%"),t.changeSpanPostition(o)})},this.makeBig=function(){e(".sourcevideo").each(function(){var t=e(this).attr("id");e("#fullScreen").show(),e("#"+t).detach().appendTo("#video_container"),e("#"+t).removeClass("sourcevideo"),e("#"+t).addClass("bigvideo"),e("#"+t).addClass("bigvideoadd"),o.getVideoSessions()>1?(e("#"+t).css("height","85%"),e("#"+t).css("height","85%")):(e("#"+t).css("height","98%"),e("#"+t).css("height","98%"))}),t.changeSpanPositions()},this.makeBigGrid=function(){e(".sourcevideo").each(function(){var o=e(this).attr("id");e("#"+o).css("height","98%"),e("#"+o).css("height","98%"),e("#remoteVideoSpan"+o).remove(),e("#fullScreen").show(),e("#"+o).detach().appendTo("#video_container_small"),e("#"+o).removeClass("sourcevideo"),e("#"+o).addClass("bigvideogrid"),e("#"+o).addClass("bigvideoadd")}),t.changeSpanPositions()},this.changeView=function(o){var n=!1;function i(){e(".fa-th-large").closest("a").addClass("active"),currentView="grid",t.makeAllSmall(),e("#video_container_small").removeClass("video_container_small"),e("#video_container_small").addClass("video_container_grid"),e("#localVideo").detach().appendTo("#video_container_small"),e("#localVideo").prependTo("#video_container_small"),e("#localVideo").removeClass("localvideo"),e("#localVideo").removeClass("localvideo"),e("#localVideo").addClass("bigvideogrid"),e("#localVideo").addClass("bigvideoadd"),t.makeBigGrid()}function r(){e(".fa-th-large").closest("a").removeClass("active"),currentView="list",t.makeAllSmallGrid(),e("#localVideo").detach().appendTo("#local_video_div"),e("#video_container_small").removeClass("video_container_grid"),e("#video_container_small").addClass("video_container_small"),e("#localVideo").addClass("localvideo"),e("#localVideo").removeClass("bigvideogrid"),e("#localVideo").removeClass("bigvideoadd"),e("#localVideo").removeClass("sourcevideo"),t.makeAllSmall()}"list"==currentView?o?i():r():o?r():i(),$("video").off("click"),$("video").on("click",function(){var o=$(this).attr("class");if("sourcevideo"==o){var i=e.Event("VoiceSpeaking",{id:this.id});e(document).trigger(i)}else if("bigvideogrid bigvideoadd"==o){n=!0,r();i=e.Event("VoiceSpeaking",{id:this.id});e(document).trigger(i)}else"bigvideo bigvideoadd"==o&&(n?t.changeView(!0):t.makeAllSmall())}),localStorage.setItem("currentView",currentView)}},notifyHandler=function(){var e=this;this.init=function(){e.isNotificationSupported()?"granted"!==Notification.permission&&Notification.requestPermission():console.log("Your browser does not support Notifications.")},jQEngager(document).on("EnterPageNotification",function(o){if(svConfigs.alwaysNotify||!document.hasFocus()){var t=o.name?o.name:"Visitor",n=smartVideoLocale.msgStore.incomingText;n=n.replace("{{caller_name}}",t),e.showNotification(n)}}),jQEngager(document).on("EnterCustomerNotification",function(o){if(svConfigs.alwaysNotify||!document.hasFocus()){var t=o.name?o.name:"Visitor",n=smartVideoLocale.msgStore.userWaitingRoom;n=(n=n.replace("{{user}}",t)).replace("{{room}}",o.roomId),e.showNotification(n)}}),jQEngager(document).on("IncomingCall",function(o){!svConfigs.alwaysNotify&&document.hasFocus()||e.showNotification("Visitor is calling you.")}),this.showNotification=function(o){if(e.isNotificationSupported())if("granted"===Notification.permission){var t=new Notification(o,{icon:lsRepUrl+"/img/logo.png",body:smartVideoLocale.msgStore.clickOpenPage,vibrate:[500,110,500,110,500]});t.onclick=function(){try{window.focus()}catch(e){console.log(e)}},setTimeout(t.close.bind(t),1e4)}else"denied"!==Notification.permission&&Notification.requestPermission().then(function(e){"granted"===e&&(t=new Notification("Hi there!"))});else console.log("Your browser does not support Notifications. Use Latest Chrome/Safari to save the world.")},this.requestPermissions=function(){"granted"!==Notification.permission&&Notification.requestPermission()},this.isNotificationSupported=function(){return"Notification"in window}},popup_instance=null,names=[],popup_message="",widgetSize={width:750,height:564},video_on=!0,audio_on=!0,isOnline=!1,roomAllow=!0,remoteVideoSessions=0,inCall=[],videoCurrentId=0,audioCurrentId=0,audioOutputCurrentId=0,startNextCamera=!1,requirePass=!1,timerVars=[],startedRecroding=!1,is_widget_opened=!1,is_callerback=!1,is_chat_opened=!1,isLsvAdmin=!1,currentView="list",recordingWidth=360,isVirtualBack=!1,isVirtualBlur=!1,isVirtual=!1,main=function(){jQEngager=jQuery;var e=document.currentScript||document.getElementById("newdev-embed-script");if(null==e||null==e){var o=document.getElementsByTagName("script"),t=o.length-1;e=o[t]}jQuery(document).ready(function(o){if(room=e.getAttribute("data-room_id")?e.getAttribute("data-room_id"):queryString.room,lsRepUrl=e.getAttribute("data-source_path"),agentAvatar=peer_avatar=e.getAttribute("data-avatar")?e.getAttribute("data-avatar"):lsRepUrl+"img/small-avatar.jpg",agentName=peer_name=e.getAttribute("data-names")?e.getAttribute("data-names"):svConfigs.agentName,visitorName=e.getAttribute("data-visitorName")?e.getAttribute("data-visitorName"):"",passRoom=e.getAttribute("data-pass")?e.getAttribute("data-pass"):passRoom,datetime=e.getAttribute("data-datetime")?e.getAttribute("data-datetime"):"",duration=e.getAttribute("data-duration")?e.getAttribute("data-duration"):"",agentId=e.getAttribute("data-agentId")?e.getAttribute("data-agentId"):"",isLsvAdmin=e.getAttribute("data-isAdmin")?e.getAttribute("data-isAdmin"):queryString.isAdmin,svConfigs.recording.recordingConstraints&&(recordingWidth=svConfigs.recording.recordingConstraints.width,recordingHeight=svConfigs.recording.recordingConstraints.height),(comm_controller=new comController).init("popup",room),(notify_handler=new notifyHandler).init(),localStorage.getItem("prd")){var t=localStorage.getItem("prd");t=JSON.parse(t),queryString.isAdmin?agentName=agentName||t.name:visitorName=visitorName||t.name}localStorage.getItem("facingMode")&&(facingMode=localStorage.getItem("facingMode")),localStorage.setItem("facingMode",facingMode),localStorage.getItem("currentView")&&(currentView=localStorage.getItem("currentView")),localStorage.setItem("currentView",currentView),videoSource=localStorage.getItem("videoSource")?localStorage.getItem("videoSource"):void 0,videoCurrentId=localStorage.getItem("videoCurrentId")?parseInt(localStorage.getItem("videoCurrentId")):0,token=queryString.token?queryString.token:"",disableVideo=!!e.getAttribute("data-disableVideo"),disableAudio=!!e.getAttribute("data-disableAudio"),disableScreenShare=!!e.getAttribute("data-disableScreenShare"),disableWhiteboard=!!e.getAttribute("data-disableWhiteboard"),disableTransfer=!!e.getAttribute("data-disableTransfer"),autoAcceptVideo=!!e.getAttribute("data-autoAcceptVideo"),autoAcceptAudio=!!e.getAttribute("data-autoAcceptAudio"),"conference"==conferenceStyle&&(widgetSize={width:800,height:600}),svConfigs.serverSide&&svConfigs.serverSide.agentInfo&&agentId&&o.ajax({type:"POST",timeout:5e3,url:lsRepUrl+"server/script.php",data:{type:"getagent",tenant:agentId}}).done(function(e){e&&(e=JSON.parse(e),agentName=e.first_name+" "+e.last_name)}).fail(function(){}),(isiPhone||isAndroid)&&(svConfigs.videoScreen.chat=!1),svConfigs.videoScreen&&!0===svConfigs.videoScreen.chat&&(widgetSize.width=1052);var n=o("<div>",{class:"nd-widget-container_lead",id:"newdev-widget"});o(document).on("AdminPopupOffline",function(e){isOnline=!1,svConfigs.serverSide.videoLogs&&saveLog("end",agentId,"audio: "+audio_on+", video: "+video_on,comm_controller.getSessionId())}),o(document).on("VisitorsRoom",function(e){visitors=e.count}),o(window).on("unload",function(){f()}),o(window).on("resize",function(){ui_handler.changeSpanPositions()});var i=function(e){if(names[e.sessionId]||(names[e.sessionId]={}),e.callerInfo.name&&names[e.sessionId]&&names[e.sessionId].name!==e.callerInfo.name){if(names[e.sessionId].username)var t=names[e.sessionId].username;names[e.sessionId]={name:e.callerInfo.name,email:e.callerInfo.email},t&&(names[e.sessionId].username=t),e.callerInfo.isAdmin&&agentName&&(names[e.sessionId].name=agentName),o("#peer_name_chat").text(names[e.sessionId].name),function(e){var t=smartVideoLocale.msgStore.incomingText;if(t&&names[e.sessionId]&&o("#incoming_text").html(t.replace("{{caller_name}}",names[e.sessionId].name)),e.sessionId!==comm_controller.getSessionId()){var n=smartVideoLocale.msgStore.joinedChat;if(n&&-1==names[e.sessionId].name.indexOf(svConfigs.anonVisitor)){var i=n.replace("{{caller_name}}",names[e.sessionId].name);svConfigs.videoScreen&&svConfigs.videoScreen.waitingRoom?toggleError(i,5e3):(showMessage("",i,null,"joinedChat"),svConfigs.serverSide.chatHistory&&saveChat(i,"","joinedChat",agentId,"",names))}}}(e)}var n=e.callerInfo.avatar?e.callerInfo.avatar:lsRepUrl+"img/small-avatar.jpg";names[e.sessionId]&&(names[e.sessionId].avatar=n,names[e.sessionId].priv=e.callerInfo.priv,e.callerInfo.username&&(names[e.sessionId].username=e.callerInfo.username)),names[e.sessionId].muted=e.callerInfo.muted,names[e.sessionId].video=e.callerInfo.video,names[e.sessionId].isAdmin=!!e.callerInfo.isAdmin&&e.callerInfo.isAdmin,e.callerInfo.isAdmin&&agentName&&(names[e.sessionId].name=agentName),o(".dw-chat-avatar").attr("src",n),"conference"!==conferenceStyle&&o(".direct-chat-img left "+guestName(e.callerInfo.name)).attr("src",n),u(),r()},r=function(){if("conference"==conferenceStyle){o("#attendeesList").empty();var e=0;for(var t in names){var n="";t==comm_controller.getSessionId()&&(n=" (Me) ");var i="",s="",a="",d="",c=o("ul#attendeesList");if("undefined"!==names[t].muted)if(1==names[t].muted)i='<i class="fa fa-microphone-slash"></i> ',s="";else if(s="",i='<i class="fa fa-microphone"></i> ',t!==comm_controller.getSessionId())s='<span class="user-action"><a data-typeid="'+t+'" href="#" id="muteAttendee'+t+'"><i class="fa fa-fw fa-volume-off" title="'+smartVideoLocale.msgStore.mute+'"></i></a></span>';else s='<span class="user-action"><a data-typeid="'+t+'" href="#" id="muteAllAttendee"><i class="fa fa-fw fa-volume-off"></i> '+smartVideoLocale.msgStore.muteAll+"</a></span>";if("undefined"!==names[t].muted&&names[t].video)if(d='<i class="fa fa-tv"></i> ',a="",t!==comm_controller.getSessionId())a=' <span class="user-action"><a data-typeid="'+t+'" href="#" id="videoOffAttendee'+t+'"><i class="fa fa-fw fa-power-off" title="'+smartVideoLocale.msgStore.turnOffCamera+'"></i></a></span>';if(t!==comm_controller.getSessionId())var l=' <span class="user-action"><a data-typeid="'+t+'" href="#" id="private'+t+'"><i class="fa fa-comment"></i> '+smartVideoLocale.msgStore.privateChat+"</a></span>";else l="";if(queryString.isAdmin){var u=blockIcon="";if(queryString.broadcast)if(names[t].priv)u=' <span class="user-action"><a data-typeid="'+t+'" href="#" id="revoke'+t+'"><i class="fa fa-stop-circle-o"></i> '+(v=smartVideoLocale.msgStore.revoke)+"</a></span>";else names[t].raiseHand&&(u=' <span class="user-action"><a data-typeid="'+t+'" href="#" id="grant'+t+'"><i class="fa fa-hand-paper-o"></i> '+(v=smartVideoLocale.msgStore.grant)+"</a></span>");if((svConfigs.serverSide.loginForm||svConfigs.serverSide.token)&&t!==comm_controller.getSessionId()){var m=smartVideoLocale.msgStore.block;blockIcon=' <span class="user-action"><a data-typeid="'+t+'" href="#" id="block'+t+'"><i class="fa fa-stop"></i> '+m+"</a></span>"}o("<li>"+i+d+'<span class="mx-10">'+names[t].name+n+"</span>"+s+a+l+u+blockIcon+"</li>").appendTo(c),o("#grant"+t).on("click",function(e){for(var t in names)names[t].priv&&(names[t].priv=!1,comm_controller.revokePriveleges(t));names[o(this).attr("data-typeid")].priv=!0,comm_controller.grantPriveleges(o(this).attr("data-typeid"))}),o("#block"+t).on("click",function(e){if(1==confirm(smartVideoLocale.msgStore.sureBlock)){var t=names[o(this).attr("data-typeid")].username?names[o(this).attr("data-typeid")].username:names[o(this).attr("data-typeid")].email;o.ajax({type:"POST",timeout:5e3,url:lsRepUrl+"server/script.php",data:{type:"blockuser",username:t}}).done(function(e){}).fail(function(){}),delete names[o(this).attr("data-typeid")],comm_controller.blockUser(o(this).attr("data-typeid")),r(),setTimeout(function(){ui_handler.toggleVisitors(!1),r()},500)}}),o("#revoke"+t).on("click",function(e){names[o(this).attr("data-typeid")].priv=!1,comm_controller.revokePriveleges(o(this).attr("data-typeid")),setTimeout(function(){ui_handler.toggleVisitors(!1),r()},500)}),o("#muteAttendee"+t).on("click",function(e){comm_controller.setMute(o(this).attr("data-typeid")),setTimeout(function(){ui_handler.toggleVisitors(!1),r()},500)}),o("#videoOffAttendee"+t).on("click",function(e){comm_controller.setVideoOff(o(this).attr("data-typeid")),setTimeout(function(){ui_handler.toggleVisitors(!1),r()},500)})}else o("<li>"+i+d+'<span class="mx-10">'+names[t].name+n+"</span>"+l+"</li>").appendTo(c);o("#private"+t).on("click",function(e){var t=o(this).attr("data-typeid");o("#visitor_message").show(),o("#send_message_to").html(smartVideoLocale.msgStore.sendMessageTo+names[t].name),o("#private_message_button").off(),o("#private_message_button").on("click",function(){var n=o("#private_message_small").val();S(n,!0,t),o("#private_message_small").val(""),o("#visitor_message").hide(),e.stopPropagation()}),e.stopPropagation()}),t!==comm_controller.getSessionId()&&(peer_avatar=names[t].avatar,peer_name=names[t].name,peer_name_id=t),o("<li><hr/></li>").appendTo(c),e++}e>0?(o(".dw-chat-avatar").show(),o(".dw-chat-avatar").attr("src",peer_avatar),o("#peer_name_chat").html(peer_name),o("#showProfile").show()):(o(".dw-chat-avatar").hide(),o("#peer_name_chat").html(""),o("#showProfile").hide()),o("#muteAllAttendee").on("click",function(){comm_controller.setMuteAll()})}else{o("#visitors").empty();e=0;for(var t in names){if(t!==comm_controller.getSessionId()){var g=o("ul#visitors"),f=o("<li/>").addClass("ui-menu-item").attr("role","menuitem").appendTo(g);if(o("<a/>").addClass("ui-all").attr("typeid",t).text(names[t].name).attr("title",smartVideoLocale.msgStore.sendMessageTo+names[t].name).appendTo(f).click(function(){o(this).attr("typeid")!=comm_controller.getSessionId()&&h(o(this).attr("typeid"))}),queryString.isAdmin&&queryString.broadcast){if(names[t].priv)var v=smartVideoLocale.msgStore.revoke,p=lsRepUrl+"img/revoke.png";else names[t].raiseHand?(v=smartVideoLocale.msgStore.grant,p=lsRepUrl+"img/grant.png"):v="";if(v)o("<img/>").attr("typeid",t).addClass("centerImg").attr("src",p).attr("title",v+" "+names[t].name).appendTo(f).click(function(){o(this).attr("typeid")!=comm_controller.getSessionId()&&(names[o(this).attr("typeid")].priv?(names[o(this).attr("typeid")].priv=!1,comm_controller.revokePriveleges(o(this).attr("typeid"))):(names[o(this).attr("typeid")].priv=!0,comm_controller.grantPriveleges(o(this).attr("typeid")))),setTimeout(function(){ui_handler.toggleVisitors(!1),r()},500)})}if(queryString.isAdmin&&(svConfigs.serverSide.loginForm||svConfigs.serverSide.token)){m=smartVideoLocale.msgStore.block;o("<img/>").addClass("centerImg").attr("typeid",t).attr("title",m+" "+names[t].name).attr("src",lsRepUrl+"img/block.png").appendTo(f).click(function(){1==confirm(smartVideoLocale.msgStore.sureBlock)&&(o.ajax({type:"POST",timeout:5e3,url:lsRepUrl+"server/script.php",data:{type:"blockuser",username:names[o(this).attr("typeid")].username}}).done(function(e){}).fail(function(){}),delete names[o(this).attr("typeid")],comm_controller.blockUser(o(this).attr("typeid")),r(),setTimeout(function(){ui_handler.toggleVisitors(!1),r()},500))})}}t!==comm_controller.getSessionId()&&(peer_avatar=names[t].avatar,peer_name=names[t].name),e++}}function h(e){o("#visitor_message").show(),o("#send_message_to").html(smartVideoLocale.msgStore.sendMessageTo+names[e].name),o("#private_message_button").off(),o("#private_message_button").on("click",function(){var t=o("#private_message_small").text();S(t,!0,e),o("#visitor_message").hide(),setTimeout(function(){ui_handler.toggleVisitors(!1)},500),o("#private_message_small").text("")})}e>2?(o(".dw-chat-avatar").attr("src",lsRepUrl+"img/listusers.png"),o("#peer_name_chat").html("...")):(o(".dw-chat-avatar").attr("src",peer_avatar),o("#peer_name_chat").html(peer_name))},s=function(){comm_controller.getStream()||(stopIncomingCall(),m(!0),"conference"==conferenceStyle?ui_handler.displayVideoOnly():(inCall=[],o("#localVideo").hide(),o("#video_back").show(),ui_handler.toggleInstaChat(),setTimeout(function(){R(!1)},500)))};function a(e){!function(e,o){var t;t={video:!0},navigator.mediaDevices.getDisplayMedia?navigator.mediaDevices.getDisplayMedia(t).then(e).catch(o):navigator.getDisplayMedia(t).then(e).catch(o)}(function(o){!function(e,o){e.addEventListener("ended",function(){o(),o=function(){}},!1),e.addEventListener("inactive",function(){o(),o=function(){}},!1),e.getTracks().forEach(function(e){e.addEventListener("ended",function(){o(),o=function(){}},!1),e.addEventListener("inactive",function(){o(),o=function(){}},!1)})}(o,function(){m(!0),ui_handler.setRecordingUi(!1),comm_controller.stopRecording()}),e(o)},function(e){console.error(e),alert("Unable to capture your screen. Please check console logs.\n"+e)})}function d(e){var o=document.createElement("video");o.autoplay=!0,o.muted=!0,o.srcObject=e,o.style.display="none",(document.body||document.documentElement).appendChild(o)}var c=function(){m(!1),comm_controller.startRecording(),ui_handler.setRecordingUi(!0)},l=function(){if(startedRecroding=!0,comm_controller.startRecording(),ui_handler.setRecordingUi(!0),!recordingHeight){const e=document.getElementById("localVideo");recordingHeight=e.videoHeight/(e.videoWidth/recordingWidth)}if(svConfigs.recording.screen)a(function(e){var o;recordScreen=e,d(e),o=function(o){recordCamera=o,d(o),e.width=window.screen.width,e.height=window.screen.height,e.fullcanvas=!0,o.width=recordingWidth,o.height=recordingHeight,o.top=e.height-o.height,o.left=e.width-o.width,(multiStreamRecorder=RecordRTC([e,o],{type:"video",mimeType:"video/webm",video:{width:recordingWidth,height:recordingHeight},width:recordingWidth,height:recordingHeight})).startRecording(),recordingTimer=setInterval(c,6e4)},navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then(o)});else{if(queryString.isAdmin){var e=[];for(var o in names){let n=document.getElementById(o),i=(n=n||document.getElementById("localVideo")).videoWidth/(n.videoHeight/recordingHeight);if(svConfigs.recording.oneWay){if(o!=comm_controller.getSessionId()){var t=comm_controller.getRemoteStream(o);t.videoHeight=recordingHeight,t.videoWidth=i,t.left=recordingWidth,e.push(t)}}else(t=comm_controller.getRemoteStream(o)).videoHeight=recordingHeight,t.videoWidth=i,t.left=recordingWidth,e.push(t)}}var n="video/webm";isChrome?n="video/webm;codecs=vp9":isSafariA?n="video/webm;codecs=h264":isFirefox&&(n="video/webm;codecs=vp8");var i={disableLogs:!svConfigs.videoScreen.enableLogs,width:recordingWidth,height:recordingHeight,recorderType:MultiStreamRecorder,type:"video",mimeType:n,video:HTMLVideoElement};svConfigs.recording.videoquality&&(i.bitsPerSecond=svConfigs.recording.videoquality),(multiStreamRecorder=RecordRTC(e,i)).startRecording()}svConfigs.serverSide.videoLogs&&saveLog("start recording",agentId,"audio: "+audio_on+", video: "+video_on,comm_controller.getSessionId(),names[comm_controller.getSessionId()].name)},u=function(){if(!is_chat_opened&&(is_chat_opened=!0,svConfigs.serverSide.chatHistory)){if(queryString.isAdmin)for(var e in names)e!==comm_controller.getSessionId()&&(t=e);else var t=comm_controller.getSessionId();o.ajax({type:"POST",timeout:5e3,url:lsRepUrl+"server/script.php",data:{type:"getchat",roomId:room,sessionId:t,agentId:agentId}}).done(function(e){e&&JSON.parse(e).forEach(function(e){var o=svConfigs.agentName?svConfigs.agentName:"Agent";if(names[comm_controller.getSessionId()]&&(e.from==names[comm_controller.getSessionId()].name||queryString.isAdmin&&e.from==o))var t="Me";else t=e.from;if(queryString.isAdmin||!e.system){var n=getPrettyDate(e.date_created);showMessage(t,e.message,n,e.system,e.avatar)}})}).fail(function(){console.log(!1)})}},m=function(e){ui_handler.setRecordingUi(!1),comm_controller.stopRecording(),multiStreamRecorder&&multiStreamRecorder.stopRecording(function(){g(e),e&&svConfigs.recording.screen&&(clearInterval(recordingTimer),[recordScreen,recordCamera].forEach(function(e){e.getTracks().forEach(function(e){e.stop()})}))})},g=function(e){if(startedRecroding){var t=URL.createObjectURL(multiStreamRecorder.getBlob());if(svConfigs.recording.filename)var n=svConfigs.recording.filename,i=(n=(n=n.replace("%room%",room)).replace("%datetime%",getCurrentDateFormatted()))+".webm";else i="record_"+room+"_"+getCurrentDateFormatted()+".webm";if(svConfigs.recording.download&&invokeSaveAsDialog(multiStreamRecorder.getBlob(),n),svConfigs.recording.saveServer){var r=new FormData;r.append("video-filename",i),r.append("video-blob",multiStreamRecorder.getBlob()),r.append("room",room),r.append("agentName",agentName),r.append("agentId",agentId),r.append("isFfmpeg",1==svConfigs.recording.transcode),function(o,t){var n=new XMLHttpRequest;n.onreadystatechange=function(){4==n.readyState&&200==n.status&&(e?(multiStreamRecorder.destroy(),multiStreamRecorder=null):multiStreamRecorder.startRecording())},n.open("POST",o),n.send(t)}(lsRepUrl+"/server/saverecord.php",r),o.ajax({type:"POST",timeout:5e3,url:lsRepUrl+"server/script.php",data:{type:"addrecording",roomId:roomId||queryString.room,filename:i,agentId:agentId}}).done(function(e){}).fail(function(){console.log(!1)})}o("#recording_message").show(),o(".recordinglink").attr("href",t),o(".recordinglink").click(function(){o("#recording_message").hide()}),o(".close-but-wd-small").on("click",function(){window.URL.revokeObjectURL(t),o("#recording_message").hide()}),startedRecroding=!1}},f=function(){svConfigs.serverSide.videoLogs&&isLsvAdmin&&saveLog("end",agentId,"audio: "+audio_on+", video: "+video_on,comm_controller.getSessionId()),stopIncomingCall(),"conference"==conferenceStyle?ui_handler.displayVideoOnly():ui_handler.toggleInstaChat(),comm_controller.getStream()&&(m(!0),comm_controller.handleCallTermination(),y()),comm_controller.endCall("hang up call")},v=function(){setCookie("lsvGreenRoom","1"),o("<link>",{rel:"stylesheet",type:"text/css",href:lsRepUrl+"css/cloud.css?v="+currVersion}).appendTo("head"),o("<link>",{rel:"stylesheet",type:"text/css",href:lsRepUrl+"css/sky-forms.css?v="+currVersion}).appendTo("head");var e=o("#videoPreview")[0];audioInputSelect=document.querySelector("select#audioSource"),audioOutputSelect=document.querySelector("select#audioOutput"),videoSelect=document.querySelector("select#videoSource");var t=[audioInputSelect,audioOutputSelect,videoSelect];function n(e){var o=t.map(function(e){return e.value});t.forEach(function(e){for(;e.firstChild;)e.removeChild(e.firstChild)});for(var n=0;n!==e.length;++n){var i=e[n],r=document.createElement("option");r.value=i.deviceId,"audioinput"===i.kind?(r.text=i.label||"microphone "+(audioInputSelect.length+1),r.dataset.icon="fa fa-microphone mr-2",audioInputSelect.appendChild(r)):"audiooutput"===i.kind?(r.text=i.label||"speaker "+(audioOutputSelect.length+1),r.dataset.icon="fa fa-headphones mr-2",audioOutputSelect.appendChild(r)):"videoinput"===i.kind&&(r.dataset.icon="fa fa-video-camera mr-2",r.text=i.label||"camera "+(videoSelect.length+1),videoSelect.appendChild(r))}t.forEach(function(e,t){Array.prototype.slice.call(e.childNodes).some(function(e){return e.value===o[t]})&&(e.value=o[t])}),document.getElementById("audioSource").selectedIndex=audioCurrentId,document.getElementById("audioOutput").selectedIndex=audioOutputCurrentId,document.getElementById("videoSource").selectedIndex=videoCurrentId}audioCurrentId=localStorage.getItem("audioCurrentId")>0?parseInt(localStorage.getItem("audioCurrentId")):0,videoCurrentId=localStorage.getItem("videoCurrentId")>0?parseInt(localStorage.getItem("videoCurrentId")):0,videoSource=localStorage.getItem("videoSource")?localStorage.getItem("videoSource"):void 0,audioOutputCurrentId=localStorage.getItem("audioOutputCurrentId")>0?localStorage.getItem("audioOutputCurrentId"):0;var i=!videoSource||{deviceId:videoSource?{exact:videoSource}:void 0};isIEA&&(i=!0);var r={audio:!0,video:i};function s(o){if(testAudioTrack=o.getAudioTracks()[0],testVideoTrack=o.getVideoTracks()[0],testAudioTrack.enabled=!1,window.stream=o,e.srcObject=o,!isIEA)return e.srcObject=o,navigator.mediaDevices.enumerateDevices()}function a(){window.stream&&window.stream.getTracks().forEach(function(e){e.stop()}),audioSource=audioInputSelect.value,videoSource=videoSelect.value,videoCurrentId=videoSelect.selectedIndex,audioCurrentId=audioInputSelect.selectedIndex,localStorage.setItem("videoCurrentId",videoCurrentId),localStorage.setItem("videoSource",videoSource),localStorage.setItem("audioCurrentId",audioCurrentId);var e={audio:!!audio_on&&{deviceId:audioSource?{exact:audioSource}:void 0},video:{deviceId:videoSource?{exact:videoSource}:void 0}};"undefined"==typeof Promise?navigator.getUserMedia(e,s,d):navigator.mediaDevices.getUserMedia(e).then(s).then(n).catch(d)}function d(e){console.log("navigator.getUserMedia error: ",e)}"undefined"==typeof Promise||navigator.mediaDevices.getUserMedia(r).then(s).then(function(){navigator.mediaDevices.enumerateDevices().then(n).catch(d)}).catch(function e(o){if("NotReadableError"===o.name&&audio_on)audio_on=!1;else{if("OverconstrainedError"!==o.name)return;localStorage.removeItem("videoSource"),localStorage.removeItem("videoCurrentId"),localStorage.removeItem("audioCurrentId");var t={audio:!0,video:!0}}"undefined"==typeof Promise||navigator.mediaDevices.getUserMedia(t).then(s).then(function(){navigator.mediaDevices.enumerateDevices().then(n).catch(d)}).catch(e)}),audioInputSelect&&(audioInputSelect.onchange=a),audioOutputSelect&&(audioOutputSelect.onchange=function(){(audioOutputCurrentId=audioOutputSelect.selectedIndex)>0&&localStorage.setItem("audioOutputCurrentId",audioOutputCurrentId);var o=audioOutputSelect.value;!function(e,o){void 0!==e.sinkId?e.setSinkId(o).then(function(){}).catch(function(e){var o=e;"SecurityError"===e.name&&(o="You need to use HTTPS for selecting audio output device: "+e),console.error(o),audioOutputSelect.selectedIndex=0}):console.warn("Browser does not support output device selection.")}(e,o)}),videoSelect&&(videoSelect.onchange=a),"simple"==conferenceStyle&&(ui_handler.toggleInstaChat(),ui_handler.restoreVideoBox(),o("#popup_widget_text_videos").show(),ui_handler.toggleInstaVideo(4))},p=function(e){audio_on=!o("#muteAudio").is(":checked"),video_on=!o("#muteVideo").is(":checked"),disableAudio&&(audio_on=!1),disableVideo&&(video_on=!1),window.stream&&window.stream.getTracks().forEach(function(e){e.stop()}),ui_handler.restoreVideoBox(),ui_handler.toggleInstaVideo(!1);var t=video_on?"Video":"Audio";comm_controller.initCall(t,e,videoSource,comm_controller.getSessionId(),audioSource,svConfigs.videoScreen.videoConstraint,svConfigs.videoScreen.audioConstraint)},h=function(e){if(isOnline)if(x(comm_controller.getSessionId(),video_on),queryString.broadcast||!svConfigs.videoScreen.greenRoom||getCookie("lsvGreenRoom")){ui_handler.restoreVideoBox(),ui_handler.toggleInstaVideo(!1);var t=video_on?"Video":"Audio";comm_controller.initCall(t,e,videoSource,comm_controller.getSessionId(),audioSource,svConfigs.videoScreen.videoConstraint,svConfigs.videoScreen.audioConstraint)}else v(),o("#startVideoButton").off(),o("#startVideoButton").on("click",function(){p(e)});else T()},S=function(e,o,t){e=escapeHtmlEntities(e),t&&(e='<small id="private">'+smartVideoLocale.msgStore.private+"</small> "+e),o&&showMessage("Me",e);var n=(new Date).toLocaleTimeString();comm_controller.addLocalChat(e,n,t),svConfigs.serverSide.chatHistory&&saveChat(e,names[comm_controller.getSessionId()].name,"",agentId,names[comm_controller.getSessionId()].avatar,names)},C=function(e){if("conference"==conferenceStyle){if(o("#"+e).val()){var t=o("#"+e).val();S(t,!0),o("#"+e).val("")}}else if(o("#"+e).text()){t=o("#"+e).text();S(t,!0),o("#"+e).html("")}},w=function(e){e?(o("#wd-widget-content-video").show(),o("#local_video_div").show(),!queryString.broadcast&&svConfigs.videoScreen.separateScreenShare&&(o("#localScreen").show(),o("#localVideo").hide()),o("#showHideVideo").addClass("disabled")):(o("#remoteScreenChat").hide(),!queryString.broadcast&&svConfigs.videoScreen.separateScreenShare&&(o("#remoteScreen").hide(),o("#localScreen").hide()),comm_controller.getStream()||"conference"==conferenceStyle?(o("#local_video_div").show(),o("#localVideo").show()):(o("#local_video_div").hide(),o("#localVideo").hide()),o("#showHideVideo").removeClass("disabled")),(svConfigs.videoScreen&&0==svConfigs.videoScreen.onlyAgentButtons||queryString.isAdmin)&&ui_handler.setScreenButton(e)},y=function(){w(!1),comm_controller.handleScreenShareTermination(),comm_controller.getStream()||("conference"==conferenceStyle?ui_handler.displayVideoOnly():ui_handler.toggleInstaChat())},b=function(){if(queryString.broadcast||!svConfigs.videoScreen.separateScreenShare)if(audio_on)ui_handler.restoreVideoBox(),comm_controller.startScreenShare(),w(!0);else{audio_on=!audio_on;var e=localStorage.getItem("prd");(e=JSON.parse(e)).muted=!audio_on,e.room=room,localStorage.setItem("prd",JSON.stringify(e)),comm_controller.toggleAudio(),setTimeout(function(){ui_handler.restoreVideoBox(),comm_controller.startScreenShare(),w(!0)},500)}else y(),ui_handler.restoreVideoBox(),comm_controller.startScreenShareConf(),w(!0);svConfigs.serverSide.videoLogs&&saveLog("start screenshare",agentId,"audio: "+audio_on+", video: "+video_on,comm_controller.getSessionId(),names[comm_controller.getSessionId()].name)},I=function(){if(queryString.isAdmin&&(isOnline=!0),audio_on=!o("#muteAudio1").is(":checked"),video_on=!o("#muteVideo1").is(":checked"),disableAudio&&(audio_on=!1),disableVideo&&(video_on=!1),names[comm_controller.getSessionId()].muted=!audio_on,names[comm_controller.getSessionId()].video=video_on,names[comm_controller.getSessionId()].room=room,names[comm_controller.getSessionId()].name=queryString.isAdmin?agentName:visitorName||guestName(comm_controller.getSessionId()),names[comm_controller.getSessionId()].isAdmin=queryString.isAdmin,names[comm_controller.getSessionId()].priv=!!localStorage.getItem("hasPrivileges"),datetime&&(names[comm_controller.getSessionId()].datetime=datetime),duration&&(names[comm_controller.getSessionId()].duration=duration),o("#ng_caller_name").val()&&(queryString.isAdmin?agentName=o("#ng_caller_name").val():visitorName=o("#ng_caller_name").val(),names[comm_controller.getSessionId()].name=o("#ng_caller_name").val()),requirePass&&localStorage.getItem("prd")){var e=JSON.parse(localStorage.getItem("prd"));names[comm_controller.getSessionId()].password=e.password}else comm_controller.setCallerInfo(names[comm_controller.getSessionId()],queryString.isAdmin);localStorage.setItem("prd",JSON.stringify(names[comm_controller.getSessionId()])),queryString.isAdmin||!svConfigs.videoScreen.admit||getCookie("approveAdmit")?(svConfigs.videoScreen.greenRoom?(o("#wd-widget-content-greenroom").show(),o("#startVideoButton").off(),o("#startVideoButton").on("click",function(){p(!1)}),v()):(r(),ui_handler.setVideoButton(),h(!0)),requirePass=!1):(toggleNotification(smartVideoLocale.msgStore.waitingToAdmit,!0),comm_controller.askAdmit(names[comm_controller.getSessionId()]))},_=function(){if(datetime)e=datetime;else var e=Date.now();var t=new Date,n=new Date(e);if(n.setMinutes(n.getMinutes()+parseInt(duration)),t>=new Date(e)&&n>t){if(svConfigs.videoScreen.exitMeetingOnTime){var i=new Date,r=n-i;setTimeout(function(){var e=smartVideoLocale.msgStore.meetingIsToEnd;toggleError(e,6e4)},n-i-6e4),setTimeout(function(){toggleNotification("",!1),o("#end_meeting").trigger("click")},r)}return!0}var s=new Date,a=new Date(e),d=Math.abs(a-s)/1e3,c=Math.floor(d/86400);d-=86400*c;var l=Math.floor(d/3600)%24;d-=3600*l;var u=Math.floor(d/60)%60;if(d-=60*u,diffString="",c>0){var m=c>1?smartVideoLocale.msgStore.days:smartVideoLocale.msgStore.day;diffString=c+" "+m}if(0===c&&l>0){var g=l>1?smartVideoLocale.msgStore.hours:smartVideoLocale.msgStore.hour;diffString=l+" "+g}if(0===c&&0==l&&u>0&&(diffString=u+" "+smartVideoLocale.msgStore.minutes),0===c&&0==l&&0==u&&(diffString=smartVideoLocale.msgStore.seconds),diffString&&new Date(e)>t){var f=smartVideoLocale.msgStore.notexactAppointment,v=getPrettyDate(new Date(e).getTime()/1e3),p=(p=f.replace("{{timemeeting}}",v)).replace("{{diffString}}",diffString);toggleNotification(p,!0);var h=new Date,S=new Date(e)-h;S<2147483640&&setTimeout(function(){window.location.reload()},S)}else toggleNotification(smartVideoLocale.msgStore.appointmentPast,!0);return ui_handler.displayChatOnly(),ui_handler.setDisabled(!0),!1},k=function(e){if(toggleNotification("",!1),is_widget_opened="conference"==conferenceStyle?o("#wd-widget-content-greenroom").is(":visible")||o("#wd-widget-content-video-waiting").is(":visible")||o("#wd-widget-content-video").is(":visible")||is_widget_opened:o("#nd_widget_content").is(":visible"),caller_name=caller_name||"",caller_email=caller_email||"",caller_phone=caller_phone||"",is_widget_opened||ui_handler.toggleWidget(),"conference"==conferenceStyle){var t=localStorage.getItem("prd");t=JSON.parse(t),audio_on=!t||null==t.muted||!t.muted,video_on=!t||null==t.video||t.video,o(".muteVideo").prop("checked",!video_on),o(".muteAudio").prop("checked",!audio_on),fileInput=document.querySelector("input#filetransfer")}else"chat"===e?ui_handler.toggleInstaChat():"video"===e?ui_handler.toggleInstaVideo():4!==e||is_widget_opened||ui_handler.toggleInstaVideo(4),document.getElementById("newdev_chat_message1").focus();r()},E=function(e){o(".new_chat_badge_container").hide(),o(".wd-chat-box").is(":visible")?(ui_handler.displayVideoOnly(),!0===e&&h(!1)):ui_handler.displayChatOnly()},A=function(){if(names[comm_controller.getSessionId()]||(names[comm_controller.getSessionId()]={}),roomAllow){if(queryString.broadcast){if(localStorage.removeItem("hasPrivileges"),svConfigs.serverSide.token)return is_widget_opened||comm_controller.getVideoSessions()||o("#invideo").is(":visible")||o("#ng_info").is(":visible")||(is_widget_opened=!0,ui_handler.setDisabled(!0),o.ajax({type:"POST",timeout:5e3,url:lsRepUrl+"server/script.php",data:{type:"logintoken",isAdmin:queryString.isAdmin,token:token,roomId:room}}).done(function(e){return e?(e=JSON.parse(e),ui_handler.setDisabled(!1),names[comm_controller.getSessionId()]={name:e.first_name+" "+e.last_name,avatar:svConfigs.agentAvatar?lsRepUrl+svConfigs.agentAvatar:lsRepUrl+"img/small-avatar.jpg",isAdmin:queryString.isAdmin,username:e.username},names[comm_controller.getSessionId()].priv=localStorage.getItem("hasPrivileges"),queryString.isAdmin?agentName=names[comm_controller.getSessionId()].name:visitorName=names[comm_controller.getSessionId()].name,comm_controller.setCallerInfo(names[comm_controller.getSessionId()],!0),e.name=e.first_name+" "+e.last_name,e.isAdmin=queryString.isAdmin,e.room=room,delete e.password,localStorage.setItem("prd",JSON.stringify(e)),toggleNotification("",!1),ui_handler.setDisabled(!1),r(),"conference"==conferenceStyle&&(queryString.isAdmin?(isOnline=!0,I()):(o("#ng_info").show(),o("#cameraMicChoose").hide(),o("#ng_caller_name").hide(),o("#login-conference-title").html(smartVideoLocale.msgStore.welcomeBroadcast),o("#continue-button").off(),o("#continue-button").on("click",function(){o("#ng_info").hide(),isOnline=!0,I()}))),!1):(toggleNotification(smartVideoLocale.msgStore.notValidToken,!0),localStorage.removeItem("prd"),localStorage.removeItem("hasPrivileges"),comm_controller.setClose(comm_controller.getSessionId()),ui_handler.displayChatOnly(),ui_handler.setDisabled(!0),!1)}).fail(function(){})),!1;if("conference"!==conferenceStyle)return ui_handler.toggleWidget(),ui_handler.toggleInstaChat(),ui_handler.displayVideoOnly(),ui_handler.toggleHeaderChat(),queryString.broadcast&&o("#raisehand_div").show(),o("#localVideo").hide(),o(".wd-avatar-agent").hide(),o("#video_container_chat").show(),o("#wd-widget-content-video").hide(),queryString.isAdmin&&(isOnline=!0,o("#callAudioButton_1").addClass("disabled"),o(".peer_avatar").hide()),!1;k("chat"),queryString.isAdmin&&(isOnline=!0)}if(comm_controller.getVideoSessions()||o("#invideo").is(":visible")||o("#wd-widget-content-greenroom").is(":visible")||o("#ng_info").is(":visible")){e=localStorage.getItem("prd");comm_controller.setCallerInfo(JSON.parse(e),queryString.isAdmin)}else{if(k("chat"),duration&&function(){if(datetime)e=datetime;else var e=Date.now();var o=new Date(e);if(o.setMinutes(o.getMinutes()+parseInt(duration)),svConfigs.videoScreen.meetingTimer){var t=new Date;setTimeout(function(){var e=new Date(o).getTime(),t=function(){setTimeout(function(){var o=(new Date).getTime(),n=e-o,i=Math.floor(n%864e5/36e5),r=Math.floor(n%36e5/6e4),s=Math.floor(n%6e4/1e3);r&&s<10&&(s="0"+s);var a=(i=i?i+":":"")+(r=r?r+":":"")+s,d=smartVideoLocale.msgStore.meetingEndsIn.replace("{{timemeeting}}",a);toggleTimer(d,!0),n<0?toggleTimer(smartVideoLocale.msgStore.meetingExpired,!0):t()},1e3)};t()},o-t-12e4)}}(),(!!svConfigs.videoScreen.exitMeetingOnTimeAgent||!queryString.isAdmin)&&duration)if(!_())return!1;if(queryString.broadcast&&"https://www.new-dev.com/ui/"===lsRepUrl)if(svConfigs.videoScreen.exitMeetingOnTime=!0,svConfigs.videoScreen.exitMeeting="https://www.new-dev.com",duration=5,!_())return!1;if(!queryString.isAdmin&&requirePass)return toggleNotification("",!1),o("#ng_info").show(),ui_handler.displayChatOnly(),ui_handler.setDisabled(!0),visitorName&&o("#ng_caller_name").val(visitorName),svConfigs.entryForm.showEmail&&o("#ng_caller_email").show(),svConfigs.entryForm.showAvatar&&o("#ng_caller_avatar").show(),o("#ng_password").show(),o("#continue-button").off(),o("#continue-button").on("click",function(){is_callerback=!1;var e={};e.name=visitorName||o("#ng_caller_name").val(),o("#ng_caller_name").val()&&(e.email=o("#ng_caller_name").val()),o("#ng_caller_avatar").val()&&(e.avatar=o("#ng_caller_avatar").val()),e.password=o("#ng_password").val(),e.room=room,comm_controller.setCallerInfo(e,!1),localStorage.setItem("prdTmp",JSON.stringify(e))}),!1;if(localStorage.getItem("prd")){var e=localStorage.getItem("prd");e=JSON.parse(e),roomPrd=e.room}if(visitorName&&!queryString.isAdmin&&!svConfigs.serverSide.loginForm&&!queryString.broadcast){svConfigs.entryForm.enabled=!1;var t={name:visitorName,room:room};datetime&&(t.datetime=datetime),duration&&(t.duration=duration),localStorage.setItem("prd",JSON.stringify(t))}if(localStorage.getItem("prd")&&roomPrd==room&&!svConfigs.serverSide.loginForm&&!queryString.broadcast)svConfigs.entryForm.enabled=!1,(e=localStorage.getItem("prd"))&&(e=JSON.parse(e)),comm_controller.setCallerInfo(e,queryString.isAdmin),names[comm_controller.getSessionId()]={name:e?e.name:caller_name,avatar:e?e.avatar:caller_avatar,email:e?e.email:caller_email};if(svConfigs.entryForm.terms&&(svConfigs.entryForm.enabled=!0,svConfigs.entryForm.required=!0),svConfigs.entryForm.enabled){var n=function(){caller_name=o("#ng_caller_name").val(),caller_email=o("#ng_caller_email").val(),caller_avatar=o("#ng_caller_avatar").val(),toggleNotification("",!1);var e={name:caller_name,email:caller_email,avatar:caller_avatar,room:room};svConfigs.serverSide&&svConfigs.serverSide.loginForm?isLsvAdmin?(ui_handler.setDisabled(!0),o("#ng_info").show(),o.ajax({type:"POST",timeout:5e3,url:lsRepUrl+"server/script.php",data:{type:"loginadmin",email:o("#ng_caller_email").val(),password:o("#ng_password").val()}}).done(function(t){if(!t||200!=t)return toggleNotification(smartVideoLocale.msgStore.notValidPassword,!0),!1;ui_handler.setDisabled(!1),o("#ng_info").hide(),comm_controller.setCallerInfo(e,!1),localStorage.setItem("prd",JSON.stringify(e)),"conference"==conferenceStyle&&I()}).fail(function(){return!1})):(ui_handler.setDisabled(!0),o("#ng_info").show(),o.ajax({type:"POST",timeout:5e3,url:lsRepUrl+"server/script.php",data:{type:"login",email:o("#ng_caller_email").val(),password:o("#ng_password").val()}}).done(function(t){if(!t||200!=t)return toggleNotification(smartVideoLocale.msgStore.notValidPassword,!0),!1;ui_handler.setDisabled(!1),o("#ng_info").hide(),comm_controller.setCallerInfo(e,!1),localStorage.setItem("prd",JSON.stringify(e)),"conference"==conferenceStyle&&(isOnline=!0,I())}).fail(function(){return!1})):(localStorage.setItem("prd",JSON.stringify(e)),svConfigs.entryForm.private&&requirePass?e.password=o("#ng_password").val():(o("#ng_info").hide(),o("#continue-button").off(),ui_handler.setDisabled(!1)),comm_controller.setCallerInfo(e,queryString.isAdmin),"conference"==conferenceStyle&&I())};if(svConfigs.entryForm.required||svConfigs.entryForm.private){(svConfigs.entryForm.private&&requirePass||svConfigs.serverSide.loginForm)&&(isOnline=!1,o("#ng_password").show()),svConfigs.entryForm.showEmail&&o("#ng_caller_email").show(),svConfigs.entryForm.showAvatar&&o("#ng_caller_avatar").show(),s=function(e){var t=/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;13==e.keyCode&&""!==o("#ng_caller_name").val()&&""!==o("#ng_caller_email").val()&&t.test(o("#ng_caller_email").val())&&n();var i=!svConfigs.entryForm.showEmail||""!==o("#ng_caller_email").val()&&t.test(o("#ng_caller_email").val()),r=!svConfigs.entryForm.showAvatar||""!==o("#ng_caller_avatar").val(),s=!svConfigs.entryForm.terms||o("#terms").is(":checked");""!==o("#ng_caller_name").val()&&i&&r&&s?o("#continue-button").removeClass("disabled"):o("#continue-button").addClass("disabled")},o("#terms").click(function(e){s(e)}),o("#ng_caller_name").keyup(function(e){s(e)}),o("#ng_caller_email").keyup(function(e){s(e)}),o("#ng_password").keyup(function(e){s(e)}),o("#ng_caller_avatar").keyup(function(e){s(e)}),o("#ng_caller_name").blur(function(e){s(e)}),o("#ng_caller_email").blur(function(e){s(e)}),o("#ng_password").blur(function(e){s(e)}),o("#ng_caller_avatar").blur(function(e){s(e)}),o("#continue-button").addClass("disabled")}if(ui_handler.displayChatOnly(),ui_handler.setDisabled(!0),isLsvAdmin&&agentName?svConfigs.entryForm.enabled=!1:o("#ng_info").show(),setTimeout(function(){o("#ng_caller_name").focus()},500),o("#continue-button").off(),o("#continue-button").on("click",function(){n()}),svConfigs.entryForm.enabled&&svConfigs.social&&svConfigs.social.enabled){o("#socialLogins").show();var i=function(e){var t={};t.name=e,o("#ng_caller_name").val(e),comm_controller.setCallerInfo(t,!1),ui_handler.setDisabled(!1),o("#ng_info").hide(),comm_controller.setCallerInfo(t,!1),localStorage.setItem("prd",JSON.stringify(t)),"conference"==conferenceStyle&&(isOnline||isLsvAdmin)&&I()};svConfigs.social.facebookId&&(o("#facebookLogin").show(),loadScript("https://connect.facebook.net/en_US/sdk.js",function(){function e(e){"connected"===e.status&&FB.api("/me",function(e){i(e.name)})}o("#facebookLogin").click(function(){FB.login(e,{scope:"email,public_profile",return_scopes:!0})}),window.fbAsyncInit=function(){FB.init({appId:svConfigs.social.facebookId,cookie:!0,xfbml:!0,version:"v9.0"}),FB.getLoginStatus(function(o){e(o)})}})),svConfigs.social.googleId&&(o("head").append('<meta name="google-signin-scope" content="profile email">'),o("head").append('<meta name="google-signin-client_id" content="'+svConfigs.social.googleId+'">'),o("#googleLogin").show(),loadScript("https://apis.google.com/js/platform.js",function(){gapi.load("auth2",function(){auth2=gapi.auth2.init({client_id:svConfigs.social.googleId,cookiepolicy:"single_host_origin",scope:"profile"}),auth2.attachClickHandler(element,{},function(e){var o=e.getBasicProfile();i(o.getName())},function(e){toggleError("Error with login, make sure you are not in private mode",5e3)})}),element=document.getElementById("googleLogin")}))}}else{if(queryString.isAdmin&&agentName)svConfigs.entryForm.enabled=!1,(e=localStorage.getItem("prd"))&&((e=JSON.parse(e)).name=names[comm_controller.getSessionId()].name,e.avatar=names[comm_controller.getSessionId()].avatar),names[comm_controller.getSessionId()]={name:svConfigs.agentName?svConfigs.agentName:"",avatar:svConfigs.agentAvatar?svConfigs.agentAvatar:lsRepUrl+"img/small-avatar.jpg",room:room},comm_controller.setCallerInfo(e,!0),localStorage.setItem("prd",JSON.stringify(names[comm_controller.getSessionId()]));isOnline?(ui_handler.displayChatOnly(),toggleNotification("",!1),ui_handler.setDisabled(!1)):ui_handler.setDisabled(!0)}(e=localStorage.getItem("prd"))&&(0==(e=JSON.parse(e)).video&&(disableVideo=!0),1==e.muted&&(disableAudio=!0)),names[comm_controller.getSessionId()]={name:e?e.name:caller_name,avatar:e?e.avatar:caller_avatar,email:e?e.email:caller_email},0==svConfigs.entryForm.enabled&&"conference"==conferenceStyle&&(isOnline=!0,ui_handler.setDisabled(!1),I())}var s;r()}},R=function(e){e?o.ajax({type:"POST",timeout:5e3,url:lsRepUrl+"server/script.php",data:{type:"endmeeting",agentId:agentId,roomId:room}}).done(function(e){setTimeout(function(){toggleNotification(smartVideoLocale.msgStore.meetingHasEnded,!0),localStorage.removeItem("prd"),localStorage.removeItem("hasPrivileges"),comm_controller.setClose(comm_controller.getSessionId()),ui_handler.displayChatOnly(),ui_handler.setDisabled(!0),isOnline=!1},150)}).fail(function(){}):1!=svConfigs.serverSide.feedback||queryString.isAdmin||getCookie("lsvRateRoom")||comm_controller.getVideoSessions()||(o("#feedback_form").show(),o("#invideo").hide(),o("#feedback-button").click(function(){if(o("#feedback_form").hide(),token)var e=token;else e=names[comm_controller.getSessionId()].name?names[comm_controller.getSessionId()].name:guestName(comm_controller.getSessionId());o.ajax({type:"POST",timeout:5e3,url:lsRepUrl+"server/script.php",data:{type:"feedback",roomId:room,sessionId:comm_controller.getSessionId(),rate:o("#ratestars").rateit("value"),text:o("#feedback_message").val(),userId:e}}).done(function(e){e&&setCookie("lsvRateRoom","1",240)}).complete(function(){setCookie("lsvRateRoom","1",240)}).fail(function(){console.log(!1)})}))},T=function(){if(comm_controller.getParticipants()>0)console.log("setOffline return");else{if((!!svConfigs.videoScreen.exitMeetingOnTimeAgent||!queryString.isAdmin)&&duration&&setTimeout(function(){if(!_())return!1},50),queryString.broadcast&&"https://www.new-dev.com/ui/"===lsRepUrl)if(svConfigs.videoScreen.exitMeetingOnTime=!0,svConfigs.videoScreen.exitMeeting="https://www.new-dev.com",duration=5,!_())return!1;if(!comm_controller.getVideoSessions()&&!o("#invideo").is(":visible")){if(ui_handler.setDisabled(!0),smartVideoLocale.msgStore.waitingOtherParty)var e=smartVideoLocale.msgStore.waitingOtherParty;else e="Waiting for the other party to join";comm_controller.customerHere(visitorName),toggleNotification(e,!0)}r()}},x=function(e,o){names[e]&&(names[e].video=o),r()};function V(){if("conference"==conferenceStyle)var t="roomconference.css";else t="room.css";var a=o("<link>",{rel:"stylesheet",type:"text/css",href:lsRepUrl+"css/"+t+"?v="+currVersion}),d=o("<link>",{rel:"stylesheet",type:"text/css",href:lsRepUrl+"css/custom.css?v="+currVersion});if(o(document.body).append(n),a.appendTo("head"),d.appendTo("head"),1==svConfigs.serverSide.feedback){o("<link>",{rel:"stylesheet",type:"text/css",href:lsRepUrl+"css/rateit.css?v="+currVersion}).appendTo("head")}o.get(lsRepUrl+"pages/"+videoWidgetContainer+"?v="+currVersion,function(t){if(n.append(t),ui_handler.setWidgetValues(),svConfigs.serverSide.checkRoom&&o.ajax({type:"POST",timeout:5e3,url:lsRepUrl+"server/script.php",data:{type:"getroom",isAdmin:queryString.isAdmin,roomId:room}}).done(function(e){if(!e){var o=smartVideoLocale.msgStore.roomNotAllowed;return toggleError(o,5e4),void(roomAllow=isOnline=!1)}(e=JSON.parse(e)).title&&(roomAllow=!0,document.title=e.title)}).fail(function(){}),svConfigs.blackList&&svConfigs.blackList.includes(room)){var a=smartVideoLocale.msgStore.roomNotAllowed;return toggleError(a,5e4),void(roomAllow=isOnline=!1)}"conference"==conferenceStyle&&(o("#showProfile").show(),!(isChrome||isFirefox||isOpera||isSafariA)||isiPhone||isAndroid||!queryString.room&&!queryString.broadcast||o("#screenshareLi").show(),queryString.broadcast&&!queryString.isAdmin&&(o("#screenshareLi").hide(),o("#virtualBackgroundLi").hide()),svConfigs.recording.enabled&&queryString.isAdmin&&o("#recordingLi").show(),svConfigs.virtualBackground&&(svConfigs.virtualBackground.backgrounds||svConfigs.virtualBackground.blur)&&(o("#virtualBackgroundLi").show(),svConfigs.virtualBackground.backgrounds&&o("#backgrounds").show(),svConfigs.virtualBackground.blur&&o("#blur").show()),svConfigs.videoScreen.getSnapshot&&o("#snapshotLi").show()),"conference"==conferenceStyle&&queryString.broadcast&&!queryString.isAdmin&&(o("#showHideVideo").hide(),o("#showHideAudio").hide(),o("#raisehandLi").show(),o("#raisehandLi1").show(),o("#localVideo").hide(),o("#snapshotLi").hide()),"conference"==conferenceStyle&&queryString.broadcast&&svConfigs.videoScreen.videoFileStream&&(o("#showHideVideo").hide(),o("#showHideAudio").hide(),o("#localVideo").hide(),o("#snapshotLi").hide(),o("#raisehandLi").hide(),o("#whiteboardLi").hide(),o("#screenshareLi").hide(),o("#virtualBackgroundLi").hide(),o("#recordingLi").hide(),o("#changeViewLi").hide()),disableWhiteboard&&o("#whiteboardLi").hide(),disableScreenShare&&o("#screenshareLi").hide(),svConfigs.entryForm.terms&&o("#termsDiv").show(),o(document).on("LSLocaleUpdated",function(e){o("#cancel_call_button span").html(smartVideoLocale.msgStore.Cancel),o("#waitingToConnect").html(smartVideoLocale.msgStore.waitingToConnect),o("#answer_audiocall_button").attr("title",smartVideoLocale.msgStore.answerWithAudio),o("#answer_audiocall_button1").attr("title",smartVideoLocale.msgStore.answerWithAudio),o("#callAudioButton_4").attr("title",smartVideoLocale.msgStore.callWithAudio),o("#callAudioButton_1").attr("title",smartVideoLocale.msgStore.callWithAudio),o("#call_audio").attr("title",smartVideoLocale.msgStore.callWithAudio),o("#answer_call_button1").attr("title",smartVideoLocale.msgStore.answerWithVideo),o("#answer_call_button").attr("title",smartVideoLocale.msgStore.answerWithVideo),o("#reject_call_button").attr("title",smartVideoLocale.msgStore.rejectCall);var t=smartVideoLocale.msgStore.incomingText;o("#incoming_text").html(t.replace("{{caller_name}}",peer_name)),o("#callButton_4").attr("title",smartVideoLocale.msgStore.callWithVideo),o("#callButton_1").attr("title",smartVideoLocale.msgStore.callWithVideo),o("#call_video").attr("title",smartVideoLocale.msgStore.callWithVideo),o("#exit_meeting").attr("title",smartVideoLocale.msgStore.exitMeeting),o("#file_transfer").attr("title",smartVideoLocale.msgStore.fileTransfer),o("#showHideVideo").attr("title",smartVideoLocale.msgStore.showHideVideo),o("#showHideAudio").attr("title",smartVideoLocale.msgStore.showHideAudio),o(".wd-v-share").attr("title",smartVideoLocale.msgStore.startShare),o("#startscreenshare").attr("title",smartVideoLocale.msgStore.startShare),o("#stopscreenshare").attr("title",smartVideoLocale.msgStore.stopShare),o(".wd-v-stopshare").attr("title",smartVideoLocale.msgStore.stopShare),o("#cameraSwitch").attr("title",smartVideoLocale.msgStore.cameraSwitch),o("#hangupButton").attr("title",smartVideoLocale.msgStore.hangupButton),o("#enableScreenShare").html(smartVideoLocale.msgStore.enableScreenShare),o("#screensharelink").attr("src","https://chrome.google.com/webstore/detail/"+svConfigs.chromePluginId),o(".swipe_text_video").html(smartVideoLocale.msgStore.videoScreen),o(".swipe_text").html(smartVideoLocale.msgStore.chatScreen),o(".login-wd-title").html(smartVideoLocale.msgStore.nameFieldForm),o("#login-conference-title").html(smartVideoLocale.msgStore.formConferenceTitle),o("#continue-button").html(smartVideoLocale.msgStore.continueButton),o("#ng_caller_name").attr("placeholder",smartVideoLocale.msgStore.namePlaceholder),o("#ng_caller_avatar").attr("placeholder",smartVideoLocale.msgStore.avatarPlaceholder),o("#ng_password").attr("placeholder",smartVideoLocale.msgStore.passwordPlaceholder),o("#answer_audiocall_button span").html(smartVideoLocale.msgStore.audio),o("#answer_call_button span").html(smartVideoLocale.msgStore.video),o("#reject_call_button span").html(smartVideoLocale.msgStore.reject),o(".wd-v-recording recording-on").attr("title",smartVideoLocale.msgStore.stopRecording),o(".wd-v-recording recording-off").attr("title",smartVideoLocale.msgStore.startRecording),o(".recordingIcon").attr("title",smartVideoLocale.msgStore.recording),o("#whiteboard").attr("title",smartVideoLocale.msgStore.whiteboard),o("#changeView").attr("title",smartVideoLocale.msgStore.changeView),o("#raisehand").attr("title",smartVideoLocale.msgStore.raiseHand),o("#raisehand1").attr("title",smartVideoLocale.msgStore.raiseHand),o("#snapshot").attr("title",smartVideoLocale.msgStore.getSnapshot),o(".recordinglink").html(smartVideoLocale.msgStore.previewRecording),o("#snapshotLink").html(smartVideoLocale.msgStore.snapshotDownload),o(".acceptFile").html(smartVideoLocale.msgStore.acceptFile),o(".rejectFile").html(smartVideoLocale.msgStore.rejectFile),o("#cleanCanvas").attr("title",smartVideoLocale.msgStore.wb_clearall),o("#downloadCanvas").attr("title",smartVideoLocale.msgStore.wb_downloadimage);var n=isiPhone?smartVideoLocale.msgStore.notSupportedIos:smartVideoLocale.msgStore.notSupportedError;o("#not_supported").html(n),o("#startVideoButton").html(smartVideoLocale.msgStore.continueToCall),o("#chooseVideoAudio").html(smartVideoLocale.msgStore.chooseOptions),o(".feedback-title").html(smartVideoLocale.msgStore.feedbackFieldForm),o("#feedback-button").html(smartVideoLocale.msgStore.feedbackButton),o(".muteMe").html(smartVideoLocale.msgStore.muteMe),o(".turnOffCamera").html(smartVideoLocale.msgStore.turnOffCamera),o("#startRecording").attr("title",smartVideoLocale.msgStore.startRecording),o("#pipButton").attr("title",smartVideoLocale.msgStore.pipButton),o("#orLoginWith").html(smartVideoLocale.msgStore.orLoginWith),o("#end_meeting").attr("title",smartVideoLocale.msgStore.endMeeting),o("#newdev_chat_message1").attr("placeholder",smartVideoLocale.msgStore.writeSomething),o("#termsCon").html(smartVideoLocale.msgStore.termsCon),o("#termsLink").attr("href",svConfigs.entryForm.terms),o("#blur").attr("title",smartVideoLocale.msgStore.blur),o("#blur").html(smartVideoLocale.msgStore.blur),o("#backgrounds").attr("title",smartVideoLocale.msgStore.backgrounds),o("#backgrounds").html(smartVideoLocale.msgStore.backgrounds),o("#virtualBackgroundLi").attr("title",smartVideoLocale.msgStore.virtualBackgrounds)}),o(document).on("RemoteVideoSessions",function(e){remoteVideoSessions=e.count}),o(document).on("IncomingCall",function(e){if("conference"==conferenceStyle)ui_handler.setWidgetValues(),ui_handler.onIncomingVideo(),e.autoaccept||comm_controller.getVideoSessions()?setTimeout(function(){comm_controller.answerCall(video_on,!0)},1e3):(playIncomingCall(),ui_handler.toggleRinging(function(e){e?comm_controller.answerCall(video_on,!0):comm_controller.rejectCall()}));else{ui_handler.setWidgetValues(),ui_handler.onIncomingVideo();var t=smartVideoLocale.msgStore.incomingText;o("#incoming_text").html(t.replace("{{caller_name}}",peer_name)),autoAcceptVideo||autoAcceptAudio||svConfigs.videoScreen.autoAcceptVideo||svConfigs.videoScreen.autoAcceptAudio||e.autoaccept||comm_controller.getVideoSessions()?queryString.isAdmin&&setTimeout(function(){svConfigs.videoScreen.greenRoom&&!getCookie("lsvGreenRoom")?(v(),o("#startVideoButton").click(function(){window.stream&&window.stream.getTracks().forEach(function(e){e.stop()}),inCall.push(e.sessionId),comm_controller.answerCall(video_on,!1,videoSource,audioSource,svConfigs.videoScreen.videoConstraint,svConfigs.videoScreen.audioConstraint)})):((svConfigs.videoScreen.autoAcceptAudio||autoAcceptAudio)&&(video_on=!1),(svConfigs.videoScreen.autoAcceptVideo||autoAcceptVideo)&&(video_on=!0),ui_handler.setMobileChatOnly(),ui_handler.displayVideoOnly(),inCall.push(e.sessionId),comm_controller.answerCall(video_on,!1,videoSource,audioSource,svConfigs.videoScreen.videoConstraint,svConfigs.videoScreen.audioConstraint))},1e3):(playIncomingCall(),ui_handler.toggleRinging(function(t){t?remoteVideoSessions>0?(o("#wd-widget-content-video-waiting").show(),setTimeout(function(){h(!0)},1e3),inCall.includes(e.sessionId)||(inCall.push(e.sessionId),comm_controller.answerCall(video_on,!0,videoSource,audioSource,svConfigs.videoScreen.videoConstraint,svConfigs.videoScreen.audioConstraint))):svConfigs.videoScreen.greenRoom&&!getCookie("lsvGreenRoom")?(v(),o("#startVideoButton").click(function(){window.stream&&window.stream.getTracks().forEach(function(e){e.stop()}),inCall.push(e.sessionId),comm_controller.answerCall(video_on,!0,videoSource,audioSource,svConfigs.videoScreen.videoConstraint,svConfigs.videoScreen.audioConstraint)})):(inCall.push(e.sessionId),comm_controller.answerCall(video_on,!0,videoSource,audioSource,svConfigs.videoScreen.videoConstraint,svConfigs.videoScreen.audioConstraint)):comm_controller.rejectCall()}))}}),o(".wd-v-hangup").on("click",function(){f()}),o(document).off("LocalVideoStarted"),o(document).on("LocalVideoStarted",function(t){svConfigs.serverSide.videoLogs&&(isLsvAdmin?saveLog("start",agentId,"audio: "+audio_on+", video: "+video_on,comm_controller.getSessionId(),"",names[comm_controller.getSessionId()].name):saveLog("join",agentId,"audio: "+audio_on+", video: "+video_on,comm_controller.getSessionId(),names[comm_controller.getSessionId()].name)),isVirtualBack||isVirtualBlur||o("#localVideo").show(),("conference"==conferenceStyle||queryString.broadcast)&&(ui_handler.toggleVideoBox(!0),x(comm_controller.getSessionId(),video_on));var n=!1,i=svConfigs.transcribe?svConfigs.transcribe.direction:"";if("agent"==i?n=isChrome&&queryString.isAdmin&&svConfigs.transcribe&&1==svConfigs.transcribe.enabled:"visitor"==i?n=isChrome&&!queryString.isAdmin&&svConfigs.transcribe&&1==svConfigs.transcribe.enabled:"both"==i&&(n=isChrome&&svConfigs.transcribe&&1==svConfigs.transcribe.enabled),n&&loadScript("../js/translator.js",function(){translator=new Translator;var o=e.getAttribute("data-langFrom")?e.getAttribute("data-langFrom"):svConfigs.transcribe.language,t=e.getAttribute("data-langTo")?e.getAttribute("data-langTo"):svConfigs.transcribe.languageTo;"both"!=i||queryString.isAdmin||(o=e.getAttribute("data-langTo")?e.getAttribute("data-langTo"):svConfigs.transcribe.languageTo,t=e.getAttribute("data-langFrom")?e.getAttribute("data-langFrom"):svConfigs.transcribe.language),translator.voiceToText(function(e){t&&svConfigs.transcribe.apiKey?translator.translateLanguage(e,{from:o,to:t,callback:function(e){comm_controller.sendTranslateMessage(e,!1)},api_key:svConfigs.transcribe.apiKey}):comm_controller.sendTranslateMessage(e,!1)},o)}),!queryString.broadcast&&svConfigs.videoScreen.separateScreenShare&&comm_controller.addToJoinScreenShare(),svConfigs.virtualBackground&&(svConfigs.virtualBackground.backgrounds||svConfigs.virtualBackground.blur)){const e=document.getElementById("localVideo");setTimeout(function(){var o=e.videoHeight/(e.videoWidth/270);isNaN(o)&&(o=202.5),e.height=o,e.width=270},1e3)}}),o("#end_meeting").on("click",function(){f(),localStorage.removeItem("prd"),localStorage.removeItem("hasPrivileges");var e=function(){svConfigs.videoScreen.exitMeeting?(queryString.isAdmin&&comm_controller.setDeleteAll(),location.href=svConfigs.videoScreen.exitMeeting):queryString.isAdmin?(comm_controller.setDeleteAll(),o("#invideo").hide(),o("#ng_info").show(),o("#continue-button").on("click",function(){var e={name:caller_name=o("#ng_caller_name").val(),email:caller_email,avatar:caller_avatar,room:room};localStorage.setItem("prd",JSON.stringify(e)),comm_controller.setCallerInfo(e,queryString.isAdmin),o("#ng_info").hide(),I()})):location.reload()};queryString.isAdmin?e():1!=svConfigs.serverSide.feedback||queryString.isAdmin||getCookie("lsvRateRoom")||comm_controller.getVideoSessions()?e():(o("#feedback_form").show(),o("#invideo").hide(),o("#feedback-button").click(function(){if(o("#feedback_form").hide(),token)var t=token;else t=names[comm_controller.getSessionId()].name?names[comm_controller.getSessionId()].name:guestName(comm_controller.getSessionId());o.ajax({type:"POST",timeout:5e3,url:lsRepUrl+"server/script.php",data:{type:"feedback",roomId:room,sessionId:comm_controller.getSessionId(),rate:o("#ratestars").rateit("value"),text:o("#feedback_message").val(),userId:t}}).done(function(e){e&&setCookie("lsvRateRoom","1",240)}).complete(function(){setCookie("lsvRateRoom","1",240),e()}).fail(function(){console.log(!1)})}))}),o("#cancel_call_button").on("click",function(){f()}),o("#callButton_1").on("click",function(){video_on=video_iphone_on=!0,ui_handler.setVideoButton(),h(!1)}),o("#callAudioButton_1").on("click",function(){ringBackStart=!0,video_on=!1,ui_handler.setVideoButton(),h(!1)}),o(document).on("NotSupportedBrowser",function(e){comm_controller.rejectCall(),ui_handler.setVideoBoxOff("video")}),o(document).off("RemoteSpanPosition"),o(document).on("RemoteSpanPosition",function(e){var t=names[e.sessionId]?names[e.sessionId].name:peer_name,n=o("<h2 />",{id:"remoteVideoSpan"+e.sessionId,class:"sourcevideospan"});n.css("postion","absolute"),n.css("top",e.position.top+"px"),n.css("left",e.position.left+"px"),n.appendTo(o("#"+videoElementContainer)),n.html(t)}),o(document).off("MakeBigBroadcast"),o(document).on("MakeBigBroadcast",function(e){ui_handler.makeBig()}),o(document).off("VoiceSpeaking"),o(document).on("VoiceSpeaking",function(e){var t=e.id;pipVideo=document.getElementById(t),"grid"!=currentView&&o("#"+t).is(":visible")&&!o("#wd-widget-content-whiteboard").is(":visible")&&(clearTimeout(timerVars[t]),svConfigs.videoScreen&&"conference"===svConfigs.videoScreen.videoContainerStyle&&jQEngager("#"+t)?(ui_handler.makeAllSmall(),comm_controller.getScreenStreamConnections()||(o("#fullScreen").show(),o("#"+t).detach().appendTo("#video_container"),o("#"+t).removeClass("sourcevideo"),o("#"+t).addClass("bigvideo"),o("#"+t).addClass("bigvideoadd"),comm_controller.getVideoSessions()>1?(o("#"+t).css("height","85%"),o("#"+t).css("height","85%")):(o("#"+t).css("height","98%"),o("#"+t).css("height","98%")),ui_handler.changeSpanPositions())):jQEngager("#"+t).css("border","1px solid #484d75"))}),o(document).off("VoiceSilence"),o(document).on("VoiceSilence",function(e){if(svConfigs.videoScreen.videoConference){var t=e.id;o("#"+t).is(":visible")&&(timerVars[t]=setTimeout(function(){svConfigs.videoScreen&&"conference"===svConfigs.videoScreen.videoContainerStyle&&jQEngager("#"+t)||jQEngager("#"+t).css("border","1px solid #fff"),o("#translate_message").hide()},5e3))}}),o("#changeView").click(function(){ui_handler.changeView(!0)});var d,c,g,_,k=function(){_=null,o("#snapshotData").hide(),o(".recordinglink").attr("href",""),o("#canvasData").hide()};svConfigs.videoScreen.getSnapshot&&o("#snapshotLi").click(function(){if("list"==currentView?(ui_handler.makeBig(),d=o(".bigvideoadd")[0]):d=o(".bigvideoadd")[1],c=o("#snapshotCanvas")[0],500,d){g=d.videoHeight/(d.videoWidth/500),isNaN(g)&&(g=375);var e=c.getContext("2d");g?(c.width=500,c.height=g,e.drawImage(d,0,0,500,g),_=c.toDataURL("image/png"),o("#snapshotData").show(),o("#snapshotLink").attr("href",_),o("#snapshotLink").attr("download",peer_name+".png"),o("#snapshotLink").click(function(){k()}),o(".close-but-wd-small").on("click",function(){k()})):k()}});o(document).off("RemoteVideoStarted"),o(document).on("RemoteVideoStarted",function(e){var t=document.querySelector("video#videoPreview");if(t&&(t.src="",t.srcObject=null),"conference"==conferenceStyle)(isChrome||isFirefox)&&queryString.isAdmin&&1==svConfigs.recording.enabled&&0==svConfigs.recording.autoStart&&o(".fa-circle").show(),o("#permission_div").hide(),o("#video_back").hide(),stopIncomingCall(),o("#wd-widget-content-whiteboard").is(":visible")||(ui_handler.toggleVideoBox(!0),(isChrome||isFirefox)&&queryString.isAdmin&&svConfigs.recording.enabled&&svConfigs.recording.autoStart&&l()),x(comm_controller.getSessionId(),video_on),playEnterRoom(),ui_handler.changeView(!1);else{(isChrome||isFirefox)&&queryString.isAdmin&&1==svConfigs.recording.enabled&&0==svConfigs.recording.autoStart&&o(".wd-v-recording").show(),o("#permission_div").hide(),o("#video_back").hide(),stopIncomingCall();try{ui_handler.toggleVideoBox(!0),(isChrome||isFirefox)&&queryString.isAdmin&&svConfigs.recording.enabled&&svConfigs.recording.autoStart&&l()}catch(e){console.log(e)}}k()}),o(document).on("VideoRemoved",function(e){video_on=!1,ui_handler.setVideoButton(),x(comm_controller.getSessionId(),!1),names[comm_controller.getSessionId()].video=!1,names[comm_controller.getSessionId()].room=room,localStorage.setItem("prd",JSON.stringify(names[comm_controller.getSessionId()]))}),o(document).on("AudioRemoved",function(e){ui_handler.disableAudio(),audio_on=!1,ui_handler.setMuteButton(),names[comm_controller.getSessionId()]&&(names[comm_controller.getSessionId()].muted=!0,names[comm_controller.getSessionId()].room=room,localStorage.setItem("prd",JSON.stringify(names[comm_controller.getSessionId()]))),r()}),o(document).on("VideoMuted",function(e){ui_handler.disableVideo(),video_on=!1,ui_handler.setVideoButton(),x(comm_controller.getSessionId(),!1),o("#localVideo").hide(),svConfigs.serverSide.videoLogs&&saveLog("video muted",agentId,"audio: "+audio_on+", video: "+video_on,comm_controller.getSessionId(),names[comm_controller.getSessionId()].name)}),o(document).on("VideoUnmuted",function(e){video_on=!0,ui_handler.setVideoButton(),x(comm_controller.getSessionId(),!0),o("#localVideo").show(),svConfigs.serverSide.videoLogs&&saveLog("video unmuted",agentId,"audio: "+audio_on+", video: "+video_on,comm_controller.getSessionId(),names[comm_controller.getSessionId()].name)}),o(document).on("AudioMuted",function(e){audio_on=!1,ui_handler.setMuteButton(),names[comm_controller.getSessionId()]&&(names[comm_controller.getSessionId()].muted=!0),r(),svConfigs.serverSide.videoLogs&&saveLog("audio muted",agentId,"audio: "+audio_on+", video: "+video_on,comm_controller.getSessionId(),names[comm_controller.getSessionId()].name)}),o(document).on("AudioUnmuted",function(e){audio_on=!0,ui_handler.setMuteButton(),names[comm_controller.getSessionId()]&&(names[comm_controller.getSessionId()].muted=!1),r(),svConfigs.serverSide.videoLogs&&saveLog("audio unmuted",agentId,"audio: "+audio_on+", video: "+video_on,comm_controller.getSessionId(),names[comm_controller.getSessionId()].name)}),o(document).on("RemoteVideoMuted",function(e){o("#"+e.sessionId).hide(),o("#remoteVideoSpan"+e.sessionId).hide(),x(e.sessionId,!1)}),o(document).on("BlockUser",function(e){comm_controller.getSessionId()==e.sessionId&&(f(),localStorage.removeItem("prd"),localStorage.removeItem("hasPrivileges"),comm_controller.setClose(comm_controller.getSessionId()),delete names[e.sessionId],location.reload())}),o(document).on("RevokePriveleges",function(e){names[e.sessionId].priv=!1,comm_controller.getSessionId()==e.sessionId&&(o(".fa-hand-paper-o").closest("a").removeClass("active"),localStorage.removeItem("hasPrivileges"),o("#hangupBroadcastButton").trigger("click"),comm_controller.revokeBroadcast(),o("#screenshareLi").hide(),o("#virtualBackgroundLi").hide(),o("#whiteboardLi").hide(),o("#localVideo").hide(),o("#showHideVideo").hide())}),o(document).on("GrantPriveleges",function(e){names[e.sessionId].priv=!0,comm_controller.getSessionId()==e.sessionId&&(localStorage.setItem("hasPrivileges",!0),o(".fa-hand-paper-o").closest("a").removeClass("active"),comm_controller.joinBroadcast(),!(isChrome||isFirefox||isOpera||isSafariA)||isiPhone||isAndroid||!queryString.room&&!queryString.broadcast||o("#screenshareLi").show(),1==svConfigs.whiteboard.enabled&&svConfigs.whiteboard.allowAnonymous&&o("#whiteboardLi").show(),svConfigs.videoScreen.broadcastAttendeeVideo?o("#showHideVideo").show():o("#showHideVideo").hide())}),o(document).on("RemoteVideoUnmuted",function(e){o("#"+e.sessionId).show(),o("#remoteVideoSpan"+e.sessionId).show(),x(e.sessionId,!0)}),o(document).on("RemoteAudioMuted",function(e){names[e.sessionId]&&(names[e.sessionId].muted=!0),r()}),o(document).on("RemoteAudioUnmuted",function(e){names[e.sessionId]&&(names[e.sessionId].muted=!1),r()}),o(document).on("ForceAudioMuted",function(e){if(e.sessionId==comm_controller.getSessionId()){audio_on=!1;var o=localStorage.getItem("prd");(o=JSON.parse(o)).muted=!audio_on,o.room=room,localStorage.setItem("prd",JSON.stringify(o)),comm_controller.toggleAudio()}}),o(document).on("ForceVideoMuted",function(e){if(e.sessionId==comm_controller.getSessionId()){video_on=!1;var o=localStorage.getItem("prd");(o=JSON.parse(o)).video=video_on,o.room=room,localStorage.setItem("prd",JSON.stringify(o)),comm_controller.toggleVideo()}}),o(document).on("ForceAudioMutedAll",function(e){audio_on=!1;var o=localStorage.getItem("prd");(o=JSON.parse(o)).muted=!audio_on,o.room=room,localStorage.setItem("prd",JSON.stringify(o)),comm_controller.toggleAudio()}),o(document).on("ForceDelete",function(e){e.sessionId==comm_controller.getSessionId()&&(f(),o("#invideo").hide(),localStorage.removeItem("prd"),localStorage.removeItem("hasPrivileges"),location.reload())}),o(document).on("ForceDeleteAll",function(e){f(),is_widget_opened=!1,o("#invideo").hide(),localStorage.removeItem("prd"),localStorage.removeItem("hasPrivileges"),svConfigs.videoScreen.exitMeeting?location.href=svConfigs.videoScreen.exitMeeting:location.reload()}),o(document).on("AskAdmit",function(e){var t=smartVideoLocale.msgStore.askToAdmit.replace("{{user}}",e.name.name);toggleNotification(t,!0),o("#approveAdmit").on("click",function(){comm_controller.approveAdmit(e.sessionId),toggleNotification("",!1)}),o("#rejectAdmit").on("click",function(){comm_controller.rejectAdmit(e.sessionId),toggleNotification("",!1)})}),o(document).on("approveAdmit",function(e){toggleNotification("",!1),setCookie("approveAdmit","1"),svConfigs.videoScreen.greenRoom?(o("#wd-widget-content-greenroom").show(),o("#startVideoButton").off(),o("#startVideoButton").on("click",function(){p(!1)}),v()):(r(),ui_handler.setVideoButton(),h(!0))}),o(document).on("rejectAdmit",function(e){toggleNotification(smartVideoLocale.msgStore.rejectAdmit,!0),o("#end_meeting").trigger("click")}),o("#fullscreenButton").on("click",function(){o("#fullScreen").hide(),o("#exitFullScreen").show(),toggleFullScreen()}),o("#exitFullscreenButton").on("click",function(){o("#fullScreen").show(),o("#exitFullScreen").hide(),toggleFullScreen()}),o("#call_video").off(),o("#call_audio").off(),o("#call_video").on("click",function(){video_on=!0,E(!0)}),o("#call_audio").on("click",function(){isiPhone?(video_on=!0,video_iphone_on=!1):video_on=!1,E(!0)}),o(".wd-v-text").on("click",function(){E(!1)}),o("#slide_video").on("click",function(){E(!1)}),(isAndroid||isiPhone)&&(o("#mainleft_div").on("swipe",function(){E(!1)}),o(".wd-chat-box").on("swipe",function(){E(!1)})),o("#showHideAudio").on("click",function(){audio_on||video_on||comm_controller.initCall("Audio",!1,videoSource,comm_controller.getSessionId(),audioSource,svConfigs.videoScreen.videoConstraint,svConfigs.videoScreen.audioConstraint),audio_on=!audio_on;var e=localStorage.getItem("prd");(e=JSON.parse(e)).muted=!audio_on,e.room=room,localStorage.setItem("prd",JSON.stringify(e)),comm_controller.toggleAudio()}),o("#showHideVideo").on("click",function(){audio_on||video_on||comm_controller.initCall("Video",!1,videoSource,comm_controller.getSessionId(),audioSource,svConfigs.videoScreen.videoConstraint,svConfigs.videoScreen.audioConstraint),video_on=!video_on;var e=localStorage.getItem("prd");(e=JSON.parse(e)).video=video_on,e.room=room,localStorage.setItem("prd",JSON.stringify(e)),comm_controller.toggleVideo()}),o(document).on("RemoteVideoStopped",function(e){ui_handler.changeView(!1)}),o(document).on("MediaDevices",function(e){(videoDevices=e.devices).length>1&&(o("#cameraSwitch").show(),o("#cameraSwitch").off(),o("#cameraSwitch").click(function(){(videoCurrentId+=1)>=videoDevices.length&&(videoCurrentId=0),video_on=!0,localStorage.setItem("videoSource",videoDevices[videoCurrentId].value),localStorage.setItem("videoCurrentId",videoCurrentId),isiPhone||queryString.broadcast?(ui_handler.toggleVideoBox(!1),location.reload()):comm_controller.renegotiate(videoDevices[videoCurrentId].value)}))}),o(document).on("RestartVideo",function(e){f(),video_on=!0,ui_handler.displayVideoOnly(),setTimeout(function(){h(!0)},1e3)}),o(document).on("CallAccepted",function(e){stopIncomingCall()}),o(document).on("CallRejected",function(e){stopIncomingCall()}),o(document).on("CallFailed",function(e){stopIncomingCall(),svConfigs.serverSide.videoLogs&&saveLog("error call failed",agentId,"audio: "+audio_on+", video: "+video_on,comm_controller.getSessionId(),agentName,names[e.sessionId].name)}),o(document).on("LocalVideoStopped",function(e){}),o(document).on("ChatRejected",function(e){}),o(document).off("CallEnded"),o(document).on("CallEnded",function(e){s(e.sessionId)}),o(document).off("TogglePermissionDenied"),o(document).on("TogglePermissionDenied",function(e){s(e.sessionId),ui_handler.togglePermissionWidget(!1)}),o(document).off("NotFoundError"),o(document).on("NotFoundError",function(e){s(e.sessionId),ui_handler.toggleMediaErrorWidget(smartVideoLocale.msgStore.notFoundDevice),svConfigs.serverSide.videoLogs&&saveLog("error "+smartVideoLocale.msgStore.notFoundDevice,agentId,"audio: "+audio_on+", video: "+video_on,e.sessionId,names[e.sessionId].name)}),o(document).off("NotReadableError"),o(document).on("NotReadableError",function(e){s(e.sessionId),ui_handler.toggleMediaErrorWidget(smartVideoLocale.msgStore.notFoundDevice),svConfigs.serverSide.videoLogs&&saveLog("error "+smartVideoLocale.msgStore.notFoundDevice,agentId,"audio: "+audio_on+", video: "+video_on,e.sessionId,names[e.sessionId].name)}),o(document).off("MediaError"),o(document).on("MediaError",function(e){s(e.sessionId),ui_handler.toggleMediaErrorWidget(e.error),svConfigs.serverSide.videoLogs&&saveLog("error "+e.error,agentId,"audio: "+audio_on+", video: "+video_on,e.sessionId,names[e.sessionId].name)}),o(document).on("CheckPopup",function(e){comm_controller.setPing(comm_controller.getSessionId())}),o(document).off("CallerInfo"),o(document).on("CallerInfo",function(e){e.callerInfo&&e.callerInfo.name&&(passRoom||e.callerInfo.password?(queryString.isAdmin&&comm_controller.sendCallerBack(e.callerInfo.password==passRoom,e.sessionId),e.callerInfo.password==passRoom&&i(e)):i(e))}),o(document).off("AdminPopupOffline"),o(document).on("AdminPopupOffline",function(e){"conference"!=conferenceStyle&&(isOnline=!1,T())}),o(document).off("PopupOffline"),o(document).on("PopupOffline",function(e){"conference"!=conferenceStyle&&(isOnline=!1,T())}),o(document).off("PopupLeft"),o(document).on("PopupLeft",function(e){if(names[e.sessionId]&&names[e.sessionId].name){var t=names[e.sessionId].isAdmin;svConfigs.serverSide.videoLogs&&(t?saveLog("end",agentId,"audio: "+audio_on+", video: "+video_on,e.sessionId):saveLog("leave",agentId,"audio: "+audio_on+", video: "+video_on,e.sessionId,names[e.sessionId].name));var n=smartVideoLocale.msgStore.leftChat.replace("{{caller_name}}",names[e.sessionId].name);svConfigs.videoScreen&&svConfigs.videoScreen.waitingRoom?toggleError(n,5e3):(showMessage("",n,null,"leftChat"),svConfigs.serverSide.chatHistory&&saveChat(n,"","leftChat",agentId,"",names));var i=document.getElementById(e.sessionId);i&&(i.parentNode.removeChild(i),o("#remoteVideoSpan"+e.sessionId).remove()),delete names[e.sessionId],r()}}),o(document).off("AdminOffline"),o(document).on("AdminOffline",function(e){svConfigs.serverSide.videoLogs&&saveLog("end",agentId,"audio: "+audio_on+", video: "+video_on,e.sessionId)}),o(".box-title").on("click",function(){ui_handler.toggleVisitors(!0)}),o("#toVideo").on("click",function(){comm_controller.getStream()||"conference"==conferenceStyle?(ui_handler.displayVideoOnly(),comm_controller.toVideo(),ui_handler.changeView(!1)):ui_handler.toggleInstaChat()}),o(document).on("ToVideo",function(e){ui_handler.displayVideoOnly(),ui_handler.changeView(!1)}),o("#cleanCanvas").on("click",function(){comm_controller.clearCanvas()});var V,M=document.getElementById("canvasLink");o("#downloadCanvas").on("click",function(){var e;o("#canvasData").show(),M.innerHTML=M.href=M.style="",canvasLink,e=e||function(){},lsDesigner.toDataURL("image/png",function(e){M.href=e,M.innerHTML=smartVideoLocale.msgStore.wb_downloadimage,M.download="image."+"image/png".split("/")[1]})}),o("#canvasLink").click(function(){o("#canvasData").hide()}),o(document).on("WhiteboardSync",function(e){"list"==currentView?ui_handler.makeAllSmall():ui_handler.makeAllSmallGrid(),ui_handler.toggleInstaWhiteboard()}),o("#mainleft_div").hover(function(){o(".wd-video-c").delay(200).show()},function(){o(".wd-video-c").delay(200).hide()}),o("#whiteboard").off(),o("#whiteboard").on("click",function(){"list"==currentView?ui_handler.makeAllSmall():ui_handler.makeAllSmallGrid(),ui_handler.toggleInstaWhiteboard(),o("#cleanCanvas").show(),o("#downloadCanvas").show(),(queryString.isAdmin||localStorage.getItem("hasPrivileges"))&&comm_controller.startWhiteboard()}),o("#raisehand").off(),o("#raisehand").on("click",function(){S("raiseHand");var e=smartVideoLocale.msgStore.raiseHandText.replace("{{caller_name}}",names[comm_controller.getSessionId()].name);o(".fa-hand-paper-o").closest("a").addClass("active"),svConfigs.videoScreen&&svConfigs.videoScreen.waitingRoom?toggleError(e,5e3):showMessage("",e,null,"raiseHand")}),o("#raisehand1").off(),o("#raisehand1").on("click",function(){S("raiseHand");var e=smartVideoLocale.msgStore.raiseHandText.replace("{{caller_name}}",names[comm_controller.getSessionId()].name);o(".fa-hand-paper-o").closest("a").addClass("active"),svConfigs.videoScreen&&svConfigs.videoScreen.waitingRoom?toggleError(e,5e3):showMessage("",e,null,"raiseHand")}),1==svConfigs.whiteboard.enabled&&(queryString.isAdmin&&!svConfigs.videoScreen.videoFileStream&&(o("#whiteboard_div").show(),o("#whiteboardLi").show()),loadScript("../js/canvas-designer-widget.js",function(){})),1==svConfigs.serverSide.feedback&&loadScript("../js/jquery.rateit.js",function(){}),o(document).off("ChatMessage"),o(document).on("ChatMessage",function(e){var t=names[e.sessionId]?names[e.sessionId].name:peer_name,n=names[e.sessionId]?names[e.sessionId].avatar:peer_avatar;if("raiseHand"==e.msg){var i=smartVideoLocale.msgStore.raiseHandText.replace("{{caller_name}}",names[e.sessionId].name);svConfigs.videoScreen&&svConfigs.videoScreen.waitingRoom?toggleError(i,5e3):showMessage("",i,null,"raiseHand"),names[e.sessionId].raiseHand=!0,r(),setTimeout(function(){names[e.sessionId].raiseHand=!1,r()},15e4)}else if("sendFile"==e.msg){var s=e.sessionId?names[e.sessionId].name:peer_name,a=smartVideoLocale.msgStore.incomingFile;a=a.replace("{{caller_name}}",s),svConfigs.videoScreen&&svConfigs.videoScreen.waitingRoom?toggleError(a,5e3):showMessage("",a,null,"sendFile")}else showMessage(t,e.msg,null,null,n);"conference"==conferenceStyle?o("#formito_chat").hasClass("is-open")?o(".new_chat_badge_container").hide():o(".new_chat_badge_container").show():svConfigs.videoScreen&&!0===svConfigs.videoScreen.chat?o(".wd-v-text").hide():o(".new_chat_badge_container").show()}),o(document).off("TranslateMessage"),o(document).on("TranslateMessage",function(e){var o=names[e.sessionId]?names[e.sessionId].name:peer_name;names[e.sessionId]&&names[e.sessionId].avatar;ui_handler.showTranslateMessage(o+": "+e.msg),svConfigs.transcribe.text_speech_transcribe&&(speech.text=e.msg,window.speechSynthesis.speak(speech))}),o(document).off("SendTyping"),o(document).on("SendTyping",function(e){if(e.typing){o('li[data-system-attribue="chatTyping"]').remove(),o('div[data-system-attribue="chatTyping"]').remove();var t=names[e.sessionId]?names[e.sessionId].name:guestName(e.sessionId);showMessage("",t+" is typing",null,"chatTyping")}else o('li[data-system-attribue="chatTyping"]').remove(),o('div[data-system-attribue="chatTyping"]').remove()});var L=0;(o("#newdev_chat_message1").keyup(function(e){if(clearTimeout(V),++L%3==0&&comm_controller.sendTyping(!0),V=setTimeout(function(){comm_controller.sendTyping(!1)},1200),"conference"==conferenceStyle)var t=o("#newdev_chat_message1").val();else t=o("#newdev_chat_message1").text();13==e.keyCode&&t&&(user_act=!0,S(t,!0),o("#newdev_chat_message1").html(""),o("#newdev_chat_message1").val(""),comm_controller.sendTyping(!1))}),isOnline||queryString.isAdmin?setTimeout(function(){A()},100):T(),o(document).off("IncomingFileTransfer"),o(document).on("IncomingFileTransfer",function(e){if(e.sender){var o=smartVideoLocale.msgStore.sendingFile;showMessage("",o+e.name+'<br/><div class="progress"><progress id="progress'+e.fileId+'" max="0" value="0"></progress></div>',null,"fileTransfer")}else{var t=e.fileId,n=e.name+'<br/><div class="progress"><progress id="progress'+t+'" max="0" value="0"></progress></div><span id="download'+t+'"></span>';showMessage("",n,null,"fileTransfer"),svConfigs.serverSide.chatHistory&&saveChat(smartVideoLocale.msgStore.receivingFile+e.name,"","fileTransfer",agentId,"",names)}}),o("#file_transfer").off(),o("#file_transfer").on("click",function(e){(new FileSelector).selectSingleFile(function(e){S("sendFile"),comm_controller.sendFile(e)})}),o(document).off("SendCallerBack"),o(document).on("SendCallerBack",function(e){if(!queryString.isAdmin&&e.sessionId==comm_controller.getSessionId()&&!is_callerback){if(is_callerback=!0,toggleNotification("",!1),!e.access)return localStorage.removeItem("prd"),localStorage.removeItem("prdTmp"),location.reload(),!1;isOnline=!0,ui_handler.setDisabled(!1),o("#ng_info").hide(),o("#continue-button").off(),localStorage.getItem("prdTmp")&&(localStorage.setItem("prd",localStorage.getItem("prdTmp")),localStorage.removeItem("prdTmp"));var t=localStorage.getItem("prd");names[comm_controller.getSessionId()]={name:t?t.name:caller_name,avatar:t?t.avatar:caller_avatar,email:t?t.email:caller_email},"conference"==conferenceStyle&&I()}}),o("#newdev_chat_button1").click(function(e){C("newdev_chat_message1")}),o(document).off("AdminPopupOnline"),o(document).on("AdminPopupOnline",function(e){isOnline=!0,requirePass=null!=e.pass&&e.pass,A()}),o(document).off("PopupOnline"),o(document).on("PopupOnline",function(e){e.sessionId&&"visitor"!==e.sessionId&&(names[e.sessionId]||(names[e.sessionId]={avatar:e.avatar?e.avatar:lsRepUrl+"img/small-avatar.jpg",name:e.name?e.name:guestName(e.sessionId)},e.callerInfo&&i(e),u()),isOnline=!0,requirePass=null!=e.pass&&e.pass,A(e.sessionId))}),o(".wd-v-recording").on("click",function(){multiStreamRecorder&&"recording"==multiStreamRecorder.getState()?(m(!0),svConfigs.serverSide.videoLogs&&saveLog("stop recording",agentId,"audio: "+audio_on+", video: "+video_on,comm_controller.getSessionId(),names[comm_controller.getSessionId()].name)):l()}),o("#startRecording").on("click",function(){multiStreamRecorder&&"recording"==multiStreamRecorder.getState()?(m(!0),svConfigs.serverSide.videoLogs&&saveLog("stop recording",agentId,"audio: "+audio_on+", video: "+video_on,comm_controller.getSessionId(),names[comm_controller.getSessionId()].name)):l()}),o(document).on("RemoteStartRecording",function(e){o(".recordingIcon").show()}),o(document).on("RemoteStopRecording",function(e){o(".recordingIcon").hide()}),o(document).on("ScreenShareFailed",function(e){toggleError("Screen Share failed"),w(!1),svConfigs.serverSide.videoLogs&&saveLog("error failed screenshare",agentId,"audio: "+audio_on+", video: "+video_on,comm_controller.getSessionId(),agentName,names[comm_controller.getSessionId()].name)}),o(document).off("RemoteScreenShareStarted"),o(document).on("RemoteScreenShareStarted",function(e){!queryString.broadcast&&svConfigs.videoScreen.separateScreenShare&&("list"==currentView?ui_handler.makeAllSmall():ui_handler.makeAllSmallGrid()),ui_handler.displayScreenShare(),o("#remoteScreen").show(),ui_handler.setScreenDisabled(!0)}),o(document).off("ScreenShareEnded"),o(document).on("ScreenShareEnded",function(e){ui_handler.setScreenDisabled(!1),w(!1),o("#remoteScreen").is(":visible")||comm_controller.getStream()||("conference"==conferenceStyle?ui_handler.displayVideoOnly():ui_handler.toggleInstaChat())}),o(document).off("ScreenShareStopped"),o(document).on("ScreenShareStopped",function(e){svConfigs.serverSide.videoLogs&&saveLog("stop screenshare",agentId,"audio: "+audio_on+", video: "+video_on,comm_controller.getSessionId(),names[comm_controller.getSessionId()].name)}),o(document).on("EndMeeting",function(e){R(!1)}),o("#exit_meeting").on("click",function(){o("#hangupBroadcastButton").trigger("click"),f(),comm_controller.endMeeting(),R(!0)}),(isChrome||isFirefox||isOpera||isSafariA)&&!isiPhone&&(queryString.room||queryString.broadcast||localStorage.getItem("hasPrivileges"))&&(o(".wd-v-share").show(),o("#screenshare_div").show(),o(document).on("PluginDetected",function(e){pluginInstalled=!0}),o(document).on("PluginNotDetected",function(e){pluginInstalled=!1}),o(".control-ss > a").click(function(){o(".control-ss").hide()})),svConfigs.videoScreen&&svConfigs.videoScreen.pipEnabled)&&("pictureInPictureEnabled"in document&&(o("#pipLi").show(),document.getElementById("pipButton").addEventListener("click",()=>{document.pictureInPictureElement?document.exitPictureInPicture().catch(e=>{console.log(e)}):pipVideo?pipVideo.requestPictureInPicture().catch(e=>{console.log(e)}):toggleError(smartVideoLocale.msgStore.pipNotVideo,5e3)}),pipVideo&&(pipVideo.addEventListener("enterpictureinpicture",()=>{}),pipVideo.addEventListener("leavepictureinpicture",()=>{}))));var O=function(){b()};if(o(".wd-v-share").on("click",function(){O()}),o("#startscreenshare").off("click",function(){}),o("#startscreenshare").on("click",function(){isOnline?(ui_handler.displayVideoOnly(),O()):T()}),o(".wd-v-stopshare").on("click",function(){y()}),o("#stopscreenshare").on("click",function(){y()}),(queryString.isAdmin||queryString.broadcast)&&1==svConfigs.recording.enabled&&loadScript(lsRepUrl+"js/msr.js",function(){}),svConfigs.serverSide.videoLogs&&loadScript(lsRepUrl+"js/detect.js",function(){}),svConfigs.transcribe.text_speech_chat||svConfigs.transcribe.text_speech_transcribe){(speech=new SpeechSynthesisUtterance).lang="en",speech.rate=1,speech.volume=1,speech.pitch=1;let e=[];window.speechSynthesis.onvoiceschanged=()=>{e=window.speechSynthesis.getVoices(),speech.voice=e[svConfigs.transcribe.text_speech_lang]}}if(svConfigs.videoScreen&&svConfigs.videoScreen.onlyAgentButtons&&!queryString.isAdmin&&ui_handler.setAgentOnlyButtons(),disableVideo&&ui_handler.disableVideo(),disableAudio&&ui_handler.disableAudio(),disableScreenShare&&ui_handler.disableScreenShare(),disableWhiteboard&&ui_handler.disableWhiteboard(),disableTransfer&&ui_handler.disableTransfer(),o(document).on("click",".closebtn",function(){o("body").removeClass("menuopen"),o(".menu-link").removeClass("active")}),o(document).on("click",".fo-icon",function(){o(".formito-launcher").toggleClass("is-open"),o(".new_chat_badge_container").hide()}),o(document).on("click",".fa-users",function(e){o("#attendees").toggle(),e.stopPropagation()}),o(document.body).on("click",function(e){var t=e.target.id;"private_message_small"!==t&&"fausers"!==t&&(o("#attendees").hide(),o("#visitor_message").hide())}),o(document).mouseup(function(e){var t;(t=o("#nd_widget_visitors")).is(e.target)||0!==t.has(e.target).length||ui_handler.toggleVisitors(!1),(t=o("#feedback_form")).is(e.target)||0!==t.has(e.target).length||o("#feedback_form").hide(),o("#virtualBackgrounds").hide(),o("#backgroundImages").hide()}),svConfigs.virtualBackground&&(svConfigs.virtualBackground.backgrounds||svConfigs.virtualBackground.blur)){o.ajax({type:"POST",url:lsRepUrl+"server/script.php",data:{type:"getvirtualimages"}}).done(function(t){t&&(t=JSON.parse(t),o.each(t,function(t,i){o("#backgroundImages").append('<img id="backgroundImage'+t+'" src="../img/virtual/'+i+'" width="180" />'),o("#backgroundImage"+t).on("click",function(){isVirtual&&isVirtualBlur?(isVirtualBack=!1,isVirtual=!1,isVitrualBlur=!1,n.hidden=!0,e.hidden=!0,o("#virtualBackground").removeClass("active"),o("#blur").removeClass("enabled"),o("#backgrounds").removeClass("enabled"),comm_controller.replaceVideoTrack(),setTimeout(function(){isVirtualBack=!0,o("#backgroundImage"+t).trigger("click")},500)):(isVirtualBack=!0,isVirtualBlur=!1,o("#backgrounds").addClass("enabled"),o("#backgroundImage").attr("src","../img/virtual/"+i),P(2),o("#backgroundImages").hide())})}))}).fail(function(){});const e=document.getElementById("backgroundCanvas"),t=e.getContext("2d"),n=document.getElementById("localVideo");o("#backgroundCanvas").css("maxHeight",200),o(".localvideo").css("maxHeight",200),o("#virtualBackground").click(function(){o("#virtualBackgrounds").show()});var P=function(i){async function r(o){for(;isVirtual;){const r=await o.segmentPerson(n,{flipHorizontal:svConfigs.videoScreen.localFeedMirrored,internalResolution:"medium",segmentationThreshold:.7,maxDetections:10,scoreThreshold:.2,nmsRadius:20,minKeypointScore:.3,refineSteps:10}),s=6,a=2;if(bodyPix.drawBokehEffect(e,n,r,s,a,!1),2==i){const e={r:0,g:0,b:0,a:0},o={r:0,g:0,b:0,a:255};let i=bodyPix.toMask(r,e,o);if(i){let e=document.getElementById("backgroundImage");t.putImageData(i,0,0),t.globalCompositeOperation="source-in",t.drawImage(e,0,0,n.width,n.height),t.globalCompositeOperation="destination-over",t.drawImage(n,0,0,n.width,n.height),t.globalCompositeOperation="source-over"}}}}if(e.height=n.videoHeight,e.width=n.videoWidth,n.onplaying=()=>{e.height=n.videoHeight,e.width=n.videoWidth},isVirtual)isVirtual=!1,n.hidden=!1,e.hidden=!0,o("#virtualBackground").removeClass("active"),comm_controller.replaceVideoTrack();else{n.hidden=!0,e.hidden=!1;var s=e.captureStream();comm_controller.replaceVideoTrack(s),isVirtual=!0,o("#virtualBackground").addClass("active"),options={architecture:"MobileNetV1",outputStride:16,multiplier:.75,quantBytes:2},bodyPix.load(options).then(e=>r(e)).catch(e=>console.log(e))}};o("#blur").on("click",function(){isVirtualBlur?(isVirtualBlur=!1,isVirtual=!1,isVirtualBack=!1,n.hidden=!1,e.hidden=!0,o("#virtualBackground").removeClass("active"),o("#blur").removeClass("enabled"),o("#backgrounds").removeClass("enabled")):isVirtual&&isVirtualBack?(isVirtual=!1,isVirtualBlur=!1,n.hidden=!0,e.hidden=!0,o("#virtualBackground").removeClass("active"),o("#blur").removeClass("enabled"),o("#backgrounds").removeClass("enabled"),setTimeout(function(){isVirtualBack=!1,isVirtualBlur=!0,o("#blur").addClass("enabled"),P(1)},1e3)):(isVirtualBlur=!0,isVirtualBack=!1,o("#blur").addClass("enabled"),P(1))}),o("#backgrounds").on("click",function(){isVirtualBack?(isVirtualBack=!1,isVirtual=!1,isVitrualBlur=!1,n.hidden=!1,e.hidden=!0,o("#virtualBackground").removeClass("active"),o("#blur").removeClass("enabled"),o("#backgrounds").removeClass("enabled"),comm_controller.replaceVideoTrack()):(isVirtualBack=!0,isVirtualBlut=!1,o("#backgroundImages").show())})}smartVideoLocale.persistMsgStore(smartVideoLocale.msgStore),r(),loadScript(lsRepUrl+"js/additional.js",function(){})})}(ui_handler=new uiHandler).init(jQuery,n,comm_controller),jQuery(document).on("CommConnected",function(e){function o(){m(!0),deleteCookie("lsvGreenRoom")}window.addEventListener?window.addEventListener("beforeunload",o,!1):window.attachEvent("onbeforeunload",o),loadScript(isAndroid||isiPhone?lsRepUrl+"js/adapter-latest.js":isIEA?lsRepUrl+"js/adapter.screenshare.js":lsRepUrl+"js/adapter-latest.js",V())})})};function loadScript(e,o){var t=document.createElement("script");t.type="text/javascript",t.readyState?t.onreadystatechange=function(){"loaded"!=t.readyState&&"complete"!=t.readyState||(t.onreadystatechange=null,o&&o())}:t.onload=function(){o&&o()},t.src=e+"?v="+currVersion,document.getElementsByTagName("head")[0].appendChild(t)}var init=new main;